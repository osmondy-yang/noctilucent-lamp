**å…¨æ–‡æ€»è®¡6ä¸‡å­—**ã€**110ä¸ªçŸ¥è¯†ç‚¹**ã€**160å¼ åŸç†ã€æµç¨‹å›¾**ã€‚æçº²å¦‚ä¸‹ï¼š

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9789085c-1257-11ec-948d-00163e068ecd.png)

æçº²

**æ­£æ–‡**



![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_97b24136-1257-11ec-948d-00163e068ecd.png)

01ã€Flink åŸºç¡€ç¯‡







> 1ã€ä»€ä¹ˆæ˜¯Flinkï¼Ÿæè¿°ä¸€ä¸‹

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_97c9b82a-1257-11ec-948d-00163e068ecd.png)

Flinkæ˜¯ä¸€ä¸ªä»¥ **æµ** ä¸ºæ ¸å¿ƒçš„é«˜å¯ç”¨ã€é«˜æ€§èƒ½çš„åˆ†å¸ƒå¼è®¡ç®—å¼•æ“ã€‚å…·å¤‡ **æµæ‰¹ä¸€ä½“ï¼Œ**é«˜ååã€ä½å»¶è¿Ÿï¼Œå®¹é”™èƒ½åŠ›ï¼Œå¤§è§„æ¨¡å¤æ‚è®¡ç®—ç­‰ç‰¹ç‚¹ï¼Œåœ¨æ•°æ®æµä¸Šæä¾› **æ•°æ®åˆ†å‘**ã€é€šä¿¡ç­‰åŠŸèƒ½ã€‚

> 2ã€èƒ½å¦è¯¦ç»†è§£é‡Šä¸€ä¸‹å…¶ä¸­çš„ æ•°æ®æµã€æµæ‰¹ä¸€ä½“ã€å®¹é”™èƒ½åŠ›ç­‰æ¦‚å¿µï¼Ÿ

**æ•°æ®æµï¼š**æ‰€æœ‰äº§ç”Ÿçš„ **æ•°æ®** éƒ½å¤©ç„¶å¸¦æœ‰ **æ—¶é—´æ¦‚å¿µ**ï¼ŒæŠŠ äº‹ä»¶ æŒ‰ç…§æ—¶é—´é¡ºåºæ’åˆ—èµ·æ¥ï¼Œå°±å½¢æˆäº†ä¸€ä¸ªäº‹ä»¶æµï¼Œä¹Ÿè¢«ç§°ä½œæ•°æ®æµã€‚

**æµæ‰¹ä¸€ä½“ï¼š**



é¦–å…ˆå¿…é¡»å…ˆæ˜ç™½ä»€ä¹ˆæ˜¯ **æœ‰ç•Œæ•°æ®** å’Œ **æ— ç•Œæ•°æ®**

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_97f4fe36-1257-11ec-948d-00163e068ecd.png)



**æœ‰ç•Œæ•°æ®**ï¼Œå°±æ˜¯åœ¨ä¸€ä¸ªç¡®å®šçš„æ—¶é—´èŒƒå›´å†…çš„æ•°æ®æµï¼Œæœ‰å¼€å§‹ï¼Œæœ‰ç»“æŸï¼Œä¸€æ—¦ç¡®å®šå°±ä¸ä¼šå†æ”¹å˜ï¼Œä¸€èˆ¬ **æ‰¹****å¤„ç†** ç”¨æ¥å¤„ç†æœ‰ç•Œæ•°æ®ï¼Œå¦‚ä¸Šå›¾çš„ bounded streamã€‚

**æ— ç•Œæ•°æ®**ï¼Œå°±æ˜¯æŒç»­äº§ç”Ÿçš„æ•°æ®æµï¼Œæ•°æ®æ˜¯æ— é™çš„ï¼Œæœ‰å¼€å§‹ï¼Œæ— ç»“æŸï¼Œä¸€èˆ¬ **æµå¤„ç†** ç”¨æ¥å¤„ç†æ— ç•Œæ•°æ®ã€‚å¦‚å›¾ unbounded streamã€‚

Flinkçš„è®¾è®¡æ€æƒ³æ˜¯ä»¥ **æµ** ä¸ºæ ¸å¿ƒï¼Œæ‰¹æ˜¯æµçš„ç‰¹ä¾‹ï¼Œæ“…é•¿å¤„ç† æ— ç•Œ å’Œ æœ‰ç•Œ æ•°æ®ï¼Œ Flink æä¾› ç²¾ç¡®çš„æ—¶é—´æ§åˆ¶èƒ½åŠ› å’Œ æœ‰çŠ¶æ€ è®¡ç®—æœºåˆ¶ï¼Œå¯ä»¥è½»æ¾åº”å¯¹æ— ç•Œæ•°æ®æµï¼ŒåŒæ—¶ æä¾› **çª—å£** å¤„ç†æœ‰ç•Œæ•°æ®æµã€‚æ‰€ä»¥è¢«æˆä¸ºæµæ‰¹ä¸€ä½“ã€‚



**å®¹é”™èƒ½åŠ›ï¼š**

**
**

åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç¡¬ä»¶æ•…éšœã€è¿›ç¨‹å¼‚å¸¸ã€åº”ç”¨å¼‚å¸¸ã€ç½‘ç»œæ•…éšœç­‰å¼‚å¸¸æ— å¤„ä¸åœ¨ï¼ŒFlinkå¼•æ“å¿…é¡»ä¿è¯æ•…éšœå‘ç”Ÿå ä¸ä»…å¯ä»¥ **é‡å¯** åº”ç”¨ç¨‹åºï¼Œè¿˜è¦ **ç¡®ä¿** å…¶å†…éƒ¨çŠ¶æ€ä¿æŒä¸€è‡´ï¼Œä»æœ€åä¸€æ¬¡æ­£ç¡®çš„æ—¶é—´ç‚¹é‡æ–°å‡ºå‘



Flinkæä¾› **é›†ç¾¤çº§å®¹é”™** å’Œ **åº”ç”¨çº§å®¹é”™** èƒ½åŠ›

**é›†ç¾¤çº§å®¹é”™ï¼š** Flink ä¸ é›†ç¾¤ç®¡ç†å™¨ç´§å¯†è¿æ¥ï¼Œå¦‚YARNã€Kubernetesï¼Œå½“è¿›ç¨‹æŒ‚æ‰åï¼Œè‡ªåŠ¨é‡å¯æ–°è¿›ç¨‹æ¥ç®¡ä¹‹å‰çš„å·¥ä½œã€‚åŒæ—¶å…·å¤‡ **é«˜å¯ç”¨****æ€§ ï¼Œ**å¯æ¶ˆé™¤æ‰€æœ‰å•ç‚¹æ•…éšœï¼Œ

**åº”ç”¨çº§å®¹é”™ï¼š**Flink ä½¿ç”¨ è½»é‡çº§åˆ†å¸ƒå¼å¿«ç…§ï¼Œè®¾è®¡æ£€æŸ¥ç‚¹ï¼ˆ**checkpoint**ï¼‰å®ç°å¯é å®¹é”™ã€‚

Flink åˆ©ç”¨æ£€æŸ¥ç‚¹ç‰¹æ€§ï¼Œåœ¨æ¡†æ¶å±‚é¢ æä¾› **Exactly-once** è¯­ä¹‰ï¼Œå³ç«¯åˆ°ç«¯çš„ä¸€è‡´æ€§ï¼Œç¡®ä¿æ•°æ®ä»…å¤„ç†ä¸€æ¬¡ï¼Œä¸ä¼šé‡å¤ä¹Ÿä¸ä¼šä¸¢å¤±ï¼Œå³ä½¿å‡ºç°æ•…éšœï¼Œä¹Ÿèƒ½ä¿è¯æ•°æ®åªå†™ä¸€æ¬¡ã€‚

> 3ã€Flink å’Œ Spark Streamingçš„åŒºåˆ«ï¼Ÿ

**Flink** å’Œ **Spark Sreaming** **æœ€å¤§çš„åŒºåˆ«**åœ¨äºï¼šFlink æ˜¯æ ‡å‡†çš„å®æ—¶å¤„ç†å¼•æ“ï¼ŒåŸºäºäº‹ä»¶é©±åŠ¨ï¼Œ**ä»¥æµä¸ºæ ¸å¿ƒ**ï¼Œè€Œ Spark Streaming çš„RDD å®é™…æ˜¯ä¸€ç»„å°æ‰¹æ¬¡çš„RDDé›†åˆï¼Œæ˜¯å¾®æ‰¹ï¼ˆMicro-Batchï¼‰çš„æ¨¡å‹ï¼Œ**ä»¥æ‰¹ä¸ºæ ¸å¿ƒ**ã€‚

ä¸‹é¢æˆ‘ä»¬ä»‹ç»ä¸¤ä¸ªæ¡†æ¶çš„ä¸»è¦åŒºåˆ«ï¼š

**1. æ¶æ„æ¨¡å‹**

Spark Streaming åœ¨è¿è¡Œæ—¶çš„ä¸»è¦è§’è‰²åŒ…æ‹¬ï¼š

æœåŠ¡æ¶æ„é›†ç¾¤å’Œèµ„æºç®¡ç† Master Yarn Application Masterï¼›

å·¥ä½œèŠ‚ç‚¹ Work Node Managerï¼›

ä»»åŠ¡è°ƒåº¦å™¨ Driverï¼›ä»»åŠ¡æ‰§è¡Œå™¨ Executor

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_981a86a6-1257-11ec-948d-00163e068ecd.png)

Flink åœ¨è¿è¡Œæ—¶ä¸»è¦åŒ…å«ï¼šå®¢æˆ·ç«¯ Clientã€ä½œä¸šç®¡ç† Jobmanagerã€ä»»åŠ¡ç®¡ç†Taskmanagerã€‚

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_98463990-1257-11ec-948d-00163e068ecd.png)

**2. ä»»åŠ¡è°ƒåº¦**

Spark Streaming è¿ç»­ä¸æ–­çš„ç”Ÿæˆå¾®å°çš„æ•°æ®æ‰¹æ¬¡ï¼Œæ„å»ºæœ‰å‘æ— ç¯å›¾DAGï¼ŒSpark Streaming ä¼šä¾æ¬¡åˆ›å»º DStreamGraphã€JobSchedulerã€‚

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_987039d4-1257-11ec-948d-00163e068ecd.png)

Flink æ ¹æ®ç”¨æˆ·æäº¤çš„ä»£ç ç”Ÿæˆ **StreamGraph**ï¼Œç»è¿‡ä¼˜åŒ–ç”Ÿæˆ **JobGraph**ï¼Œç„¶åæäº¤ç»™ JobManagerè¿›è¡Œå¤„ç†ï¼ŒJobManager ä¼šæ ¹æ® JobGraph ç”Ÿæˆ **ExecutionGraph**ï¼ŒExecutionGraph æ˜¯ Flink è°ƒåº¦æœ€æ ¸å¿ƒçš„æ•°æ®ç»“æ„ï¼ŒJobManager æ ¹æ® ExecutionGraph å¯¹ Job è¿›è¡Œè°ƒåº¦ï¼Œæ ¹æ®ç‰©ç†æ‰§è¡Œå›¾éƒ¨ç½²åˆ°Taskmanagerä¸Šå½¢æˆå…·ä½“çš„Taskæ‰§è¡Œã€‚ 

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_989ed492-1257-11ec-948d-00163e068ecd.png)

**3. æ—¶é—´æœºåˆ¶**

Spark Streaming æ”¯æŒçš„æ—¶é—´æœºåˆ¶æœ‰é™ï¼Œåªæ”¯æŒå¤„ç†æ—¶é—´ã€‚

Flink æ”¯æŒäº†æµå¤„ç†ç¨‹åºåœ¨æ—¶é—´ä¸Šçš„ä¸‰ä¸ªå®šä¹‰ï¼š**äº‹ä»¶æ—¶é—´ EventTime**ã€**æ‘„å…¥æ—¶é—´ IngestionTime** ã€**å¤„ç†æ—¶é—´ ProcessingTime**ã€‚åŒæ—¶ä¹Ÿæ”¯æŒ watermark æœºåˆ¶æ¥å¤„ç†æ»åæ•°æ®ã€‚

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_98bcac92-1257-11ec-948d-00163e068ecd.png)

**4. å®¹é”™æœºåˆ¶**

**å¯¹äº Spark Streaming ä»»åŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½® checkpoint**ï¼Œç„¶åå‡å¦‚å‘ç”Ÿæ•…éšœå¹¶é‡å¯ï¼Œæˆ‘ä»¬å¯ä»¥ä»ä¸Šæ¬¡ checkpoint ä¹‹å¤„æ¢å¤ï¼Œä½†æ˜¯è¿™ä¸ªè¡Œä¸ºåªèƒ½ä½¿å¾—æ•°æ®ä¸ä¸¢å¤±ï¼Œå¯èƒ½ä¼šé‡å¤å¤„ç†ï¼Œä¸èƒ½åšåˆ°æ°å¥½ä¸€æ¬¡å¤„ç†è¯­ä¹‰ã€‚

â“â“ä¸€ç¬”å¸¦è¿‡â“â“ Flink åˆ™ä½¿ç”¨ä¸¤é˜¶æ®µæäº¤åè®®æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

> 4ã€Flinkçš„æ¶æ„åŒ…å«å“ªäº›ï¼Ÿ

Flink æ¶æ„åˆ†ä¸º **æŠ€æœ¯æ¶æ„** å’Œ **è¿è¡Œæ¶æ„** ä¸¤éƒ¨åˆ†ã€‚

> 5ã€ç®€å•ä»‹ç»ä¸€ä¸‹æŠ€æœ¯æ¶æ„

å¦‚ä¸‹å›¾ä¸ºFlinkæŠ€æœ¯æ¶æ„ï¼š

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_98e5396e-1257-11ec-948d-00163e068ecd.png)



Flink ä½œä¸ºæµæ‰¹ä¸€ä½“çš„åˆ†å¸ƒå¼è®¡ç®—å¼•æ“ï¼Œå¿…é¡»æä¾›é¢å‘å¼€å‘äººå‘˜çš„**APIå±‚**ï¼ŒåŒæ—¶è¿˜éœ€è¦è·Ÿå¤–éƒ¨æ•°æ®å­˜å‚¨è¿›è¡Œäº¤äº’ï¼Œéœ€è¦**è¿æ¥å™¨**ï¼Œä½œä¸šå¼€å‘ã€æµ‹è¯•å®Œæ¯•åï¼Œéœ€è¦æäº¤é›†ç¾¤æ‰§è¡Œï¼Œéœ€è¦**éƒ¨ç½²å±‚**ï¼ŒåŒæ—¶è¿˜éœ€è¦è¿ç»´äººå‘˜èƒ½å¤Ÿç®¡ç†å’Œç›‘æ§ï¼Œè¿˜æä¾›å›¾è®¡ç®—ã€æœºå™¨å­¦ä¹ ã€SQLç­‰ï¼Œéœ€è¦**åº”ç”¨æ¡†æ¶å±‚**ã€‚

> 6ã€è¯¦ç»†ä»‹ç»ä¸€ä¸‹Flinkçš„è¿è¡Œæ¶æ„ ğŸš©

å¦‚ä¸‹å›¾ä¸ºFlinkè¿è¡Œæ¶æ„ï¼š

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_98463990-1257-11ec-948d-00163e068ecd.png)

Flink é›†ç¾¤é‡‡å– Master - Slave æ¶æ„ï¼ŒMasterçš„è§’è‰²ä¸º **JobManager**ï¼Œè´Ÿè´£é›†ç¾¤å’Œä½œä¸šç®¡ç†ï¼ŒSlaveçš„è§’è‰²æ˜¯ **TaskManager**ï¼Œè´Ÿè´£æ‰§è¡Œè®¡ç®—ä»»åŠ¡ï¼ŒåŒæ—¶ï¼ŒFlink æä¾›å®¢æˆ·ç«¯ Client æ¥ç®¡ç†é›†ç¾¤å’Œæäº¤ä»»åŠ¡ï¼Œ**JobManager** å’Œ **TaskManager** æ˜¯é›†ç¾¤çš„è¿›ç¨‹ã€‚

**ï¼ˆ1ï¼‰Client**

Flink å®¢æˆ·ç«¯æ˜¯F1ink æä¾›çš„ CLI å‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨æ¥æäº¤ Flink ä½œä¸šåˆ° Flink é›†ç¾¤ï¼Œåœ¨å®¢æˆ·ç«¯ä¸­è´Ÿè´£ StreamGraph (æµå›¾)å’Œ Job Graph (ä½œä¸šå›¾)çš„æ„å»ºã€‚

**ï¼ˆ2ï¼‰JobManager**

JobManager æ ¹æ®å¹¶è¡Œåº¦å°† Flink å®¢æˆ·ç«¯æäº¤çš„Flink åº”ç”¨åˆ†è§£ä¸ºå­ä»»åŠ¡ï¼Œä»èµ„æºç®¡ç†å™¨ ResourceManager ç”³è¯·æ‰€éœ€çš„è®¡ç®—èµ„æºï¼Œèµ„æºå…·å¤‡ä¹‹åï¼Œå¼€å§‹åˆ†å‘ä»»åŠ¡åˆ° TaskManager æ‰§è¡Œ Taskï¼Œå¹¶è´Ÿè´£åº”ç”¨å®¹é”™ï¼Œè·Ÿè¸ªä½œä¸šçš„æ‰§è¡ŒçŠ¶æ€ï¼Œå‘ç°å¼‚å¸¸åˆ™æ¢å¤ä½œä¸šç­‰ã€‚

**ï¼ˆ3ï¼‰TaskManager**

TaskManager æ¥æ”¶ JobManage åˆ†å‘çš„å­ä»»åŠ¡ï¼Œæ ¹æ®è‡ªèº«çš„èµ„æºæƒ…å†µ ç®¡ç†å­ä»»åŠ¡çš„å¯åŠ¨ã€ åœæ­¢ã€é”€æ¯ã€å¼‚å¸¸æ¢å¤ç­‰ç”Ÿå‘½å‘¨æœŸé˜¶æ®µã€‚Flinkç¨‹åºä¸­å¿…é¡»æœ‰ä¸€ä¸ªTaskManagerã€‚

> 7ã€Flinkçš„å¹¶è¡Œåº¦ä»‹ç»ä¸€ä¸‹ï¼Ÿ

Flinkç¨‹åºåœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œä¼šè¢«æ˜ å°„æˆä¸€ä¸ª**Streaming Dataflowã€‚**ä¸€ä¸ªStreaming Dataflowæ˜¯ç”±ä¸€ç»„Streamå’ŒTransformation Operatorç»„æˆçš„ã€‚åœ¨å¯åŠ¨æ—¶ä»ä¸€ä¸ªæˆ–å¤šä¸ªSource Operatorå¼€å§‹ï¼Œç»“æŸäºä¸€ä¸ªæˆ–å¤šä¸ªSink Operatorã€‚ 

**Flinkç¨‹åºæœ¬è´¨ä¸Šæ˜¯å¹¶è¡Œçš„å’Œåˆ†å¸ƒå¼çš„**ï¼Œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œ**ä¸€ä¸ªæµ(stream)åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªæµåˆ†åŒº**ï¼Œè€Œæ¯ä¸€ä¸ªoperatoråŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªoperatorå­ä»»åŠ¡ã€‚æ“ä½œå­ä»»åŠ¡é—´å½¼æ­¤ç‹¬ç«‹ï¼Œåœ¨ä¸åŒçš„çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œç”šè‡³æ˜¯åœ¨ä¸åŒçš„æœºå™¨æˆ–ä¸åŒçš„å®¹å™¨ä¸Šã€‚

**operatorå­ä»»åŠ¡çš„æ•°é‡æ˜¯è¿™ä¸€ç‰¹å®šoperatorçš„å¹¶è¡Œåº¦**ã€‚ç›¸åŒç¨‹åºä¸­çš„ä¸åŒoperatoræœ‰ä¸åŒçº§åˆ«çš„å¹¶è¡Œåº¦ã€‚

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_993568d0-1257-11ec-948d-00163e068ecd.png)

ä¸€ä¸ªStreamå¯ä»¥è¢«åˆ†æˆå¤šä¸ªStreamçš„åˆ†åŒºï¼Œä¹Ÿå°±æ˜¯Stream Partitionã€‚**ä¸€ä¸ªOperatorä¹Ÿå¯ä»¥è¢«åˆ†ä¸ºå¤šä¸ªOperator Subtask**ã€‚å¦‚ä¸Šå›¾ä¸­ï¼ŒSourceè¢«åˆ†æˆSource1å’ŒSource2ï¼Œå®ƒä»¬åˆ†åˆ«ä¸ºSourceçš„Operator Subtaskã€‚æ¯ä¸€ä¸ªOperator Subtaskéƒ½æ˜¯åœ¨ä¸åŒçš„çº¿ç¨‹å½“ä¸­ç‹¬ç«‹æ‰§è¡Œçš„ã€‚**ä¸€ä¸ªOperatorçš„å¹¶è¡Œåº¦ï¼Œå°±ç­‰äºOperator Subtaskçš„ä¸ªæ•°**ã€‚

ä¸Šå›¾Sourceçš„å¹¶è¡Œåº¦ä¸º2ã€‚è€Œä¸€ä¸ªStreamçš„å¹¶è¡Œåº¦å°±ç­‰äºå®ƒç”Ÿæˆçš„Operatorçš„å¹¶è¡Œåº¦ã€‚æ•°æ®åœ¨ä¸¤ä¸ªoperatorä¹‹é—´ä¼ é€’çš„æ—¶å€™æœ‰ä¸¤ç§æ¨¡å¼ï¼š

ï¼ˆ1ï¼‰**One to Oneæ¨¡å¼ï¼š**ä¸¤ä¸ªoperatorç”¨æ­¤æ¨¡å¼ä¼ é€’çš„æ—¶å€™ï¼Œä¼šä¿æŒæ•°æ®çš„åˆ†åŒºæ•°å’Œæ•°æ®çš„ æ’åºï¼›å¦‚ä¸Šå›¾ä¸­çš„Source1åˆ°Map1ï¼Œå®ƒå°±ä¿ç•™çš„Sourceçš„åˆ†åŒºç‰¹æ€§ï¼Œä»¥åŠåˆ†åŒºå…ƒç´ å¤„ ç†çš„æœ‰åºæ€§ã€‚

ï¼ˆ2ï¼‰**Redistributing ï¼ˆé‡æ–°åˆ†é…ï¼‰æ¨¡å¼**ï¼šè¿™ç§æ¨¡å¼ä¼šæ”¹å˜æ•°æ®çš„åˆ†åŒºæ•°ï¼›æ¯ä¸ªoperator subtaskä¼šæ ¹æ®é€‰æ‹©transformationæŠŠæ•°æ®å‘é€åˆ°ä¸åŒçš„ç›®æ ‡subtasksï¼Œæ¯”å¦‚keyBy()ä¼šé€šè¿‡hashcodeé‡æ–°åˆ†åŒºï¼Œbroadcast()å’Œrebalance()æ–¹æ³•ä¼šéšæœºé‡æ–°åˆ†åŒºï¼›

> 8ã€Flinkçš„å¹¶è¡Œåº¦çš„æ€ä¹ˆè®¾ç½®çš„ï¼Ÿ

æˆ‘ä»¬åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­å¯ä»¥ä»å››ä¸ªä¸åŒå±‚é¢è®¾ç½®å¹¶è¡Œåº¦ï¼š

- æ“ä½œç®—å­å±‚é¢(Operator Level)
- æ‰§è¡Œç¯å¢ƒå±‚é¢(Execution Environment Level)
- å®¢æˆ·ç«¯å±‚é¢(Client Level)
- ç³»ç»Ÿå±‚é¢(System Level)

éœ€è¦æ³¨æ„çš„ä¼˜å…ˆçº§ï¼šç®—å­å±‚é¢>ç¯å¢ƒå±‚é¢>å®¢æˆ·ç«¯å±‚é¢>ç³»ç»Ÿå±‚é¢ã€‚

> 9ã€Flinkç¼–ç¨‹æ¨¡å‹äº†è§£ä¸ï¼Ÿ

Flink åº”ç”¨ç¨‹åºä¸»è¦ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œ**æº** Sourceã€**è½¬æ¢** transformationã€**ç›®çš„åœ°** sinkã€‚è¿™äº›æµå¼ dataflows å½¢æˆäº†æœ‰å‘å›¾ï¼Œä»¥ä¸€ä¸ªæˆ–å¤šä¸ªæºï¼ˆsourceï¼‰å¼€å§‹ï¼Œå¹¶ä»¥ä¸€ä¸ªæˆ–å¤šä¸ªç›®çš„åœ°ï¼ˆsinkï¼‰ç»“æŸã€‚

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9958fc5a-1257-11ec-948d-00163e068ecd.png)

> 10ã€Flinkä½œä¸šä¸­çš„DataStreamï¼ŒTransformationä»‹ç»ä¸€ä¸‹

Flinkä½œä¸šä¸­ï¼ŒåŒ…å«ä¸¤ä¸ªåŸºæœ¬çš„å—ï¼š**æ•°æ®æµï¼ˆDataStreamï¼‰**å’Œ **è½¬æ¢ï¼ˆTransformationï¼‰**ã€‚

DataStreamæ˜¯é€»è¾‘æ¦‚å¿µï¼Œä¸ºå¼€å‘è€…æä¾›APIæ¥å£ï¼Œ**Transformation**æ˜¯å¤„ç†è¡Œä¸ºçš„æŠ½è±¡ï¼ŒåŒ…å«äº†æ•°æ®çš„è¯»å–ã€è®¡ç®—ã€å†™å‡ºã€‚æ‰€ä»¥Flink ä½œä¸šä¸­çš„DataStream API è°ƒç”¨ï¼Œå®é™…ä¸Šæ„å»ºäº†å¤šä¸ªç”± Transformationç»„æˆçš„æ•°æ®å¤„ç†æµæ°´çº¿ï¼ˆPipelineï¼‰

DataStream API å’Œ Transformation çš„è½¬æ¢å¦‚ä¸‹å›¾ï¼š

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_997bf278-1257-11ec-948d-00163e068ecd.png)



> 11ã€Flinkçš„åˆ†åŒºç­–ç•¥äº†è§£å—ï¼Ÿ

ç›®å‰ Flink æ”¯æŒ**8ç§åˆ†åŒºç­–ç•¥**çš„å®ç°ï¼Œæ•°æ®åˆ†åŒºä½“ç³»å¦‚ä¸‹å›¾ï¼š

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_999c401e-1257-11ec-948d-00163e068ecd.png)



**ï¼ˆ1ï¼‰GlobalPartitioner**

æ•°æ®ä¼šè¢«åˆ†å‘åˆ°ä¸‹æ¸¸ç®—å­çš„ç¬¬ä¸€ä¸ªå®ä¾‹ä¸­è¿›è¡Œå¤„ç†ã€‚

**ï¼ˆ2ï¼‰ForwardPartitioner**

åœ¨APIå±‚é¢ä¸Š**ForwardPartitioner**åº”ç”¨åœ¨DataStreamä¸Šï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„ DataStreamã€‚

è¯¥Partitioner æ¯”è¾ƒç‰¹æ®Šï¼Œç”¨äºåœ¨åŒä¸€ä¸ª OperatorChain ä¸­ä¸Šä¸‹æ¸¸ç®—å­ä¹‹é—´çš„æ•°æ®è½¬å‘ï¼Œå®é™…ä¸Šæ•°æ®æ˜¯ç›´æ¥ä¼ é€’ç»™ä¸‹æ¸¸çš„ï¼Œè¦æ±‚ä¸Šä¸‹æ¸¸å¹¶è¡Œåº¦ä¸€æ ·ã€‚

**ï¼ˆ3ï¼‰ShufflePartitioner**

éšæœºçš„å°†å…ƒç´ è¿›è¡Œåˆ†åŒºï¼Œå¯ä»¥ç¡®ä¿ä¸‹æ¸¸çš„Taskèƒ½å¤Ÿå‡åŒ€åœ°è·å¾—æ•°æ®ï¼Œä½¿ç”¨ä»£ç å¦‚ä¸‹ï¼š



```
dataStream.shuffle();
```

**ï¼ˆ4ï¼‰RebalancePartitioner**

ä»¥**Round-robin** çš„æ–¹å¼ä¸ºæ¯ä¸ªå…ƒç´ åˆ†é…åˆ†åŒºï¼Œç¡®ä¿ä¸‹æ¸¸çš„ Task å¯ä»¥å‡åŒ€åœ°è·å¾—æ•°æ®ï¼Œé¿å…æ•°æ®å€¾æ–œã€‚ä½¿ç”¨ä»£ç å¦‚ä¸‹ï¼š



```
dataStream.rebalance();
```

**ï¼ˆ5ï¼‰RescalePartitioner**

æ ¹æ®ä¸Šä¸‹æ¸¸ Task çš„æ•°é‡è¿›è¡Œåˆ†åŒºï¼Œ ä½¿ç”¨ **Round-robin** é€‰æ‹©ä¸‹æ¸¸çš„ä¸€ä¸ªTask è¿›è¡Œæ•°æ®åˆ†åŒºï¼Œå¦‚ä¸Šæ¸¸æœ‰2ä¸ª Source.ï¼Œä¸‹æ¸¸æœ‰6ä¸ª Mapï¼Œé‚£ä¹ˆæ¯ä¸ª Source ä¼šåˆ†é…3ä¸ªå›ºå®šçš„ä¸‹æ¸¸ Mapï¼Œä¸ä¼šå‘æœªåˆ†é…ç»™è‡ªå·±çš„åˆ†åŒºå†™äººæ•°æ®ã€‚è¿™ä¸€ç‚¹ä¸ ShufflePartitioner å’Œ RebalancePartitioner ä¸åŒï¼Œ åä¸¤è€…ä¼šå†™å…¥ä¸‹æ¸¸æ‰€æœ‰çš„åˆ†åŒºã€‚



![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_99c4045a-1257-11ec-948d-00163e068ecd.png)

è¿è¡Œä»£ç å¦‚ä¸‹ï¼š



```
dataStream.rescale();
```

**ï¼ˆ6ï¼‰BroadcastPartitioner**

å°†è¯¥è®°å½•å¹¿æ’­ç»™æ‰€æœ‰åˆ†åŒºï¼Œå³æœ‰Nä¸ªåˆ†åŒºï¼Œå°±æŠŠæ•°æ®å¤åˆ¶Nä»½ï¼Œæ¯ä¸ªåˆ†åŒº1ä»½ï¼Œå…¶ä½¿ç”¨ä»£ç å¦‚ä¸‹ï¼š



```
dataStream.broadcast();
```

**ï¼ˆ7ï¼‰KeyGroupStreamPartitioner**

åœ¨APIå±‚é¢ä¸Šï¼Œ**KeyGroupStreamPartitioner**åº”ç”¨åœ¨ **KeyedStream**ä¸Šï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„ KeyedStreamã€‚

KeyedStreamæ ¹æ®keyGroupç´¢å¼•ç¼–å·è¿›è¡Œåˆ†åŒºï¼Œä¼šå°†æ•°æ®æŒ‰ Key çš„ Hash å€¼è¾“å‡ºåˆ°ä¸‹æ¸¸ç®—å­å®ä¾‹ä¸­ã€‚è¯¥åˆ†åŒºå™¨ä¸æ˜¯æä¾›ç»™ç”¨æˆ·æ¥ç”¨çš„ã€‚

KeyedStreamåœ¨æ„é€ **Transformation**çš„æ—¶å€™é»˜è®¤ä½¿ç”¨KeyedGroupåˆ†åŒºå½¢å¼ï¼Œä»è€Œåœ¨åº•å±‚ä¸Šæ”¯æŒä½œä¸šRescaleåŠŸèƒ½ã€‚

**ï¼ˆ8ï¼‰CustomPartitionerWrapper**

ç”¨æˆ·è‡ªå®šä¹‰åˆ†åŒºå™¨ã€‚éœ€è¦ç”¨æˆ·è‡ªå·±å®ç°Partitioneræ¥å£ï¼Œæ¥å®šä¹‰è‡ªå·±çš„åˆ†åŒºé€»è¾‘ã€‚

æ›´è¯¦ç»†çš„ä»‹ç»ï¼Œè¯·å‚è€ƒä¹‹å‰å†™çš„ Flinkåˆ†åŒºç­–ç•¥ï¼šä½ å¯ä»¥ä¸ä¼šï¼Œä½†ä¸èƒ½ä¸æ‡‚

> 12ã€æè¿°ä¸€ä¸‹Flink wordcountæ‰§è¡ŒåŒ…å«çš„æ­¥éª¤æœ‰å“ªäº›ï¼Ÿ

ä¸»è¦åŒ…å«ä»¥ä¸‹å‡ æ­¥ï¼š

ï¼ˆ1ï¼‰è·å–è¿è¡Œç¯å¢ƒ **StreamExecutionEnvironment**

ï¼ˆ2ï¼‰**æ¥å…¥****sourceæº** 

ï¼ˆ3ï¼‰æ‰§è¡Œè½¬æ¢æ“ä½œï¼Œå¦‚map()ã€flatmap()ã€keybyï¼ˆï¼‰ã€sum()

ï¼ˆ4ï¼‰**è¾“å‡ºsinkæº** å¦‚print()

ï¼ˆ5ï¼‰ **æ‰§è¡Œ execute**

æä¾›ä¸€ä¸ªç¤ºä¾‹ï¼š

```

```



```
import org.apache.flink.api.common.functions.FlatMapFunction;
import org.apache.flink.api.java.utils.ParameterTool;
import org.apache.flink.streaming.api.datastream.DataStream;
import org.apache.flink.streaming.api.datastream.DataStreamSource;
import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;
import org.apache.flink.streaming.api.windowing.time.Time;
import org.apache.flink.util.Collector;




public class WordCount {


public static void main(String[] args) throws Exception {
//å®šä¹‰socketçš„ç«¯å£å·
int port;
try{
            ParameterTool parameterTool = ParameterTool.fromArgs(args);
            port = parameterTool.getInt("port");
        }catch (Exception e){
            System.err.println("æ²¡æœ‰æŒ‡å®športå‚æ•°ï¼Œä½¿ç”¨é»˜è®¤å€¼9000");
            port = 9000;
        }
//è·å–è¿è¡Œç¯å¢ƒ
        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
//è¿æ¥socketè·å–è¾“å…¥çš„æ•°æ®
        DataStreamSource<String> text = env.socketTextStream("10.192.12.106", port, "\n");
//è®¡ç®—æ•°æ®
        DataStream<WordWithCount> windowCount = text.flatMap(new FlatMapFunction<String, WordWithCount>() {
public void flatMap(String value, Collector<WordWithCount> out) throws Exception {
                String[] splits = value.split("\\s");
for (String word:splits) {
                    out.collect(new WordWithCount(word,1L));
                }
            }
        })//æ‰“å¹³æ“ä½œï¼ŒæŠŠæ¯è¡Œçš„å•è¯è½¬ä¸º<word,count>ç±»å‹çš„æ•°æ®
                .keyBy("word")//é’ˆå¯¹ç›¸åŒçš„wordæ•°æ®è¿›è¡Œåˆ†ç»„
                .timeWindow(Time.seconds(2),Time.seconds(1))//æŒ‡å®šè®¡ç®—æ•°æ®çš„çª—å£å¤§å°å’Œæ»‘åŠ¨çª—å£å¤§å°
                .sum("count");               
//æŠŠæ•°æ®æ‰“å°åˆ°æ§åˆ¶å°
        windowCount.print()
                .setParallelism(1);//ä½¿ç”¨ä¸€ä¸ªå¹¶è¡Œåº¦
//æ³¨æ„ï¼šå› ä¸ºflinkæ˜¯æ‡’åŠ è½½çš„ï¼Œæ‰€ä»¥å¿…é¡»è°ƒç”¨executeæ–¹æ³•ï¼Œä¸Šé¢çš„ä»£ç æ‰ä¼šæ‰§è¡Œ
        env.execute("streaming word count");
    }
/**
     * ä¸»è¦ä¸ºäº†å­˜å‚¨å•è¯ä»¥åŠå•è¯å‡ºç°çš„æ¬¡æ•°
     */
public static class WordWithCount{
public String word;
public long count;
public WordWithCount(){}
public WordWithCount(String word, long count) {
this.word = word;
this.count = count;
        }
@Override
public String toString() {
return "WordWithCount{" +
"word='" + word + '\'' +
", count=" + count +
'}';
        }
    }
}
```

> 13ã€Flinkå¸¸ç”¨çš„ç®—å­æœ‰å“ªäº›ï¼Ÿ

åˆ†ä¸¤éƒ¨åˆ†ï¼š

ï¼ˆ1ï¼‰**æ•°æ®è¯»å–**ï¼Œè¿™æ˜¯Flinkæµè®¡ç®—åº”ç”¨çš„èµ·ç‚¹ï¼Œå¸¸ç”¨ç®—å­æœ‰ï¼š

ä»å†…å­˜è¯»ï¼šfromElementsã€ä»æ–‡ä»¶è¯»ï¼šreadTextFileã€Socket æ¥å…¥ ï¼šsocketTextStreamã€è‡ªå®šä¹‰è¯»å–ï¼šcreateInput

ï¼ˆ2ï¼‰å¤„ç†æ•°æ®çš„ç®—å­ï¼Œä¸»è¦ç”¨äº **è½¬æ¢** è¿‡ç¨‹

å¸¸ç”¨çš„ç®—å­åŒ…æ‹¬ï¼šMapï¼ˆå•è¾“å…¥å•è¾“å‡ºï¼‰ã€FlatMapï¼ˆå•è¾“å…¥ã€å¤šè¾“å‡ºï¼‰ã€Filterï¼ˆè¿‡æ»¤ï¼‰ã€KeyByï¼ˆåˆ†ç»„ï¼‰ã€Reduceï¼ˆèšåˆï¼‰ã€Windowï¼ˆçª—å£ï¼‰ã€Connectï¼ˆè¿æ¥ï¼‰ã€Splitï¼ˆåˆ†å‰²ï¼‰ç­‰ã€‚



![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_97b24136-1257-11ec-948d-00163e068ecd.png)

02ã€Flink æ ¸å¿ƒç¯‡







![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_99f8ba10-1257-11ec-948d-00163e068ecd.png)

æ ¸å¿ƒç¯‡ä¸»è¦æ¶‰åŠä»¥ä¸ŠçŸ¥è¯†ç‚¹ï¼Œä¸‹é¢è®©æˆ‘ä»¬è¯¦ç»†äº†è§£ä¸€ä¸‹ã€‚

> 14ã€Flinkçš„å››å¤§åŸºçŸ³åŒ…å«å“ªäº›ï¼Ÿ

**Flinkå››å¤§åŸºçŸ³åˆ†åˆ«æ˜¯ï¼šCheckpointï¼ˆæ£€æŸ¥ç‚¹ï¼‰ã€Stateï¼ˆçŠ¶æ€ï¼‰ã€Timeï¼ˆæ—¶é—´ï¼‰ã€Windowï¼ˆçª—å£ï¼‰**ã€‚

> 15ã€è¯´è¯´Flinkçª—å£ï¼Œä»¥åŠåˆ’åˆ†æœºåˆ¶

**çª—å£æ¦‚å¿µï¼š**å°†æ— ç•Œæµçš„æ•°æ®ï¼ŒæŒ‰æ—¶é—´åŒºé—´ï¼Œåˆ’åˆ†æˆå¤šä»½æ•°æ®ï¼Œåˆ†åˆ«è¿›è¡Œç»Ÿè®¡**(èšåˆ)**



Flinkæ”¯æŒä¸¤ç§åˆ’åˆ†çª—å£çš„æ–¹å¼(timeå’Œcount)ï¼Œç¬¬ä¸€ç§ï¼Œ**æŒ‰æ—¶é—´é©±åŠ¨è¿›è¡Œåˆ’åˆ†**ã€å¦ä¸€ç§æŒ‰**æ•°æ®é©±åŠ¨è¿›è¡Œåˆ’åˆ†**ã€‚

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9a434b7a-1257-11ec-948d-00163e068ecd.png)

1ã€æŒ‰æ—¶é—´é©±åŠ¨Time Window åˆ’åˆ†å¯ä»¥åˆ†ä¸º æ»šåŠ¨çª—å£ Tumbling Window å’Œæ»‘åŠ¨çª—å£ Sliding Windowã€‚

2ã€æŒ‰æ•°æ®é©±åŠ¨Count Windowä¹Ÿå¯ä»¥åˆ’åˆ†ä¸ºæ»šåŠ¨çª—å£ Tumbling Window å’Œæ»‘åŠ¨çª—å£ Sliding Windowã€‚

3ã€Flinkæ”¯æŒçª—å£çš„ä¸¤ä¸ªé‡è¦å±æ€§(**çª—å£é•¿åº¦sizeå’Œæ»‘åŠ¨é—´éš”interval**)ï¼Œé€šè¿‡çª—å£é•¿åº¦å’Œæ»‘åŠ¨é—´éš”æ¥åŒºåˆ†æ»šåŠ¨çª—å£å’Œæ»‘åŠ¨çª—å£ã€‚

å¦‚æœsize=interval,é‚£ä¹ˆå°±ä¼šå½¢æˆtumbling-window(æ— é‡å æ•°æ®)--æ»šåŠ¨çª—å£

å¦‚æœsize(1min)>intervalï¼ˆ30sï¼‰,é‚£ä¹ˆå°±ä¼šå½¢æˆsliding-window(æœ‰é‡å æ•°æ®)--æ»‘åŠ¨çª—å£

é€šè¿‡ç»„åˆå¯ä»¥å¾—å‡ºå››ç§åŸºæœ¬çª—å£ï¼š

ï¼ˆ1ï¼‰**time-tumbling-window** æ— é‡å æ•°æ®çš„æ—¶é—´çª—å£ï¼Œè®¾ç½®æ–¹å¼ä¸¾ä¾‹ï¼štimeWindow(Time.seconds(5))---åŸºäºæ—¶é—´çš„æ»šåŠ¨çª—å£

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9a614bd4-1257-11ec-948d-00163e068ecd.png)

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9a88baa2-1257-11ec-948d-00163e068ecd.png)

ï¼ˆ2ï¼‰**time-sliding-window** æœ‰é‡å æ•°æ®çš„æ—¶é—´çª—å£ï¼Œè®¾ç½®æ–¹å¼ä¸¾ä¾‹ï¼štimeWindow(Time.seconds(10), Time.seconds(5))---åŸºäºæ—¶é—´çš„æ»‘åŠ¨çª—å£

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9ab2e840-1257-11ec-948d-00163e068ecd.png)

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9ad0f894-1257-11ec-948d-00163e068ecd.png)

ï¼ˆ3ï¼‰**count-tumbling-window**æ— é‡å æ•°æ®çš„æ•°é‡çª—å£ï¼Œè®¾ç½®æ–¹å¼ä¸¾ä¾‹ï¼šcountWindow(5)---åŸºäºæ•°é‡çš„æ»šåŠ¨çª—å£

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9af1508a-1257-11ec-948d-00163e068ecd.png)

ï¼ˆ4ï¼‰**count-sliding-window** æœ‰é‡å æ•°æ®çš„æ•°é‡çª—å£ï¼Œè®¾ç½®æ–¹å¼ä¸¾ä¾‹ï¼šcountWindow(10,5)---åŸºäºæ•°é‡çš„æ»‘åŠ¨çª—å£

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9b0f1cbe-1257-11ec-948d-00163e068ecd.png)

**Flinkä¸­è¿˜æ”¯æŒä¸€ä¸ªç‰¹æ®Šçš„çª—å£:ä¼šè¯çª—å£SessionWindows**

sessionçª—å£åˆ†é…å™¨é€šè¿‡sessionæ´»åŠ¨æ¥å¯¹å…ƒç´ è¿›è¡Œåˆ†ç»„ï¼Œsessionçª—å£è·Ÿæ»šåŠ¨çª—å£å’Œæ»‘åŠ¨çª—å£ç›¸æ¯”ï¼Œä¸ä¼šæœ‰é‡å å’Œå›ºå®šçš„å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´çš„æƒ…å†µ

sessionçª—å£åœ¨ä¸€ä¸ªå›ºå®šçš„æ—¶é—´å‘¨æœŸå†…ä¸å†æ”¶åˆ°å…ƒç´ ï¼Œå³éæ´»åŠ¨é—´éš”äº§ç”Ÿï¼Œé‚£ä¸ªè¿™ä¸ªçª—å£å°±ä¼šå…³é—­ã€‚

ä¸€ä¸ªsessionçª—å£é€šè¿‡ä¸€ä¸ªsessioné—´éš”æ¥é…ç½®ï¼Œè¿™ä¸ªsessioné—´éš”å®šä¹‰äº†éæ´»è·ƒå‘¨æœŸçš„é•¿åº¦ï¼Œå½“è¿™ä¸ªéæ´»è·ƒå‘¨æœŸäº§ç”Ÿï¼Œé‚£ä¹ˆå½“å‰çš„sessionå°†å…³é—­å¹¶ä¸”åç»­çš„å…ƒç´ å°†è¢«åˆ†é…åˆ°æ–°çš„sessionçª—å£ä¸­å»,å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9b3c3ba4-1257-11ec-948d-00163e068ecd.png)

> 16ã€çœ‹ä½ åŸºæœ¬æ¦‚å¿µè®²çš„è¿˜æ˜¯å¾ˆæ¸…æ¥šçš„ï¼Œé‚£ä½ ä»‹ç»ä¸‹Flinkçš„çª—å£æœºåˆ¶ä»¥åŠå„ç»„ä»¶ä¹‹é—´æ˜¯å¦‚ä½•ç›¸äº’å·¥ä½œçš„

ä»¥ä¸‹ä¸ºçª—å£æœºåˆ¶çš„æµç¨‹å›¾ï¼š

**![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9b5ab98a-1257-11ec-948d-00163e068ecd.png)**

**WindowAssigner**

1ã€çª—å£ç®—å­è´Ÿè´£å¤„ç†çª—å£ï¼Œæ•°æ®æµæºæºä¸æ–­åœ°è¿›å…¥ç®—å­ï¼ˆwindow operatorï¼‰æ—¶ï¼Œæ¯ä¸€ä¸ªåˆ°è¾¾çš„å…ƒç´ é¦–å…ˆä¼šè¢«äº¤ç»™ WindowAssignerã€‚**WindowAssigner ä¼šå†³å®šå…ƒç´ è¢«æ”¾åˆ°å“ªä¸ªæˆ–å“ªäº›çª—å£ï¼ˆwindowï¼‰**ï¼Œå¯èƒ½ä¼šåˆ›å»ºæ–°çª—å£ã€‚å› ä¸ºä¸€ä¸ªå…ƒç´ å¯ä»¥è¢«æ”¾å…¥å¤šä¸ªçª—å£ä¸­ï¼ˆä¸ªäººç†è§£æ˜¯æ»‘åŠ¨çª—å£ï¼Œæ»šåŠ¨çª—å£ä¸ä¼šæœ‰æ­¤ç°è±¡ï¼‰ï¼Œæ‰€ä»¥åŒæ—¶å­˜åœ¨å¤šä¸ªçª—å£æ˜¯å¯èƒ½çš„ã€‚æ³¨æ„ï¼Œ`Window`
**æœ¬èº«åªæ˜¯ä¸€ä¸ªIDæ ‡è¯†ç¬¦**ï¼Œå…¶å†…éƒ¨å¯èƒ½å­˜å‚¨äº†ä¸€äº›å…ƒæ•°æ®ï¼Œå¦‚`TimeWindow`
ä¸­æœ‰å¼€å§‹å’Œç»“æŸæ—¶é—´ï¼Œä½†æ˜¯å¹¶ä¸ä¼šå­˜å‚¨çª—å£ä¸­çš„å…ƒç´ ã€‚çª—å£ä¸­çš„å…ƒç´ å®é™…å­˜å‚¨åœ¨ Key/Value State ä¸­ï¼Œkeyä¸º`Window`
ï¼Œvalueä¸ºå…ƒç´ é›†åˆï¼ˆæˆ–èšåˆå€¼ï¼‰ã€‚ä¸ºäº†ä¿è¯çª—å£çš„å®¹é”™æ€§ï¼Œè¯¥å®ç°ä¾èµ–äº† Flink çš„ State æœºåˆ¶ã€‚

**WindowTrigger**

2ã€æ¯ä¸€ä¸ªWindowéƒ½æ‹¥æœ‰ä¸€ä¸ªå±äºè‡ªå·±çš„ Triggerï¼ŒTriggerä¸Šä¼šæœ‰å®šæ—¶å™¨ï¼Œ**ç”¨æ¥å†³å®šä¸€ä¸ªçª—å£ä½•æ—¶èƒ½å¤Ÿè¢«è®¡ç®—æˆ–æ¸…é™¤**ã€‚æ¯å½“æœ‰å…ƒç´ åŠ å…¥åˆ°è¯¥çª—å£ï¼Œæˆ–è€…ä¹‹å‰æ³¨å†Œçš„å®šæ—¶å™¨è¶…æ—¶äº†ï¼Œé‚£ä¹ˆTriggeréƒ½ä¼šè¢«è°ƒç”¨ã€‚Triggerçš„è¿”å›ç»“æœå¯ä»¥æ˜¯ ï¼š

ï¼ˆ1ï¼‰continueï¼ˆç»§ç»­ã€ä¸åšä»»ä½•æ“ä½œï¼‰ï¼Œ

ï¼ˆ2ï¼‰Fireï¼ˆè§¦å‘è®¡ç®—ï¼Œå¤„ç†çª—å£æ•°æ®ï¼‰ï¼Œ

ï¼ˆ3ï¼‰Purgeï¼ˆè§¦å‘æ¸…ç†ï¼Œç§»é™¤çª—å£å’Œçª—å£ä¸­çš„æ•°æ®ï¼‰ï¼Œ

ï¼ˆ4ï¼‰Fire + purgeï¼ˆè§¦å‘è®¡ç®—+æ¸…ç†ï¼Œå¤„ç†æ•°æ®å¹¶ç§»é™¤çª—å£å’Œçª—å£ä¸­çš„æ•°æ®ï¼‰ã€‚

å½“æ•°æ®åˆ°æ¥æ—¶ï¼Œè°ƒç”¨**Trigger**åˆ¤æ–­æ˜¯å¦éœ€è¦è§¦å‘è®¡ç®—ï¼Œå¦‚æœè°ƒç”¨ç»“æœåªæ˜¯Fireçš„è¯ï¼Œé‚£ä¹ˆä¼šè®¡ç®—çª—å£å¹¶ä¿ç•™çª—å£åŸæ ·ï¼Œä¹Ÿå°±æ˜¯è¯´çª—å£ä¸­çš„æ•°æ®ä¸æ¸…ç†ï¼Œç­‰å¾…ä¸‹æ¬¡Trigger fireçš„æ—¶å€™å†æ¬¡æ‰§è¡Œè®¡ç®—ã€‚çª—å£ä¸­çš„æ•°æ®ä¼šè¢«åå¤è®¡ç®—ï¼Œç›´åˆ°è§¦å‘ç»“æœæ¸…ç†ã€‚åœ¨æ¸…ç†ä¹‹å‰ï¼Œçª—å£å’Œæ•°æ®ä¸ä¼šé‡Šæ”¾æ²¡æ‰€ä»¥çª—å£ä¼šä¸€ç›´å ç”¨å†…å­˜ã€‚

**Trigger è§¦å‘æµç¨‹ï¼š**

3ã€å½“Trigger Fireäº†ï¼Œçª—å£ä¸­çš„å…ƒç´ é›†åˆå°±ä¼šäº¤ç»™`Evictor`
ï¼ˆå¦‚æœæŒ‡å®šäº†çš„è¯ï¼‰ã€‚**Evictor ä¸»è¦ç”¨æ¥éå†çª—å£ä¸­çš„å…ƒç´ åˆ—è¡¨ï¼Œå¹¶å†³å®šæœ€å…ˆè¿›å…¥çª—å£çš„å¤šå°‘ä¸ªå…ƒç´ éœ€è¦è¢«ç§»é™¤**ã€‚å‰©ä½™çš„å…ƒç´ ä¼šäº¤ç»™ç”¨æˆ·æŒ‡å®šçš„å‡½æ•°è¿›è¡Œçª—å£çš„è®¡ç®—ã€‚å¦‚æœæ²¡æœ‰ Evictor çš„è¯ï¼Œçª—å£ä¸­çš„æ‰€æœ‰å…ƒç´ ä¼šä¸€èµ·äº¤ç»™å‡½æ•°è¿›è¡Œè®¡ç®—ã€‚

4ã€è®¡ç®—å‡½æ•°æ”¶åˆ°äº†çª—å£çš„å…ƒç´ ï¼ˆå¯èƒ½ç»è¿‡äº† Evictor çš„è¿‡æ»¤ï¼‰ï¼Œå¹¶è®¡ç®—å‡ºçª—å£çš„ç»“æœå€¼ï¼Œå¹¶å‘é€ç»™ä¸‹æ¸¸ã€‚çª—å£çš„ç»“æœå€¼å¯ä»¥æ˜¯ä¸€ä¸ªä¹Ÿå¯ä»¥æ˜¯å¤šä¸ªã€‚DataStream API ä¸Šå¯ä»¥æ¥æ”¶ä¸åŒç±»å‹çš„è®¡ç®—å‡½æ•°ï¼ŒåŒ…æ‹¬é¢„å®šä¹‰çš„`sum()`
,`min()`
,`max()`
ï¼Œè¿˜æœ‰ `ReduceFunction`
ï¼Œ`FoldFunction`
ï¼Œè¿˜æœ‰`WindowFunction`
ã€‚WindowFunction æ˜¯æœ€é€šç”¨çš„è®¡ç®—å‡½æ•°ï¼Œå…¶ä»–çš„é¢„å®šä¹‰çš„å‡½æ•°åŸºæœ¬éƒ½æ˜¯åŸºäºè¯¥å‡½æ•°å®ç°çš„ã€‚

5ã€Flink å¯¹äºä¸€äº›èšåˆç±»çš„çª—å£è®¡ç®—ï¼ˆå¦‚sum,minï¼‰åšäº†ä¼˜åŒ–ï¼Œå› ä¸ºèšåˆç±»çš„è®¡ç®—ä¸éœ€è¦å°†çª—å£ä¸­çš„æ‰€æœ‰æ•°æ®éƒ½ä¿å­˜ä¸‹æ¥ï¼Œåªéœ€è¦ä¿å­˜ä¸€ä¸ªresultå€¼å°±å¯ä»¥äº†ã€‚æ¯ä¸ªè¿›å…¥çª—å£çš„å…ƒç´ éƒ½ä¼šæ‰§è¡Œä¸€æ¬¡èšåˆå‡½æ•°å¹¶ä¿®æ”¹resultå€¼ã€‚è¿™æ ·å¯ä»¥å¤§å¤§é™ä½å†…å­˜çš„æ¶ˆè€—å¹¶æå‡æ€§èƒ½ã€‚ä½†æ˜¯å¦‚æœç”¨æˆ·å®šä¹‰äº† Evictorï¼Œåˆ™ä¸ä¼šå¯ç”¨å¯¹èšåˆçª—å£çš„ä¼˜åŒ–ï¼Œå› ä¸º Evictor éœ€è¦éå†çª—å£ä¸­çš„æ‰€æœ‰å…ƒç´ ï¼Œå¿…é¡»è¦å°†çª—å£ä¸­æ‰€æœ‰å…ƒç´ éƒ½å­˜ä¸‹æ¥ã€‚

> 17ã€è®²ä¸€ä¸‹Flinkçš„Timeæ¦‚å¿µ

åœ¨Flinkçš„æµå¼å¤„ç†ä¸­ï¼Œä¼šæ¶‰åŠåˆ°æ—¶é—´çš„ä¸åŒæ¦‚å¿µï¼Œä¸»è¦åˆ†ä¸ºä¸‰ç§æ—¶é—´æœºåˆ¶ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9b7a2504-1257-11ec-948d-00163e068ecd.png)

**- EventTime[äº‹ä»¶æ—¶é—´]**

 äº‹ä»¶å‘ç”Ÿçš„æ—¶é—´ï¼Œä¾‹å¦‚ï¼šç‚¹å‡»ç½‘ç«™ä¸Šçš„æŸä¸ªé“¾æ¥çš„æ—¶é—´ï¼Œæ¯ä¸€æ¡æ—¥å¿—éƒ½ä¼šè®°å½•è‡ªå·±çš„ç”Ÿæˆæ—¶é—´ã€‚

å¦‚æœä»¥EventTimeä¸ºåŸºå‡†æ¥å®šä¹‰æ—¶é—´çª—å£é‚£å°†å½¢æˆEventTimeWindow,è¦æ±‚æ¶ˆæ¯æœ¬èº«å°±åº”è¯¥æºå¸¦EventTime

**- IngestionTime[æ‘„å…¥æ—¶é—´]**

 æ•°æ®è¿›å…¥Flinkçš„æ—¶é—´ï¼Œå¦‚æŸä¸ªFlinkèŠ‚ç‚¹çš„**sourceoperator**æ¥æ”¶åˆ°æ•°æ®çš„æ—¶é—´ï¼Œä¾‹å¦‚ï¼šæŸä¸ªsourceæ¶ˆè´¹åˆ°kafkaä¸­çš„æ•°æ®

å¦‚æœä»¥**IngesingtTime**ä¸ºåŸºå‡†æ¥å®šä¹‰æ—¶é—´çª—å£é‚£å°†å½¢æˆIngestingTimeWindow,ä»¥sourceçš„systemTimeä¸ºå‡†

**- ProcessingTime[å¤„ç†æ—¶é—´]**

 æŸä¸ªFlinkèŠ‚ç‚¹æ‰§è¡ŒæŸä¸ªoperationçš„æ—¶é—´ï¼Œä¾‹å¦‚ï¼štimeWindowå¤„ç†æ•°æ®æ—¶çš„ç³»ç»Ÿæ—¶é—´ï¼Œé»˜è®¤çš„æ—¶é—´å±æ€§å°±æ˜¯Processing Time

å¦‚æœä»¥**ProcessingTime**åŸºå‡†æ¥å®šä¹‰æ—¶é—´çª—å£é‚£å°†å½¢æˆProcessingTimeWindowï¼Œä»¥operatorçš„systemTimeä¸ºå‡†



åœ¨Flinkçš„æµå¼å¤„ç†ä¸­ï¼Œç»å¤§éƒ¨åˆ†çš„ä¸šåŠ¡éƒ½ä¼šä½¿ç”¨EventTimeï¼Œä¸€èˆ¬åªåœ¨EventTimeæ— æ³•ä½¿ç”¨æ—¶ï¼Œæ‰ä¼šè¢«è¿«ä½¿ç”¨ProcessingTimeæˆ–è€…IngestionTimeã€‚

å¦‚æœè¦ä½¿ç”¨EventTimeï¼Œé‚£ä¹ˆéœ€è¦å¼•å…¥EventTimeçš„æ—¶é—´å±æ€§ï¼Œå¼•å…¥æ–¹å¼å¦‚ä¸‹æ‰€ç¤ºï¼š

> 18ã€é‚£åœ¨APIè°ƒç”¨æ—¶ï¼Œåº”è¯¥æ€ä¹ˆä½¿ç”¨ï¼Ÿ

ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š



```
final StreamExecutionEnvironment env  
    = StreamExecutionEnvironment.getExecutionEnvironrnent();
// ä½¿ç”¨å¤„ç†æ—¶é—´
env.setStreamTimeCharacteristic(TimeCharacteristic.ProcessingTime) ; 
// ä½¿ç”¨æ‘„å…¥æ—¶é—´


env.setStrearnTimeCharacteristic(TimeCharacteristic.IngestionTime);


// ä½¿ç”¨äº‹ä»¶æ—¶é—´
env.setStrearnTimeCharacteristic(TimeCharacteri stic Eve~tTime);
```

> 19ã€åœ¨æµæ•°æ®å¤„ç†ä¸­ï¼Œæœ‰æ²¡æœ‰é‡åˆ°è¿‡æ•°æ®å»¶è¿Ÿç­‰é—®é¢˜ï¼Œé€šè¿‡ä»€ä¹ˆå¤„ç†å‘¢ï¼Ÿ

æœ‰é‡åˆ°è¿‡æ•°æ®å»¶è¿Ÿé—®é¢˜ã€‚ä¸¾ä¸ªä¾‹å­ï¼š

**æ¡ˆä¾‹1ï¼š** å‡ä½ æ­£åœ¨å»å¾€åœ°ä¸‹åœè½¦åœºçš„è·¯ä¸Šï¼Œå¹¶ä¸”æ‰“ç®—ç”¨æ‰‹æœºç‚¹ä¸€ä»½å¤–å–ã€‚

é€‰å¥½äº†å¤–å–åï¼Œä½ å°±ç”¨åœ¨çº¿æ”¯ä»˜åŠŸèƒ½ä»˜æ¬¾äº†ï¼Œè¿™ä¸ªæ—¶å€™æ˜¯11ç‚¹50åˆ†ã€‚æ°å¥½è¿™æ—¶ï¼Œä½ èµ°è¿›äº†åœ°ä¸‹åœè½¦åº“ï¼Œè€Œè¿™é‡Œå¹¶æ²¡æœ‰æ‰‹æœºä¿¡å·ã€‚å› æ­¤å¤–å–çš„åœ¨çº¿æ”¯ä»˜å¹¶æ²¡æœ‰ç«‹åˆ»æˆåŠŸï¼Œè€Œæ”¯ä»˜ç³»ç»Ÿä¸€ç›´åœ¨Retryé‡è¯•â€œæ”¯ä»˜â€è¿™ä¸ªæ“ä½œã€‚

å½“ä½ æ‰¾åˆ°è‡ªå·±çš„è½¦å¹¶ä¸”å¼€å‡ºåœ°ä¸‹åœè½¦åœºçš„æ—¶å€™ï¼Œå·²ç»æ˜¯12ç‚¹05åˆ†äº†ã€‚è¿™ä¸ªæ—¶å€™æ‰‹æœºé‡æ–°æœ‰äº†ä¿¡å·ï¼Œæ‰‹æœºä¸Šçš„æ”¯ä»˜æ•°æ®æˆåŠŸå‘åˆ°äº†å¤–å–åœ¨çº¿æ”¯ä»˜ç³»ç»Ÿï¼Œæ”¯ä»˜å®Œæˆã€‚

åœ¨ä¸Šé¢è¿™ä¸ªåœºæ™¯ä¸­ä½ å¯ä»¥çœ‹åˆ°ï¼Œ**æ”¯ä»˜æ•°æ®çš„äº‹ä»¶æ—¶é—´æ˜¯11ç‚¹50åˆ†**ï¼Œè€Œ**æ”¯ä»˜æ•°æ®çš„å¤„ç†æ—¶é—´æ˜¯12ç‚¹05åˆ†**

**æ¡ˆä¾‹2ï¼š** å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒæŸApp ä¼šè®°å½•ç”¨æˆ·çš„æ‰€æœ‰ç‚¹å‡»è¡Œä¸ºï¼Œå¹¶å›ä¼ æ—¥å¿—ï¼ˆåœ¨ç½‘ç»œä¸å¥½çš„æƒ…å†µä¸‹ï¼Œå…ˆä¿å­˜åœ¨æœ¬åœ°ï¼Œå»¶åå›ä¼ ï¼‰ã€‚

A ç”¨æˆ·åœ¨11:02 å¯¹ App è¿›è¡Œæ“ä½œï¼ŒBç”¨æˆ·åœ¨11:03 æ“ä½œäº† Appï¼Œ

ä½†æ˜¯A ç”¨æˆ·çš„ç½‘ç»œä¸å¤ªç¨³å®šï¼Œå›ä¼ æ—¥å¿—å»¶è¿Ÿäº†ï¼Œå¯¼è‡´æˆ‘ä»¬åœ¨æœåŠ¡ç«¯å…ˆæ¥å—åˆ°B ç”¨æˆ·11:03 çš„æ¶ˆæ¯ï¼Œç„¶åå†æ¥å—åˆ°A ç”¨æˆ·11:02 çš„æ¶ˆæ¯ï¼Œ**æ¶ˆæ¯ä¹±åº**äº†ã€‚


**ä¸€èˆ¬å¤„ç†æ•°æ®å»¶è¿Ÿã€æ¶ˆæ¯ä¹±åºç­‰é—®é¢˜ï¼Œé€šè¿‡WaterMarkæ°´å°æ¥å¤„ç†ã€‚**

**æ°´å°æ˜¯ç”¨æ¥è§£å†³æ•°æ®å»¶è¿Ÿã€æ•°æ®ä¹±åºç­‰é—®é¢˜ï¼Œæ€»ç»“å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š**

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9b9fd718-1257-11ec-948d-00163e068ecd.png)

æ°´å°å°±æ˜¯ä¸€ä¸ªæ—¶é—´æˆ³ï¼ˆtimestampï¼‰ï¼ŒFlinkå¯ä»¥ç»™æ•°æ®æµæ·»åŠ æ°´å°

â€‹    \- æ°´å°å¹¶ä¸ä¼šå½±å“åŸæœ‰Eventtimeäº‹ä»¶æ—¶é—´

â€‹    \- å½“æ•°æ®æµæ·»åŠ æ°´å°åï¼Œä¼šæŒ‰ç…§æ°´å°æ—¶é—´æ¥è§¦å‘çª—å£è®¡ç®—,ä¹Ÿå°±æ˜¯è¯´watermarkæ°´å°æ˜¯ç”¨æ¥è§¦å‘çª—å£è®¡ç®—çš„

â€‹    \- è®¾ç½®æ°´å°æ—¶é—´ï¼Œä¼šæ¯”äº‹ä»¶æ—¶é—´å°å‡ ç§’é’Ÿ,è¡¨ç¤ºæœ€å¤§å…è®¸æ•°æ®å»¶è¿Ÿè¾¾åˆ°å¤šä¹…

â€‹    \- æ°´å°æ—¶é—´ = äº‹ä»¶æ—¶é—´ - å…è®¸å»¶è¿Ÿæ—¶é—´ (ä¾‹å¦‚ï¼š10:09:57 = 10:10:00 - 3s )

> 20ã€WaterMarkåŸç†è®²è§£ä¸€ä¸‹ï¼Ÿ

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9bbd0a5e-1257-11ec-948d-00163e068ecd.png)

çª—å£æ˜¯10åˆ†é’Ÿè§¦å‘ä¸€æ¬¡ï¼Œç°åœ¨åœ¨12:00 - 12:10 æœ‰ä¸€ä¸ªçª—å£ï¼Œæœ¬æ¥æœ‰ä¸€æ¡æ•°æ®æ˜¯åœ¨12:00 - 12:10è¿™ä¸ªçª—å£è¢«è®¡ç®—ï¼Œä½†å› ä¸ºå»¶è¿Ÿï¼Œ12:12åˆ°è¾¾ï¼Œè¿™æ—¶12:00 - 12:10 è¿™ä¸ªçª—å£å°±ä¼šè¢«å…³é—­ï¼Œåªèƒ½å°†æ•°æ®ä¸‹å‘åˆ°ä¸‹ä¸€ä¸ªçª—å£è¿›è¡Œè®¡ç®—ï¼Œè¿™æ ·å°±äº§ç”Ÿäº†æ•°æ®å»¶è¿Ÿï¼Œé€ æˆè®¡ç®—ä¸å‡†ç¡®ã€‚



ç°åœ¨æ·»åŠ ä¸€ä¸ªæ°´ä½çº¿ï¼šæ•°æ®æ—¶é—´æˆ³ä¸º2åˆ†é’Ÿã€‚è¿™æ—¶ç”¨æ•°æ®äº§ç”Ÿçš„äº‹ä»¶æ—¶é—´ 12:12 -å…è®¸å»¶è¿Ÿçš„æ°´å° 2åˆ†é’Ÿ = 12:10 >= çª—å£ç»“æŸæ—¶é—´ ã€‚çª—å£è§¦å‘è®¡ç®—ï¼Œè¯¥æ•°æ®å°±ä¼šè¢«è®¡ç®—åˆ°è¿™ä¸ªçª—å£é‡Œã€‚

åœ¨DataStream  API ä¸­ä½¿ç”¨ TimestampAssigner æ¥å£å®šä¹‰æ—¶é—´æˆ³çš„æå–è¡Œä¸ºï¼ŒåŒ…å«ä¸¤ä¸ªå­æ¥å£ **AssignerWithPeriodicWatermarks** æ¥å£å’Œ **AssignerWithPunctuatedWaterMarks**æ¥å£

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9bdf8d5e-1257-11ec-948d-00163e068ecd.png)



![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9c01248c-1257-11ec-948d-00163e068ecd.png)



å¦‚æœè§‰å¾—é˜¿å‘¨è®²è§£çš„çŸ¥è¯†ç‚¹è¿˜æ»¡æ„çš„è¯ï¼Œè¯·å…³æ³¨å…¬ä¼—å·ï¼š**3åˆ†é’Ÿç§’æ‡‚å¤§æ•°æ®**ï¼Œè·å–æ›´å¤šï¼Œæ›´å…¨é¢çš„æŠ€æœ¯åšæ–‡ã€‚å¹¶åŠ åšä¸»å¾®ä¿¡ï¼š**threeknowbigdataï¼Œ**æ‹‰ä½ è¿›å¤§æ•°æ®äº¤æµç¾¤ã€‚

> 21ã€å¦‚æœæ•°æ®å»¶è¿Ÿéå¸¸ä¸¥é‡å‘¢ï¼Ÿåªä½¿ç”¨WaterMarkå¯ä»¥å¤„ç†å—ï¼Ÿé‚£åº”è¯¥æ€ä¹ˆè§£å†³ï¼Ÿ

ä½¿ç”¨ WaterMark+ EventTimeWindow æœºåˆ¶å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šè§£å†³æ•°æ®ä¹±åºçš„é—®é¢˜ï¼Œä½†æ˜¯ï¼ŒWaterMark æ°´ä½çº¿ä¹Ÿä¸æ˜¯ä¸‡èƒ½çš„ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ•°æ®å»¶è¿Ÿä¼šéå¸¸ä¸¥é‡ï¼Œå³ä½¿é€šè¿‡Watermark + EventTimeWindowä¹Ÿæ— æ³•ç­‰åˆ°æ•°æ®å…¨éƒ¨è¿›å…¥çª—å£å†è¿›è¡Œå¤„ç†ï¼Œå› ä¸ºçª—å£è§¦å‘è®¡ç®—åï¼Œ**å¯¹äºå»¶è¿Ÿåˆ°è¾¾çš„æœ¬å±äºè¯¥çª—å£çš„æ•°æ®ï¼ŒFlinké»˜è®¤ä¼šå°†è¿™äº›å»¶è¿Ÿä¸¥é‡çš„æ•°æ®è¿›è¡Œä¸¢å¼ƒ**

é‚£ä¹ˆå¦‚æœæƒ³è¦è®©ä¸€å®šæ—¶é—´èŒƒå›´çš„å»¶è¿Ÿæ•°æ®ä¸ä¼šè¢«ä¸¢å¼ƒï¼Œå¯ä»¥ä½¿ç”¨Allowed Lateness(å…è®¸è¿Ÿåˆ°æœºåˆ¶/ä¾§é“è¾“å‡ºæœºåˆ¶)è®¾å®šä¸€ä¸ªå…è®¸å»¶è¿Ÿçš„æ—¶é—´å’Œä¾§é“è¾“å‡ºå¯¹è±¡æ¥è§£å†³

å³ä½¿ç”¨**WaterMark + EventTimeWindow + Allowed Latenessæ–¹æ¡ˆ**ï¼ˆåŒ…å«ä¾§é“è¾“å‡ºï¼‰ï¼Œå¯ä»¥åšåˆ°æ•°æ®ä¸ä¸¢å¤±ã€‚

**APIè°ƒç”¨**

l allowedLateness(lateness:Time)---è®¾ç½®å…è®¸å»¶è¿Ÿçš„æ—¶é—´

è¯¥æ–¹æ³•ä¼ å…¥ä¸€ä¸ªTimeå€¼ï¼Œè®¾ç½®å…è®¸æ•°æ®è¿Ÿåˆ°çš„æ—¶é—´ï¼Œè¿™ä¸ªæ—¶é—´å’Œwatermarkä¸­çš„æ—¶é—´æ¦‚å¿µä¸åŒã€‚å†æ¥å›é¡¾ä¸€ä¸‹ï¼Œ

**watermark=æ•°æ®çš„äº‹ä»¶æ—¶é—´-å…è®¸ä¹±åºæ—¶é—´å€¼**

éšç€æ–°æ•°æ®çš„åˆ°æ¥ï¼Œwatermarkçš„å€¼ä¼šæ›´æ–°ä¸ºæœ€æ–°æ•°æ®äº‹ä»¶æ—¶é—´-å…è®¸ä¹±åºæ—¶é—´å€¼ï¼Œä½†æ˜¯å¦‚æœè¿™æ—¶å€™æ¥äº†ä¸€æ¡å†å²æ•°æ®ï¼Œwatermarkå€¼åˆ™ä¸ä¼šæ›´æ–°ã€‚

**æ€»çš„æ¥è¯´ï¼Œwatermarkæ°¸è¿œä¸ä¼šå€’é€€å®ƒæ˜¯ä¸ºäº†èƒ½æ¥æ”¶åˆ°å°½å¯èƒ½å¤šçš„ä¹±åºæ•°æ®ã€‚**

é‚£è¿™é‡Œçš„Timeå€¼å‘¢ï¼Ÿä¸»è¦æ˜¯ä¸ºäº†ç­‰å¾…è¿Ÿåˆ°çš„æ•°æ®ï¼Œå¦‚æœå±äºè¯¥çª—å£çš„æ•°æ®åˆ°æ¥ï¼Œä»ä¼šè¿›è¡Œè®¡ç®—ï¼Œåé¢ä¼šå¯¹è®¡ç®—æ–¹å¼ä»”ç»†è¯´æ˜

æ³¨æ„ï¼šè¯¥æ–¹æ³•åªé’ˆå¯¹äºåŸºäºevent-timeçš„çª—å£ 

l sideOutputLateData(outputTag:OutputTag[T])--ä¿å­˜å»¶è¿Ÿæ•°æ®

è¯¥æ–¹æ³•æ˜¯å°†è¿Ÿæ¥çš„æ•°æ®ä¿å­˜è‡³ç»™å®šçš„outputTagå‚æ•°ï¼Œè€ŒOutputTagåˆ™æ˜¯ç”¨æ¥æ ‡è®°å»¶è¿Ÿæ•°æ®çš„ä¸€ä¸ªå¯¹è±¡ã€‚

l DataStream.getSideOutput(tag:OutputTag[X])--è·å–å»¶è¿Ÿæ•°æ®

é€šè¿‡windowç­‰æ“ä½œè¿”å›çš„DataStreamè°ƒç”¨è¯¥æ–¹æ³•ï¼Œä¼ å…¥æ ‡è®°å»¶è¿Ÿæ•°æ®çš„å¯¹è±¡æ¥è·å–å»¶è¿Ÿçš„æ•°æ®

> 22ã€åˆšæ‰æåˆ°Stateï¼Œé‚£ä½ ç®€å•è¯´ä¸€ä¸‹ä»€ä¹ˆæ˜¯Stateã€‚

â€‹       ![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9c418a9a-1257-11ec-948d-00163e068ecd.png)



åœ¨Flinkä¸­ï¼ŒçŠ¶æ€è¢«ç§°ä½œstateï¼Œæ˜¯ç”¨æ¥ **ä¿å­˜** ä¸­é—´çš„ **è®¡ç®—ç»“æœ** æˆ–è€… **ç¼“å­˜æ•°æ®ã€‚**



æ ¹æ®çŠ¶æ€æ˜¯å¦éœ€è¦ä¿å­˜ä¸­é—´ç»“æœï¼Œåˆ†ä¸º **æ— çŠ¶æ€è®¡ç®—** å’Œ **æœ‰çŠ¶æ€è®¡ç®—ã€‚**



å¯¹äºæµè®¡ç®—è€Œè¨€ï¼Œäº‹ä»¶æŒç»­äº§ç”Ÿï¼Œå¦‚æœæ¯æ¬¡è®¡ç®—**ç›¸äº’ç‹¬ç«‹**ï¼Œä¸ä¾èµ–ä¸Šä¸‹æ¸¸çš„äº‹ä»¶ï¼Œåˆ™ç›¸åŒè¾“å…¥ï¼Œå¯ä»¥å¾—åˆ°ç›¸åŒè¾“å‡ºï¼Œ**æ˜¯æ— çŠ¶æ€è®¡ç®—**ã€‚



å¦‚æœè®¡ç®—éœ€è¦**ä¾èµ–**äºä¹‹å‰æˆ–è€…åç»­äº‹ä»¶ï¼Œåˆ™è¢«ç§°**ä¸ºæœ‰çŠ¶æ€è®¡ç®—**ã€‚



![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9c610e7e-1257-11ec-948d-00163e068ecd.png)



æœ‰çŠ¶æ€è®¡ç®—å¦‚ sumæ±‚å’Œï¼Œæ•°æ®ç±»åŠ ç­‰ã€‚

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9c852d86-1257-11ec-948d-00163e068ecd.png)



> 23ã€Flink çŠ¶æ€åŒ…æ‹¬å“ªäº›ï¼Ÿ

**ï¼ˆ1ï¼‰** æŒ‰ç…§ç”± Flinkç®¡ç† è¿˜æ˜¯ ç”¨æˆ·ç®¡ç†ï¼ŒçŠ¶æ€å¯ä»¥åˆ†ä¸º **åŸå§‹çŠ¶æ€ï¼ˆRaw Stateï¼‰**å’Œ **æ‰˜ç®¡çŠ¶æ€ï¼ˆManagedStateï¼‰**



**æ‰˜ç®¡çŠ¶æ€ï¼ˆManagedStateï¼‰**:ç”±Flink è‡ªè¡Œè¿›è¡Œç®¡ç†çš„Stateã€‚

**åŸå§‹çŠ¶æ€ï¼ˆRaw Stateï¼‰**ï¼šç”±ç”¨æˆ·è‡ªè¡Œè¿›è¡Œç®¡ç†ã€‚



ä¸¤è€…åŒºåˆ«ï¼š



\1.   ä»çŠ¶æ€ç®¡ç†æ–¹å¼çš„æ–¹å¼æ¥è¯´ï¼Œ**Managed State** ç”±**Flink Runtime** ç®¡ç†ï¼Œè‡ªåŠ¨å­˜å‚¨ï¼Œè‡ªåŠ¨æ¢å¤ï¼Œåœ¨å†…å­˜ç®¡ç†ä¸Šæœ‰ä¼˜åŒ–ï¼›è€Œ **Raw State** éœ€è¦ç”¨æˆ·è‡ªå·±ç®¡ç†ï¼Œéœ€è¦è‡ªå·±åºåˆ—åŒ–ï¼ŒFlink ä¸çŸ¥é“ State ä¸­å­˜å…¥çš„æ•°æ®æ˜¯ä»€ä¹ˆç»“æ„ï¼Œåªæœ‰ç”¨æˆ·è‡ªå·±çŸ¥é“ï¼Œéœ€è¦æœ€ç»ˆåºåˆ—åŒ–ä¸ºå¯å­˜å‚¨çš„æ•°æ®ç»“æ„ã€‚

\2.   ä»çŠ¶æ€æ•°æ®ç»“æ„æ¥è¯´ï¼ŒManaged State æ”¯æŒå·²çŸ¥çš„æ•°æ®ç»“æ„ï¼Œå¦‚Valueã€Listã€Mapç­‰ã€‚è€Œ Raw State **åªæ”¯æŒ****å­—èŠ‚**æ•°ç»„ï¼Œæ‰€æœ‰çŠ¶æ€éƒ½è¦è½¬æ¢ä¸ºäºŒè¿›åˆ¶å­—èŠ‚æ•°ç»„æ‰å¯ä»¥ã€‚

\3.   ä»æ¨èä½¿ç”¨åœºæ™¯æ¥è¯´ï¼ŒManaged State å¤§å¤šæ•°æƒ…å†µä¸‹å‡å¯ä½¿ç”¨ï¼Œè€ŒRaw State æ˜¯å½“ Managed State ä¸å¤Ÿç”¨æ—¶ï¼Œæ¯”å¦‚éœ€è¦è‡ªå®šä¹‰Operator æ—¶ï¼Œæ‰ä¼šä½¿ç”¨ Raw Stateã€‚**åœ¨å®é™…ç”Ÿäº§è¿‡ç¨‹ä¸­ï¼Œåªæ¨èä½¿ç”¨ Managed State ã€‚**

**ï¼ˆ2ï¼‰****State** æŒ‰ç…§æ˜¯å¦æœ‰ key åˆ’åˆ†ä¸º **KeyedState** å’Œ **OperatorState** ä¸¤ç§ã€‚



**keyedStateç‰¹ç‚¹ï¼š**



 \1. åªèƒ½ç”¨åœ¨keyedStreamä¸Šçš„ç®—å­ä¸­ï¼ŒçŠ¶æ€è·Ÿç‰¹å®šçš„keyç»‘å®šã€‚

 \2. keyStreamæµä¸Šçš„æ¯ä¸€ä¸ªkey å¯¹åº”ä¸€ä¸ªstate å¯¹è±¡ã€‚è‹¥ä¸€ä¸ªoperator å®ä¾‹å¤„ç†å¤šä¸ªkeyï¼Œè®¿é—®ç›¸åº”çš„å¤šä¸ªStateï¼Œ**å¯å¯¹åº”å¤šä¸ªstateã€‚**

 \3. keyedState ä¿å­˜åœ¨StateBackendä¸­

 \4. é€šè¿‡RuntimeContextè®¿é—®ï¼Œå®ç°Rich Functionæ¥å£ã€‚

 \5. æ”¯æŒå¤šç§æ•°æ®ç»“æ„ï¼šValueStateã€ListStateã€ReducingStateã€AggregatingStateã€MapState.

  ![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9ca5127c-1257-11ec-948d-00163e068ecd.png)



**Operato****rStateç‰¹ç‚¹ï¼š**



\1. å¯ä»¥ç”¨äºæ‰€æœ‰ç®—å­ï¼Œä½†æ•´ä¸ªç®—å­åªå¯¹åº”ä¸€ä¸ªstateã€‚

2.å¹¶å‘æ”¹å˜æ—¶æœ‰å¤šç§é‡æ–°åˆ†é…çš„æ–¹å¼å¯é€‰ï¼šå‡åŒ€åˆ†é…ï¼›

\3. å®ç°CheckpointedFunctionæˆ–è€… ListCheckpointed æ¥å£ã€‚

\4. ç›®å‰åªæ”¯æŒ ListStateæ•°æ®ç»“æ„ã€‚     



![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9cd29bca-1257-11ec-948d-00163e068ecd.png)



è¿™é‡Œçš„fromElementsä¼šè°ƒç”¨**FromElementsFunction**çš„ç±»ï¼Œå…¶ä¸­å°±ä½¿ç”¨äº†ç±»å‹ä¸ºList state çš„ operator state

> 24ã€Flinkå¹¿æ’­çŠ¶æ€äº†è§£å—ï¼Ÿ



Flinkä¸­ï¼Œå¹¿æ’­çŠ¶æ€ä¸­å«ä½œ BroadcastStateã€‚ åœ¨å¹¿æ’­çŠ¶æ€æ¨¡å¼ä¸­ä½¿ç”¨ã€‚**æ‰€è°“å¹¿æ’­çŠ¶æ€æ¨¡å¼ï¼Œ å°±æ˜¯æ¥è‡ªä¸€ä¸ªæµçš„æ•°æ®éœ€è¦è¢«å¹¿æ’­åˆ°æ‰€æœ‰ä¸‹æ¸¸ä»»åŠ¡**ï¼Œ**åœ¨ç®—å­æœ¬åœ°å­˜å‚¨ï¼Œåœ¨å¤„ç†å¦ä¸€ä¸ªæµçš„æ—¶å€™ä¾èµ–äºå¹¿æ’­çš„æ•°æ®**.ä¸‹é¢ä»¥ä¸€ä¸ªç¤ºä¾‹æ¥è¯´æ˜å¹¿æ’­çŠ¶æ€æ¨¡å¼ã€‚



![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9cf71464-1257-11ec-948d-00163e068ecd.png)



ä¸Šå›¾è¿™ä¸ªç¤ºä¾‹åŒ…å«ä¸¤ä¸ªæµï¼Œä¸€ä¸ªä¸º**kafkaæ¨¡å‹æµ**ï¼Œè¯¥æ¨¡å‹æ˜¯é€šè¿‡æœºå™¨å­¦ä¹ æˆ–è€…æ·±åº¦å­¦ä¹ è®­ç»ƒå¾—åˆ°çš„æ¨¡å‹ï¼Œå°†è¯¥æ¨¡å‹é€šè¿‡å¹¿æ’­ï¼Œå‘é€ç»™ä¸‹æ¸¸æ‰€æœ‰è§„åˆ™ç®—å­ï¼Œè§„åˆ™ç®—å­å°†è§„åˆ™ç¼“å­˜åˆ°Flinkçš„æœ¬åœ°å†…å­˜ä¸­ï¼Œå¦ä¸€ä¸ªä¸º **Kafkaæ•°æ®æµ**ï¼Œç”¨æ¥æ¥æ”¶æµ‹è¯•é›†ï¼Œè¯¥æµ‹è¯•é›†ä¾èµ–äºæ¨¡å‹æµä¸­çš„æ¨¡å‹ï¼Œé€šè¿‡æ¨¡å‹å®Œæˆæµ‹è¯•é›†çš„æ¨ç†ä»»åŠ¡ã€‚



å¹¿æ’­çŠ¶æ€ï¼ˆStateï¼‰å¿…é¡»æ˜¯MapStateç±»å‹ï¼Œå¹¿æ’­çŠ¶æ€æ¨¡å¼éœ€è¦ä½¿ç”¨å¹¿æ’­å‡½æ•°è¿›è¡Œå¤„ç†ï¼Œå¹¿æ’­å‡½æ•°æä¾›äº†å¤„ç†å¹¿æ’­æ•°æ®æµå’Œæ™®é€šæ•°æ®æµçš„æ¥å£ã€‚



> 25ã€Flink çŠ¶æ€æ¥å£åŒ…æ‹¬å“ªäº›ï¼Ÿ



åœ¨Flinkä¸­ä½¿ç”¨çŠ¶æ€ï¼ŒåŒ…å«ä¸¤ç§çŠ¶æ€æ¥å£ï¼š



ï¼ˆ1ï¼‰**çŠ¶æ€æ“ä½œæ¥å£ï¼š**ä½¿ç”¨çŠ¶æ€å¯¹è±¡æœ¬èº«å­˜å‚¨ï¼Œå†™å…¥ã€æ›´æ–°æ•°æ®ã€‚



ï¼ˆ2ï¼‰**çŠ¶æ€è®¿é—®æ¥å£ï¼š**ä»StateBackendè·å–çŠ¶æ€å¯¹è±¡æœ¬èº«ã€‚



**çŠ¶æ€æ“ä½œæ¥å£**



Flink ä¸­çš„ **çŠ¶æ€æ“ä½œæ¥å£** é¢å‘ä¸¤ç±»ç”¨æˆ·ï¼Œå³ **åº”ç”¨å¼€å‘è€…** å’Œ **Flink æ¡†æ¶æœ¬èº«**ã€‚ æ‰€æœ‰Flinkè®¾è®¡äº†ä¸¤å¥—æ¥å£

**1ã€é¢å‘å¼€å‘è€…Stateæ¥å£**

é¢å‘å¼€å‘çš„Stateæ¥å£åªæä¾›äº†å¯¹Stateä¸­æ•°æ®çš„å¢åˆ æ”¹åŸºæœ¬æ“ä½œæ¥å£ï¼Œç”¨æˆ·æ— æ³•è®¿é—®çŠ¶æ€çš„å…¶ä»–è¿è¡Œæ—¶æ‰€éœ€è¦çš„ä¿¡æ¯ã€‚æ¥å£ä½“ç³»å¦‚ä¸‹å›¾ï¼š



![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9d141424-1257-11ec-948d-00163e068ecd.png)

é¢å‘å¼€å‘è€…çš„ State æ¥å£ä½“ç³»



**2ã€é¢å‘å†…éƒ¨Stateæ¥å£**

å†…éƒ¨State æ¥å£ æ˜¯ç»™ Flink æ¡†æ¶ä½¿ç”¨ï¼Œæä¾›æ›´å¤šçš„Stateæ–¹æ³•ï¼Œå¯ä»¥æ ¹æ®éœ€è¦çµæ´»æ‰©å±•ã€‚é™¤äº†å¯¹Stateä¸­æ•°æ®çš„è®¿é—®ä¹‹å¤–ï¼Œè¿˜æä¾›å†…éƒ¨è¿è¡Œæ—¶ä¿¡æ¯ï¼Œå¦‚Stateä¸­æ•°æ®çš„åºåˆ—åŒ–å™¨ï¼Œå‘½åç©ºé—´ï¼ˆnamespaceï¼‰ã€å‘½åç©ºé—´çš„åºåˆ—åŒ–å™¨ã€å‘½åç©ºé—´åˆå¹¶çš„æ¥å£ã€‚**å†…éƒ¨Stateæ¥å£å‘½åæ–¹å¼ä¸ºInternalxxxStateã€‚**



**çŠ¶æ€è®¿é—®æ¥å£**



**æœ‰äº†çŠ¶æ€ä¹‹åï¼Œå¼€å‘è€…è‡ªå®šä¹‰UDFæ—¶ï¼Œåº”è¯¥å¦‚ä½•è®¿é—®çŠ¶æ€ï¼Ÿ
**



çŠ¶æ€ä¼šè¢«ä¿å­˜åœ¨StateBackendä¸­ï¼Œä½†StateBackend åˆåŒ…å«ä¸åŒçš„ç±»å‹ã€‚æ‰€æœ‰Flinkä¸­æŠ½è±¡äº†ä¸¤ä¸ªçŠ¶æ€è®¿é—®æ¥å£ï¼š**OperatorStateStore** å’Œ **KeyedStateStoreï¼Œ**ç”¨æˆ·åœ¨ç¼–å†™UDFæ—¶ï¼Œå°±æ— é¡»è€ƒè™‘åˆ°åº•æ˜¯ä½¿ç”¨å“ªç§ StateBackendç±»å‹æ¥å£ã€‚



OperatorStateStore æ¥å£åŸç†ï¼š



![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9d325308-1257-11ec-948d-00163e068ecd.png)



OperatorStateæ•°æ®ä»¥Mapå½¢å¼ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œå¹¶æ²¡æœ‰ä½¿ç”¨RocksDBStateBackendå’ŒHeapKeyedStateBackendã€‚



KeyedStateStore æ¥å£åŸç†ï¼š

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9d548720-1257-11ec-948d-00163e068ecd.png)



keyedStateStoreæ•°æ®ä½¿ç”¨RocksDBStateBackendæˆ–è€…HeapKeyedStateBackendæ¥å­˜å‚¨ï¼ŒKeyedStateStoreä¸­åˆ›å»ºã€è·å–çŠ¶æ€éƒ½äº¤ç»™äº†å…·ä½“çš„StateBackendæ¥å¤„ç†ï¼ŒKeyedStateStoreæœ¬èº«æ›´åƒæ˜¯ä¸€ä¸ªä»£ç†ã€‚

> 26ã€Flink çŠ¶æ€å¦‚ä½•å­˜å‚¨

åœ¨Flinkä¸­ï¼Œ çŠ¶æ€å­˜å‚¨è¢«å«åš **StateBackend** , å®ƒå…·å¤‡ä¸¤ç§èƒ½åŠ›ï¼š

ï¼ˆ1ï¼‰åœ¨è®¡ç®—è¿‡ç¨‹ä¸­æä¾›è®¿é—®Stateèƒ½åŠ›ï¼Œå¼€å‘è€…åœ¨ç¼–å†™ä¸šåŠ¡é€»è¾‘ä¸­èƒ½å¤Ÿä½¿ç”¨StateBackendçš„æ¥å£è¯»å†™æ•°æ®ã€‚

ï¼ˆ2ï¼‰èƒ½å¤Ÿå°†StateæŒä¹…åŒ–åˆ°å¤–éƒ¨å­˜å‚¨ï¼Œæä¾›å®¹é”™èƒ½åŠ›ã€‚



FlinkçŠ¶æ€**æä¾›ä¸‰ç§å­˜å‚¨æ–¹å¼**ï¼š



**ï¼ˆ1ï¼‰å†…å­˜ï¼š**MemoryStateBackend,é€‚ç”¨äºéªŒè¯ã€æµ‹è¯•ã€ä¸æ¨èç”Ÿäº§ä½¿ç”¨ã€‚



**ï¼ˆ2ï¼‰æ–‡ä»¶ï¼š**FSStateBackendï¼Œé€‚ç”¨äºé•¿å‘¨æœŸå¤§è§„æ¨¡çš„æ•°æ®ã€‚



**ï¼ˆ3ï¼‰RocksDB :** RocksDBStateBackendï¼Œé€‚ç”¨äºé•¿å‘¨æœŸå¤§è§„æ¨¡çš„æ•°æ®ã€‚



ä¸Šé¢æåˆ°çš„ StateBackendæ˜¯é¢å‘ç”¨æˆ·çš„ï¼Œåœ¨Flinkå†…éƒ¨3ç§ State çš„å…³ç³»å¦‚ä¸‹å›¾ï¼š



![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9d777758-1257-11ec-948d-00163e068ecd.png)



åœ¨è¿è¡Œæ—¶ï¼Œ**MemoryStateBackend** å’Œ **FSStateBackend** æœ¬åœ°çš„ State éƒ½ä¿å­˜åœ¨TaskManagerçš„å†…å­˜ä¸­ï¼Œæ‰€ä»¥å…¶åº•å±‚éƒ½ä¾èµ–äº**HeapKeyedStateBackend**ã€‚HeapKeyedStateBackendé¢å‘Flink å¼•æ“å†…éƒ¨ï¼Œä½¿ç”¨è€…æ— é¡»æ„ŸçŸ¥ã€‚



**1ã€å†…å­˜å‹ StateBackend**



MemoryStateBackendï¼Œè¿è¡Œæ—¶æ‰€éœ€çš„Stateæ•°æ®å…¨éƒ¨ä¿å­˜åœ¨ **TaskManager JVMå †ä¸Šå†…å­˜ä¸­ï¼Œ** KVç±»å‹çš„Stateã€çª—å£ç®—å­çš„State ä½¿ç”¨HashTable æ¥ä¿å­˜æ•°æ®ã€è§¦å‘å™¨ç­‰ã€‚**æ‰§è¡Œæ£€æŸ¥ç‚¹çš„æ—¶å€™ï¼Œä¼šæŠŠ State çš„å¿«ç…§æ•°æ®ä¿å­˜åˆ°****JobManagerè¿›ç¨‹çš„å†…å­˜ä¸­****ã€‚**



MemoryStateBackend å¯ä»¥ä½¿ç”¨**å¼‚æ­¥**çš„æ–¹å¼è¿›è¡Œå¿«ç…§ï¼Œï¼ˆä¹Ÿå¯ä»¥åŒæ­¥ï¼‰ï¼Œ**æ¨èå¼‚æ­¥**ï¼Œé¿å…é˜»å¡ç®—å­å¤„ç†æ•°æ®ã€‚



åŸºäºå†…å­˜çš„ StateÃŸackend åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ä¸å»ºè®®ä½¿ç”¨ï¼Œå¯ä»¥åœ¨æœ¬åœ°å¼€å‘è°ƒè¯•æµ‹è¯• ã€‚

**æ³¨æ„ç‚¹å¦‚ä¸‹ ï¼š**

\1) State å­˜å‚¨åœ¨ JobManager çš„å†…å­˜ä¸­.å—é™äº JobManagerçš„å†…å­˜å¤§å°ã€‚ 

\2) æ¯ä¸ª Stateé»˜è®¤5MB,å¯é€šè¿‡ MemoryStateBackend æ„é€ å‡½æ•°è°ƒæ•´ 

\3) æ¯ä¸ª Stale ä¸èƒ½è¶…è¿‡ Akka Frame å¤§å°ã€‚



**2ã€æ–‡ä»¶å‹ StateBackend**



FSStateBackendï¼Œè¿è¡Œæ—¶æ‰€éœ€çš„Stateæ•°æ®å…¨éƒ¨ä¿å­˜åœ¨ **TaskManager çš„å†…å­˜ä¸­ï¼Œ** **æ‰§è¡Œæ£€æŸ¥ç‚¹çš„æ—¶å€™ï¼Œä¼šæŠŠ State çš„å¿«ç…§æ•°æ®ä¿å­˜åˆ°****é…ç½®çš„æ–‡ä»¶ç³»ç»Ÿä¸­****ã€‚**



å¯ä»¥æ˜¯åˆ†å¸ƒå¼æˆ–è€…æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼Œè·¯å¾„å¦‚ï¼š

HDFSè·¯å¾„ï¼šâ€œhdfs://namenode:40010/flink/checkpointsâ€

æœ¬åœ°è·¯å¾„ï¼šâ€œfile:///data/flink/checkpointsâ€ã€‚



FSStateBackend **é€‚ç”¨äºå¤„ç†å¤§çŠ¶æ€ã€é•¿çª—å£ã€æˆ–è€…å¤§é”®å€¼çŠ¶æ€çš„æœ‰çŠ¶æ€å¤„ç†ä»»åŠ¡**ã€‚

**æ³¨æ„ç‚¹å¦‚ä¸‹ ï¼š**

\1) State æ•°æ®é¦–å…ˆè¢«å­˜åœ¨ TaskManager çš„å†…å­˜ä¸­ã€‚ 

\2) Stateå¤§å°ä¸èƒ½è¶…è¿‡TMå†…å­˜ã€‚

\3) TMå¼‚æ­¥å°†Stateæ•°æ®å†™å…¥å¤–éƒ¨å­˜å‚¨ã€‚



**MemoryStateBackend å’ŒFSStateBackend éƒ½ä¾èµ–äºHeapKeyedStateBackendï¼ŒHeapKeyedStateBackend ä½¿ç”¨ Stateå­˜å‚¨æ•°æ®ã€‚**



**3ã€RocksDBStateBackend**



RocksDBStateBackend è·Ÿå†…å­˜å‹å’Œæ–‡ä»¶å‹éƒ½ä¸åŒ ã€‚



RocksDBStateBackend **ä½¿ç”¨****åµŒå…¥å¼çš„æœ¬åœ°æ•°æ®åº“ RocksDB** å°†æµè®¡ç®—æ•°æ®çŠ¶æ€**å­˜å‚¨åœ¨æœ¬åœ°ç£ç›˜ä¸­**ï¼Œä¸ä¼šå—é™äºTaskManager çš„å†…å­˜å¤§å°ï¼Œåœ¨æ‰§è¡Œæ£€æŸ¥ç‚¹çš„æ—¶å€™ï¼Œå†å°†æ•´ä¸ª RocksDB ä¸­ä¿å­˜çš„Stateæ•°æ®å…¨é‡æˆ–è€…å¢é‡æŒä¹…åŒ–åˆ°é…ç½®çš„æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œ



åœ¨ JobManager å†…å­˜ä¸­ä¼šå­˜å‚¨å°‘é‡çš„æ£€æŸ¥ç‚¹å…ƒæ•°æ®ã€‚RocksDBå…‹æœäº†Stateå—å†…å­˜é™åˆ¶çš„é—®é¢˜ï¼ŒåŒæ—¶åˆèƒ½å¤ŸæŒä¹…åŒ–åˆ°è¿œç«¯æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œæ¯”è¾ƒé€‚åˆåœ¨ç”Ÿäº§ä¸­ä½¿ç”¨ã€‚



**ç¼ºç‚¹ï¼š**



RocksDBStateBackend ç›¸æ¯”åŸºäºå†…å­˜çš„StateBackendï¼Œè®¿é—®Stateçš„æˆæœ¬é«˜å¾ˆå¤šï¼Œå¯èƒ½å¯¼è‡´æ•°æ®æµçš„ååé‡å‰§çƒˆä¸‹é™ï¼Œç”šè‡³å¯èƒ½**é™ä½ä¸ºåŸæ¥çš„ 1/10**ã€‚



**é€‚ç”¨åœºæ™¯**



1ï¼‰æœ€é€‚åˆç”¨äºå¤„ç†å¤§çŠ¶æ€ã€é•¿çª—å£ï¼Œæˆ–å¤§é”®å€¼çŠ¶æ€çš„æœ‰çŠ¶æ€å¤„ç†ä»»åŠ¡ã€‚ 

2ï¼‰RocksDBStateBackend éå¸¸é€‚åˆç”¨äºé«˜å¯ç”¨æ–¹æ¡ˆã€‚ 

\3) RocksDBStateBackend æ˜¯**ç›®å‰å”¯ä¸€æ”¯æŒå¢é‡æ£€æŸ¥ç‚¹çš„åç«¯ã€‚** å¢é‡æ£€æŸ¥ç‚¹éå¸¸é€‚ç”¨äºè¶… å¤§çŠ¶æ€çš„åœºæ™¯ã€‚ 



**æ³¨æ„ç‚¹** 



1ï¼‰æ€» State å¤§å°ä»…é™äºç£ç›˜å¤§å°ï¼Œä¸å—å†…å­˜é™åˆ¶ 

2ï¼‰**RocksDBStateBackend** ä¹Ÿéœ€è¦é…ç½®å¤–éƒ¨æ–‡ä»¶ç³»ç»Ÿï¼Œé›†ä¸­ä¿å­˜State ã€‚

3ï¼‰RocksDBçš„ JNI API **åŸºäº byte æ•°ç»„**ï¼Œå• key å’Œå• Value çš„å¤§å°ä¸èƒ½è¶…è¿‡ 8 å­—èŠ‚

4ï¼‰å¯¹äºä½¿ç”¨å…·æœ‰åˆå¹¶æ“ä½œçŠ¶æ€çš„åº”ç”¨ç¨‹åºï¼Œå¦‚ListState ï¼Œéšç€æ—¶é—´å¯èƒ½ä¼šç´¯ç§¯åˆ°è¶…è¿‡ 2*31æ¬¡æ–¹å­—èŠ‚å¤§å°ï¼Œè¿™å°†ä¼šå¯¼è‡´åœ¨æ¥ä¸‹æ¥çš„æŸ¥è¯¢ä¸­å¤±è´¥ã€‚

> 27ã€Flink çŠ¶æ€å¦‚ä½•æŒä¹…åŒ–ï¼Ÿ

é¦–é€‰ï¼ŒFlinkçš„çŠ¶æ€æœ€ç»ˆéƒ½è¦æŒä¹…åŒ–åˆ°ç¬¬ä¸‰æ–¹å­˜å‚¨ä¸­ï¼Œç¡®ä¿é›†ç¾¤æ•…éšœæˆ–è€…ä½œä¸šæŒ‚æ‰åèƒ½å¤Ÿæ¢å¤ã€‚



RocksDBStateBackend æŒä¹…åŒ–ç­–ç•¥æœ‰ä¸¤ç§ï¼š

**å…¨é‡æŒä¹…åŒ–ç­–ç•¥** RocksFullSnapshotStrategy

**å¢é‡æŒä¹…åŒ–ç­–ç•¥** RocksIncementalSnapshotStrategy



**1ã€å…¨é‡æŒä¹…åŒ–ç­–ç•¥**



æ¯æ¬¡å°†å…¨é‡çš„Stateå†™å…¥åˆ°çŠ¶æ€å­˜å‚¨ä¸­ï¼ˆHDFSï¼‰ã€‚å†…å­˜å‹ã€æ–‡ä»¶å‹ã€RocksDBç±»å‹çš„StataBackend éƒ½æ”¯æŒå…¨é‡æŒä¹…åŒ–ç­–ç•¥ã€‚



![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9d9a3784-1257-11ec-948d-00163e068ecd.png)

å¿«ç…§ä¿å­˜ç­–ç•¥ç±»ä½“ç³»



åœ¨æ‰§è¡ŒæŒä¹…åŒ–ç­–ç•¥çš„æ—¶å€™ï¼Œä½¿ç”¨å¼‚æ­¥æœºåˆ¶ï¼Œæ¯ä¸ªç®—å­å¯åŠ¨1ä¸ªç‹¬ç«‹çš„çº¿ç¨‹ï¼Œå°†è‡ªèº«çš„çŠ¶æ€å†™å…¥åˆ†å¸ƒå¼å­˜å‚¨å¯é å­˜å‚¨ä¸­ã€‚åœ¨åšæŒä¹…åŒ–çš„è¿‡ç¨‹ä¸­ï¼ŒçŠ¶æ€å¯èƒ½ä¼šè¢«æŒç»­ä¿®æ”¹ï¼Œ

**åŸºäºå†…å­˜çš„çŠ¶æ€åç«¯**ä½¿ç”¨ CopyOnWriteStateTable æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼ŒRocksDBStateBackendåˆ™ä½¿ç”¨RocksDBçš„å¿«ç…§æœºåˆ¶ï¼Œä½¿ç”¨å¿«ç…§æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚



**2ã€å¢é‡æŒä¹…åŒ–ç­–ç•¥**



å¢é‡æŒä¹…åŒ–å°±æ˜¯æ¯æ¬¡æŒä¹…åŒ–å¢é‡çš„Stateï¼Œ**åªæœ‰RocksDBStateBackend æ”¯æŒå¢é‡æŒä¹…åŒ–ã€‚**



**Flink å¢é‡å¼çš„æ£€æŸ¥ç‚¹ä»¥ RocksDBä¸ºåŸºç¡€**ï¼Œ RocksDBæ˜¯ä¸€ä¸ªåŸºäºLSM-Treeçš„KVå­˜å‚¨ã€‚æ–°çš„æ•°æ®ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œ ç§°ä¸º**memtable**ã€‚å¦‚æœKeyç›¸åŒï¼Œååˆ°çš„æ•°æ®å°†è¦†ç›–ä¹‹å‰çš„æ•°æ®ï¼Œä¸€æ—¦memtableå†™æ»¡äº†ï¼ŒRocksDBå°±ä¼šå°†æ•°æ®å‹ç¼©å¹¶å†™å…¥ç£ç›˜ã€‚memtableçš„æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜åï¼Œå°±å˜æˆäº†ä¸å¯å˜çš„ **sstable**ã€‚



**å› ä¸º sstable æ˜¯ä¸å¯å˜çš„ï¼Œ**Flinkå¯¹æ¯”å‰ä¸€ä¸ªæ£€æŸ¥ç‚¹åˆ›å»ºå’Œåˆ é™¤çš„RocksDB sstable æ–‡ä»¶å°±å¯ä»¥è®¡ç®—å‡ºçŠ¶æ€æœ‰å“ªäº›å‘ç”Ÿæ”¹å˜ã€‚

ä¸ºäº†ç¡®ä¿ sstable æ˜¯ä¸å¯å˜çš„ï¼Œ**Flink ä¼šåœ¨RocksDB è§¦å‘åˆ·æ–°æ“ä½œ**ï¼Œ**å¼ºåˆ¶å°† memtable åˆ·æ–°åˆ°ç£ç›˜ä¸Š ã€‚**åœ¨Flink æ‰§è¡Œæ£€æŸ¥ç‚¹æ—¶ï¼Œä¼šå°†æ–°çš„sstable æŒä¹…åŒ–åˆ°HDFSä¸­ï¼ŒåŒæ—¶ä¿ç•™å¼•ç”¨ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ Flink å¹¶ä¸ä¼šæŒä¹…åŒ–æœ¬åœ°æ‰€æœ‰çš„sstableï¼Œå› ä¸ºæœ¬åœ°çš„ä¸€éƒ¨åˆ†å†å²sstable åœ¨ä¹‹å‰çš„æ£€æŸ¥ç‚¹ä¸­å·²ç»æŒä¹…åŒ–åˆ°å­˜å‚¨ä¸­äº†ï¼Œåªéœ€å¢åŠ å¯¹ sstableæ–‡ä»¶çš„å¼•ç”¨æ¬¡æ•°å°±å¯ä»¥ã€‚ 



**RocksDBä¼šåœ¨åå°åˆå¹¶ sstable å¹¶åˆ é™¤å…¶ä¸­é‡å¤çš„æ•°æ®**ã€‚ç„¶ååœ¨RocksDBåˆ é™¤åŸæ¥çš„ sstableï¼Œæ›¿æ¢æˆæ–°åˆæˆçš„ sstable.ã€‚**æ–°çš„ sstable åŒ…å«äº†è¢«åˆ é™¤çš„ sstableä¸­çš„ä¿¡æ¯ï¼Œ**é€šè¿‡åˆå¹¶å†å²çš„sstableä¼šåˆå¹¶æˆä¸€ä¸ªæ–°çš„ sstableï¼Œå¹¶åˆ é™¤è¿™äº›å†å²sstable. å¯ä»¥å‡å°‘æ£€æŸ¥ç‚¹çš„å†å²æ–‡ä»¶ï¼Œé¿å…å¤§é‡å°æ–‡ä»¶çš„äº§ç”Ÿã€‚

> 28ã€Flink çŠ¶æ€è¿‡æœŸåå¦‚ä½•æ¸…ç†ï¼Ÿ

**1ã€DataStreamä¸­çŠ¶æ€è¿‡æœŸ**



å¯ä»¥å¯¹DataStreamä¸­çš„æ¯ä¸€ä¸ªçŠ¶æ€è®¾ç½® **æ¸…ç†ç­–ç•¥ StateTtlConfig**ï¼Œå¯ä»¥è®¾ç½®çš„å†…å®¹å¦‚ä¸‹ï¼š

- è¿‡æœŸæ—¶é—´ï¼šè¶…è¿‡å¤šé•¿æ—¶é—´æœªè®¿é—®ï¼Œè§†ä¸ºStateè¿‡æœŸï¼Œç±»ä¼¼äºç¼“å­˜ã€‚
- è¿‡æœŸæ—¶é—´æ›´æ–°ç­–ç•¥ï¼šåˆ›å»ºå’Œå†™æ—¶æ›´æ–°ã€è¯»å–å’Œå†™æ—¶æ›´æ–°ã€‚
- Stateå¯è§æ€§ï¼šæœªæ¸…ç†å¯ç”¨ï¼Œè¶…æ—¶åˆ™ä¸å¯ç”¨ã€‚



**2ã€Flink SQLä¸­çŠ¶æ€è¿‡æœŸ**



Flink SQL ä¸€èˆ¬åœ¨æµJoinã€èšåˆç±»åœºæ™¯ä½¿ç”¨Stateï¼Œå¦‚æœStateä¸å®šæ—¶æ¸…ç†ï¼Œåˆ™å¯¼è‡´Stateè¿‡å¤šï¼Œå†…å­˜æº¢å‡ºã€‚æ¸…ç†ç­–ç•¥é…ç½®å¦‚ä¸‹ï¼š



```
StreamQueryConfig qConfig = ...
//è®¾ç½®è¿‡æœŸæ—¶é—´ä¸º min = 12å°æ—¶ ï¼Œmax = 24å°æ—¶
qConfig.withIdleStateRetentionTime(Time.hours(12),Time.hours(24));
```





![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9db6dbbe-1257-11ec-948d-00163e068ecd.png)

> 29ã€Flink é€šè¿‡ä»€ä¹ˆå®ç°**å¯é çš„å®¹é”™æœºåˆ¶**ã€‚

Flink ä½¿ç”¨ è½»é‡çº§åˆ†å¸ƒå¼å¿«ç…§ï¼Œè®¾è®¡æ£€æŸ¥ç‚¹ï¼ˆ**checkpoint**ï¼‰å®ç°å¯é å®¹é”™ã€‚

> 30ã€ä»€ä¹ˆæ˜¯Checkpoinæ£€æŸ¥ç‚¹ï¼Ÿ

**Checkpoint**è¢«å«åš**æ£€æŸ¥ç‚¹**ï¼Œæ˜¯Flinkå®ç°å®¹é”™æœºåˆ¶æœ€æ ¸å¿ƒçš„åŠŸèƒ½ï¼Œæ˜¯Flinkå¯é æ€§çš„åŸºçŸ³ï¼Œå®ƒèƒ½å¤Ÿæ ¹æ®é…ç½®å‘¨æœŸæ€§åœ°åŸºäºStreamä¸­å„ä¸ªOperatorçš„**çŠ¶æ€**æ¥ç”ŸæˆSnapshot**å¿«ç…§**ï¼Œä»è€Œå°†è¿™äº›çŠ¶æ€æ•°æ®å®šæœŸæŒä¹…åŒ–å­˜å‚¨ä¸‹æ¥ï¼Œå½“Flinkç¨‹åºä¸€æ—¦æ„å¤–å´©æºƒæ—¶ï¼Œé‡æ–°è¿è¡Œç¨‹åºæ—¶å¯ä»¥æœ‰é€‰æ‹©åœ°ä»è¿™äº›Snapshotè¿›è¡Œæ¢å¤ï¼Œä»è€Œä¿®æ­£å› ä¸ºæ•…éšœå¸¦æ¥çš„ç¨‹åºæ•°æ®çŠ¶æ€ä¸­æ–­ã€‚

Flinkçš„checkpointæœºåˆ¶åŸç†æ¥è‡ªâ€œ**Chandy-Lamport algorithm**â€ç®—æ³•

**æ³¨æ„:åŒºåˆ†Stateå’ŒCheckpoint**

**1.State:**

ä¸€èˆ¬æŒ‡ä¸€ä¸ªå…·ä½“çš„Task/Operatorçš„çŠ¶æ€(operatorçš„çŠ¶æ€è¡¨ç¤ºä¸€äº›ç®—å­åœ¨è¿è¡Œçš„è¿‡ç¨‹ä¸­ä¼šäº§ç”Ÿçš„ä¸€äº›ä¸­é—´ç»“æœ)

Stateæ•°æ®é»˜è®¤ä¿å­˜åœ¨Javaçš„å †å†…å­˜ä¸­/TaskManageèŠ‚ç‚¹çš„å†…å­˜ä¸­

Stateå¯ä»¥è¢«è®°å½•ï¼Œåœ¨å¤±è´¥çš„æƒ…å†µä¸‹æ•°æ®è¿˜å¯ä»¥æ¢å¤ã€‚

**2.Checkpoint:**

â€‹    è¡¨ç¤ºäº†ä¸€ä¸ªFlinkJobåœ¨ä¸€ä¸ªç‰¹å®šæ—¶åˆ»çš„ä¸€ä»½å…¨å±€çŠ¶æ€å¿«ç…§ï¼Œå³åŒ…å«äº†æ‰€æœ‰Task/Operatorçš„çŠ¶æ€

â€‹    å¯ä»¥ç†è§£ä¸ºCheckpointæ˜¯æŠŠStateæ•°æ®å®šæ—¶æŒä¹…åŒ–å­˜å‚¨äº†

æ¯”å¦‚KafkaConsumerç®—å­ä¸­ç»´æŠ¤çš„OffsetçŠ¶æ€,å½“ä»»åŠ¡é‡æ–°æ¢å¤çš„æ—¶å€™å¯ä»¥ä»Checkpointä¸­è·å–ã€‚



> 31ã€ä»€ä¹ˆæ˜¯Savepoinä¿å­˜ç‚¹ï¼Ÿ

**ä¿å­˜ç‚¹**åœ¨ Flink ä¸­å«ä½œ **Savepoint**. æ˜¯åŸºäºFlink æ£€æŸ¥ç‚¹æœºåˆ¶çš„åº”ç”¨å®Œæ•´å¿«ç…§å¤‡ä»½æœºåˆ¶. ç”¨æ¥ä¿å­˜çŠ¶æ€ å¯ä»¥åœ¨å¦ä¸€ä¸ªé›†ç¾¤æˆ–è€…å¦ä¸€ä¸ªæ—¶é—´ç‚¹.ä»ä¿å­˜çš„çŠ¶æ€ä¸­å°†ä½œä¸šæ¢å¤å›æ¥ã€‚é€‚ç”¨ äºåº”ç”¨å‡çº§ã€é›†ç¾¤è¿ç§»ã€ Flink é›†ç¾¤ç‰ˆæœ¬æ›´æ–°ã€A/Bæµ‹è¯•ä»¥åŠå‡å®šåœºæ™¯ã€æš‚åœå’Œé‡å¯ã€å½’æ¡£ç­‰åœºæ™¯ã€‚ä¿å­˜ç‚¹å¯ä»¥è§†ä¸ºä¸€ä¸ª(ç®—å­ ID -> State) çš„Mapï¼Œå¯¹äºæ¯ä¸€ä¸ªæœ‰çŠ¶æ€çš„ç®—å­ï¼ŒKeyæ˜¯ç®—å­IDï¼ŒValueæ˜¯ç®—å­Stateã€‚

> 32ã€ä»€ä¹ˆæ˜¯CheckpointCoordinatoræ£€æŸ¥ç‚¹åè°ƒå™¨ï¼Ÿ

Flinkä¸­æ£€æŸ¥ç‚¹åè°ƒå™¨å«ä½œ **CheckpointCoordinator**ï¼Œè´Ÿè´£åè°ƒ Flink ç®—å­çš„ State çš„åˆ†å¸ƒå¼å¿«ç…§ã€‚å½“è§¦å‘å¿«ç…§çš„æ—¶å€™ï¼ŒCheckpointCoordinatorå‘ Source ç®—å­ä¸­æ³¨å…¥**Barrier**æ¶ˆæ¯ ï¼Œç„¶åç­‰å¾…æ‰€æœ‰çš„Taské€šçŸ¥æ£€æŸ¥ç‚¹ç¡®è®¤å®Œæˆï¼ŒåŒæ—¶æŒæœ‰æ‰€æœ‰ Task åœ¨ç¡®è®¤å®Œæˆæ¶ˆæ¯ä¸­ä¸ŠæŠ¥çš„Stateå¥æŸ„ã€‚



> 33ã€Checkpointä¸­ä¿å­˜çš„æ˜¯ä»€ä¹ˆä¿¡æ¯ï¼Ÿ

æ£€æŸ¥ç‚¹é‡Œé¢åˆ°åº•ä¿å­˜ç€ä»€ä¹ˆä¿¡æ¯å‘¢ï¼Ÿæˆ‘ä»¬ä»¥flinkæ¶ˆè´¹kafkaæ•°æ®wordcountä¸ºä¾‹ï¼š



1ã€æˆ‘ä»¬ä»Kafkaè¯»å–åˆ°ä¸€æ¡æ¡çš„æ—¥å¿—ï¼Œä»æ—¥å¿—ä¸­è§£æå‡ºapp_idï¼Œç„¶åå°†ç»Ÿè®¡çš„ç»“æœæ”¾åˆ°å†…å­˜ä¸­ä¸€ä¸ªMapé›†åˆï¼Œapp_idåšä¸ºkeyï¼Œå¯¹åº”çš„pvåšä¸ºvalueï¼Œæ¯æ¬¡åªéœ€è¦å°†ç›¸åº”app_id çš„pvå€¼+1åputåˆ°Mapä¸­å³å¯ï¼›

2ã€kafka topicï¼štestï¼›

3ã€flinkè¿ç®—æµç¨‹å¦‚ä¸‹ï¼š

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9ddd53e8-1257-11ec-948d-00163e068ecd.png)

kafka topicæœ‰ä¸”åªæœ‰ä¸€ä¸ªåˆ†åŒº

å‡è®¾kafkaçš„topic-teståªæœ‰ä¸€ä¸ªåˆ†åŒºï¼Œflinkçš„Source taskè®°å½•äº†å½“å‰æ¶ˆè´¹åˆ°kafka test topicçš„æ‰€æœ‰partitionçš„offset



```
ä¾‹ï¼šï¼ˆ0ï¼Œ1000ï¼‰è¡¨ç¤º0å·partitionç›®å‰æ¶ˆè´¹åˆ°offsetä¸º1000çš„æ•°æ®
```

**Flinkçš„pv taskè®°å½•äº†å½“å‰è®¡ç®—çš„å„appçš„pvå€¼ï¼Œä¸ºäº†æ–¹ä¾¿è®²è§£ï¼Œæˆ‘è¿™é‡Œæœ‰ä¸¤ä¸ªappï¼šapp1ã€app2**



```
ä¾‹ï¼šï¼ˆapp1ï¼Œ50000ï¼‰ï¼ˆapp2ï¼Œ10000ï¼‰
è¡¨ç¤ºapp1å½“å‰pvå€¼ä¸º50000
è¡¨ç¤ºapp2å½“å‰pvå€¼ä¸º10000
æ¯æ¥ä¸€æ¡æ•°æ®ï¼Œåªéœ€è¦ç¡®å®šç›¸åº”app_idï¼Œå°†ç›¸åº”çš„valueå€¼+1åputåˆ°mapä¸­å³å¯ï¼›
```



è¯¥æ¡ˆä¾‹ä¸­ï¼ŒCheckPointä¿å­˜çš„å…¶å®å°±æ˜¯**ç¬¬næ¬¡CheckPointæ¶ˆè´¹çš„offsetä¿¡æ¯å’Œå„appçš„pvå€¼ä¿¡æ¯**ï¼Œè®°å½•ä¸€ä¸‹å‘ç”ŸCheckPointå½“å‰çš„çŠ¶æ€ä¿¡æ¯ï¼Œå¹¶å°†è¯¥çŠ¶æ€ä¿¡æ¯ä¿å­˜åˆ°ç›¸åº”çš„çŠ¶æ€åç«¯ã€‚å›¾ä¸‹ä»£ç ï¼šï¼ˆ**æ³¨ï¼šçŠ¶æ€åç«¯æ˜¯ä¿å­˜çŠ¶æ€çš„åœ°æ–¹ï¼Œå†³å®šçŠ¶æ€å¦‚ä½•ä¿å­˜ï¼Œå¦‚ä½•ä¿éšœçŠ¶æ€é«˜å¯ç”¨**ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“ï¼Œæˆ‘ä»¬èƒ½ä»çŠ¶æ€åç«¯æ‹¿åˆ°offsetä¿¡æ¯å’Œpvä¿¡æ¯å³å¯ã€‚çŠ¶æ€åç«¯å¿…é¡»æ˜¯é«˜å¯ç”¨çš„ï¼Œå¦åˆ™æˆ‘ä»¬çš„çŠ¶æ€åç«¯ç»å¸¸å‡ºç°æ•…éšœï¼Œä¼šå¯¼è‡´æ— æ³•é€šè¿‡checkpointæ¥æ¢å¤æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼‰ã€‚



```
chk-100
offsetï¼šï¼ˆ0ï¼Œ1000ï¼‰
pvï¼šï¼ˆapp1ï¼Œ50000ï¼‰ï¼ˆapp2ï¼Œ10000ï¼‰
è¯¥çŠ¶æ€ä¿¡æ¯è¡¨ç¤ºç¬¬100æ¬¡CheckPointçš„æ—¶å€™ï¼Œ partition 0 offsetæ¶ˆè´¹åˆ°äº†1000ï¼Œpvç»Ÿè®¡
```

> 34ã€å½“ä½œä¸šå¤±è´¥åï¼Œæ£€æŸ¥ç‚¹å¦‚ä½•æ¢å¤ä½œä¸šï¼Ÿ

Flinkæä¾›äº† **åº”ç”¨è‡ªåŠ¨æ¢å¤æœºåˆ¶** å’Œ **æ‰‹åŠ¨ä½œä¸šæ¢å¤æœºåˆ¶**ã€‚



**åº”ç”¨è‡ªåŠ¨æ¢å¤æœºåˆ¶ï¼š**



Flinkè®¾ç½®æœ‰ä½œä¸šå¤±è´¥é‡å¯ç­–ç•¥ï¼ŒåŒ…å«ä¸‰ç§ï¼š

**1ã€å®šæœŸæ¢å¤ç­–ç•¥ï¼šfixed-delay**

å›ºå®šå»¶è¿Ÿé‡å¯ç­–ç•¥ä¼šå°è¯•ä¸€ä¸ªç»™å®šçš„æ¬¡æ•°æ¥é‡å¯Jobï¼Œå¦‚æœè¶…è¿‡æœ€å¤§çš„é‡å¯æ¬¡æ•°ï¼ŒJobæœ€ç»ˆå°†å¤±è´¥ï¼Œåœ¨è¿ç»­ä¸¤æ¬¡é‡å¯å°è¯•ä¹‹é—´ï¼Œé‡å¯ç­–ç•¥ä¼šç­‰å¾…ä¸€ä¸ªå›ºå®šæ—¶é—´ï¼Œé»˜è®¤Integer.MAX_VALUEæ¬¡

**2ã€å¤±è´¥æ¯”ç‡ç­–ç•¥ï¼šfailure-rate**

å¤±è´¥ç‡é‡å¯ç­–ç•¥åœ¨jobå¤±è´¥åé‡å¯ï¼Œä½†æ˜¯è¶…è¿‡å¤±è´¥ç‡åï¼ŒJobä¼šæœ€ç»ˆè¢«è®¤å®šå¤±è´¥ï¼Œåœ¨ä¸¤ä¸ªè¿ç»­çš„é‡å¯å°è¯•ä¹‹é—´ï¼Œé‡å¯ç­–ç•¥ä¼šç­‰å¾…ä¸€ä¸ªå›ºå®šçš„æ—¶é—´ã€‚



**3ã€ç›´æ¥å¤±è´¥ç­–ç•¥ï¼šNone  å¤±è´¥ä¸é‡å¯**



**æ‰‹åŠ¨ä½œä¸šæ¢å¤æœºåˆ¶**ã€‚



å› ä¸ºFlinkæ£€æŸ¥ç‚¹ç›®å½•åˆ†åˆ«å¯¹åº”çš„æ˜¯JobIdï¼Œæ¯é€šè¿‡flink run æ–¹å¼/é¡µé¢æäº¤æ–¹å¼æ¢å¤éƒ½ä¼šé‡æ–°ç”Ÿæˆ jobIdï¼ŒFlink æä¾›äº†åœ¨å¯åŠ¨ä¹‹æ—¶é€šè¿‡è®¾ç½® **-s** .å‚æ•°æŒ‡å®šæ£€æŸ¥ç‚¹ç›®å½•çš„åŠŸèƒ½ï¼Œè®©æ–°çš„ jobld è¯»å–è¯¥æ£€æŸ¥ç‚¹å…ƒæ–‡ä»¶ä¿¡æ¯å’ŒçŠ¶æ€ä¿¡æ¯ï¼Œä»è€Œè¾¾åˆ°æŒ‡å®šæ—¶é—´èŠ‚ç‚¹å¯åŠ¨ä½œä¸šçš„ç›®çš„ã€‚

å¯åŠ¨æ–¹å¼å¦‚ä¸‹ï¼š



```
/bin/flink -s flink/checkpoints/03112312a12398740a87393/chk-50/_metadata
```



> 35ã€å½“ä½œä¸šå¤±è´¥åï¼Œä»ä¿å­˜ç‚¹å¦‚ä½•æ¢å¤ä½œä¸šï¼Ÿ

ä»ä¿å­˜ç‚¹æ¢å¤ä½œä¸šå¹¶ä¸ç®€å•ï¼Œå°¤å…¶æ˜¯åœ¨ä½œä¸šå˜æ›´(å¦‚ä¿®æ”¹é€»è¾‘ã€ä¿®å¤ bug) çš„æƒ…å†µä¸‹ï¼Œ éœ€è¦è€ƒè™‘å¦‚ä¸‹å‡ ç‚¹:

**ï¼ˆ1ï¼‰ç®—å­çš„é¡ºåºæ”¹å˜** 

å¦‚æœå¯¹åº”çš„ UID æ²¡å˜ï¼Œåˆ™å¯ä»¥æ¢å¤ï¼Œå¦‚æœå¯¹åº”çš„ UID å˜äº†æ¢å¤å¤±è´¥ã€‚

**ï¼ˆ2ï¼‰ä½œä¸šä¸­æ·»åŠ äº†æ–°çš„ç®—å­** 

å¦‚æœæ˜¯æ— çŠ¶æ€ç®—å­ï¼Œæ²¡æœ‰å½±å“ï¼Œå¯ä»¥æ­£å¸¸æ¢å¤ï¼Œå¦‚æœæ˜¯æœ‰çŠ¶æ€çš„ç®—å­ï¼Œè·Ÿæ— çŠ¶æ€çš„ç®—å­ ä¸€æ ·å¤„ç†ã€‚

**ï¼ˆ3ï¼‰ä»ä½œä¸šä¸­åˆ é™¤äº†ä¸€ä¸ªæœ‰çŠ¶æ€çš„ç®—å­**

é»˜è®¤éœ€è¦æ¢å¤ä¿å­˜ç‚¹ä¸­æ‰€è®°å½•çš„æ‰€æœ‰ç®—å­çš„çŠ¶æ€ï¼Œå¦‚æœåˆ é™¤äº†ä¸€ä¸ªæœ‰çŠ¶æ€çš„ç®—å­ï¼Œä»ä¿å­˜ç‚¹å›å¤çš„æ—¶å€™è¢«åˆ é™¤çš„OperatorIDæ‰¾ä¸åˆ°ï¼Œæ‰€ä»¥ä¼šæŠ¥é”™ å¯ä»¥é€šè¿‡åœ¨å‘½ä»¤ä¸­æ·»åŠ  

-- allowNonReStoredSlale (short: -n ï¼‰è·³è¿‡æ— æ³•æ¢å¤çš„ç®—å­ ã€‚

**ï¼ˆ4ï¼‰æ·»åŠ å’Œåˆ é™¤æ— çŠ¶æ€çš„ç®—å­**

å¦‚æœæ‰‹åŠ¨è®¾ç½®äº† UID åˆ™å¯ä»¥æ¢å¤ï¼Œä¿å­˜ç‚¹ä¸­ä¸è®°å½•æ— çŠ¶æ€çš„ç®—å­ å¦‚æœæ˜¯è‡ªåŠ¨åˆ†é…çš„ UID ï¼Œé‚£ä¹ˆæœ‰çŠ¶æ€ç®—å­çš„å¯èƒ½ä¼šå˜( Flink ä¸€ä¸ªå•è°ƒé€’å¢çš„è®¡æ•°å™¨ç”Ÿæˆ UIDï¼ŒDAG æ”¹ç‰ˆï¼Œè®¡æ•°å™¨ææœ‰å¯èƒ½ä¼šå˜) å¾ˆæœ‰å¯èƒ½æ¢å¤å¤±è´¥ã€‚



> 36ã€Flinkå¦‚ä½•å®ç°è½»é‡çº§å¼‚æ­¥åˆ†å¸ƒå¼å¿«ç…§ï¼Ÿ

è¦å®ç°åˆ†å¸ƒå¼å¿«ç…§ï¼Œæœ€å…³é”®çš„æ˜¯èƒ½å¤Ÿå°†æ•°æ®æµåˆ‡åˆ†ã€‚**Flink ä¸­ä½¿ç”¨ Barrier (å±éšœ)æ¥åˆ‡åˆ†æ•°æ® æµã€‚** Barrierr ä¼šå‘¨æœŸæ€§åœ°æ³¨å…¥æ•°æ®æµä¸­ï¼Œä½œä¸ºæ•°æ®æµçš„ä¸€éƒ¨åˆ†ï¼Œä»ä¸Šæ¸¸åˆ°ä¸‹æ¸¸è¢«ç®—å­å¤„ç†ã€‚Barrier ä¼šä¸¥æ ¼ä¿è¯é¡ºåºï¼Œä¸ä¼šè¶…è¿‡å…¶å‰è¾¹çš„æ•°æ®ã€‚Barrier å°†è®°å½•åˆ†å‰²æˆè®°å½•é›†ï¼Œ**ä¸¤ä¸ª Barrier ä¹‹é—´çš„æ•°æ®æµä¸­çš„æ•°æ®éš¶å±äºåŒä¸€ä¸ªæ£€æŸ¥ç‚¹ã€‚æ¯ä¸€ä¸ª Barrier éƒ½æºå¸¦ä¸€ä¸ªå…¶æ‰€å±å¿«ç…§çš„ ID ç¼–å·ã€‚**Barrier éšç€æ•°æ®å‘ä¸‹æµåŠ¨ï¼Œä¸ä¼šæ‰“æ–­æ•°æ®æµï¼Œå› æ­¤éå¸¸è½»é‡ã€‚ åœ¨ä¸€ä¸ªæ•°æ®æµä¸­ï¼Œå¯èƒ½ä¼šå­˜åœ¨å¤šä¸ªéš¶å±äºä¸åŒå¿«ç…§çš„ Barrier ï¼Œå¹¶å‘å¼‚æ­¥åœ°æ‰§è¡Œåˆ†å¸ƒå¼å¿«ç…§ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9e094e62-1257-11ec-948d-00163e068ecd.png)



Barrier ä¼šåœ¨æ•°æ®æµæºå¤´è¢«æ³¨äººå¹¶è¡Œæ•°æ®æµä¸­ã€‚**Barrier næ‰€åœ¨çš„ä½ç½®å°±æ˜¯æ¢å¤æ—¶æ•°æ®é‡æ–°å¤„ç†çš„èµ·å§‹ä½ç½®ã€‚** ä¾‹å¦‚ï¼Œåœ¨Kafkaä¸­ï¼Œè¿™ä¸ªä½ç½®å°±æ˜¯æœ€åä¸€ä¸ªè®°å½•åœ¨åˆ†åŒºå†…çš„åç§»é‡ ( offset) ï¼Œä½œä¸šæ¢å¤æ—¶ï¼Œä¼šæ ¹æ®è¿™ä¸ªä½ç½®ä»è¿™ä¸ªåç§»é‡ä¹‹åå‘ kafka è¯·æ±‚æ•°æ® è¿™ä¸ªåç§»é‡å°±æ˜¯Stateä¸­ä¿å­˜çš„å†…å®¹ä¹‹ä¸€ã€‚



Barrier æ¥ç€å‘ä¸‹æ¸¸ä¼ é€’ã€‚å½“ä¸€ä¸ªéæ•°æ®æºç®—å­ä»æ‰€æœ‰çš„è¾“å…¥æµä¸­æ”¶åˆ°äº†å¿«ç…§ n çš„Barrieræ—¶ï¼Œè¯¥ç®—å­å°±ä¼šå¯¹è‡ªå·±çš„ State ä¿å­˜å¿«ç…§ï¼Œå¹¶å‘è‡ªå·±çš„ä¸‹æ¸¸ **å¹¿æ’­ å‘é€**å¿«ç…§ n çš„ Barrierã€‚ä¸€æ—¦Sink ç®—å­æ¥æ”¶åˆ° Barrier ï¼Œæœ‰ä¸¤ç§æƒ…å†µï¼š



**ï¼ˆ1ï¼‰å¦‚æœ****æ˜¯å¼•æ“å†…ä¸¥æ ¼ä¸€æ¬¡å¤„ç†ä¿è¯ï¼Œ**å½“ Sink ç®—å­å·²ç»æ”¶åˆ°äº†æ‰€æœ‰ä¸Šæ¸¸çš„ Barrie  n æ—¶ï¼Œ Sink ç®—å­å¯¹è‡ªå·±çš„ State è¿›è¡Œå¿«ç…§ï¼Œç„¶åé€šçŸ¥æ£€æŸ¥ç‚¹åè°ƒå™¨( CheckpointCoordinator) ã€‚å½“æ‰€æœ‰ çš„ç®—å­éƒ½å‘æ£€æŸ¥ç‚¹åè°ƒå™¨æ±‡æŠ¥æˆåŠŸä¹‹åï¼Œæ£€æŸ¥ç‚¹åè°ƒå™¨å‘æ‰€æœ‰çš„ç®—å­ç¡®è®¤æœ¬æ¬¡å¿«ç…§å®Œæˆã€‚

**ï¼ˆ2ï¼‰å¦‚æœæ˜¯ç«¯åˆ°ç«¯ä¸¥æ ¼ä¸€æ¬¡å¤„ç†ä¿è¯ï¼Œ**å½“ Sink ç®—å­å·²ç»æ”¶åˆ°äº†æ‰€æœ‰ä¸Šæ¸¸çš„ Barrie n æ—¶ï¼Œ Sink ç®—å­å¯¹è‡ªå·±çš„ State è¿›è¡Œå¿«ç…§ï¼Œ**å¹¶é¢„æäº¤äº‹åŠ¡ï¼ˆä¸¤é˜¶æ®µæäº¤çš„ç¬¬ä¸€é˜¶æ®µï¼‰**ï¼Œå†é€šçŸ¥æ£€æŸ¥ç‚¹åè°ƒå™¨( CheckpointCoordinator) ï¼Œæ£€æŸ¥ç‚¹åè°ƒå™¨å‘æ‰€æœ‰çš„ç®—å­ç¡®è®¤æœ¬æ¬¡å¿«ç…§å®Œæˆï¼ŒSink ç®—å­**æäº¤äº‹åŠ¡\**ï¼ˆä¸¤é˜¶æ®µæäº¤çš„ç¬¬äºŒé˜¶æ®µï¼‰\****ï¼Œæœ¬æ¬¡äº‹åŠ¡å®Œæˆã€‚



**æˆ‘ä»¬æ¥ç€** **33** **çš„æ¡ˆä¾‹æ¥å…·ä½“è¯´ä¸€ä¸‹å¦‚ä½•æ‰§è¡Œåˆ†å¸ƒå¼å¿«ç…§ï¼š**



**å¯¹åº”åˆ°pvæ¡ˆä¾‹ä¸­å°±æ˜¯**ï¼ŒSource Taskæ¥æ”¶åˆ°JobManagerçš„ç¼–å·ä¸º**chk-100ï¼ˆä»æœ€è¿‘ä¸€æ¬¡æ¢å¤ï¼‰**çš„CheckPointè§¦å‘è¯·æ±‚åï¼Œå‘ç°è‡ªå·±æ°å¥½æ¥æ”¶åˆ°kafka offsetï¼ˆ0ï¼Œ1000ï¼‰å¤„çš„æ•°æ®ï¼Œæ‰€ä»¥ä¼šå¾€offsetï¼ˆ0ï¼Œ1000ï¼‰æ•°æ®ä¹‹åoffsetï¼ˆ0ï¼Œ1001ï¼‰æ•°æ®ä¹‹å‰å®‰æ’ä¸€ä¸ªbarrierï¼Œç„¶åè‡ªå·±å¼€å§‹åšå¿«ç…§ï¼Œä¹Ÿå°±æ˜¯å°†offsetï¼ˆ0ï¼Œ1000ï¼‰ä¿å­˜åˆ°çŠ¶æ€åç«¯chk-100ä¸­ã€‚ç„¶åbarrieræ¥ç€å¾€ä¸‹æ¸¸å‘é€ï¼Œå½“ç»Ÿè®¡pvçš„taskæ¥æ”¶åˆ°barrieråï¼Œä¹Ÿä¼šæš‚åœå¤„ç†æ•°æ®ï¼Œå°†è‡ªå·±å†…å­˜ä¸­ä¿å­˜çš„pvä¿¡æ¯ï¼ˆapp1ï¼Œ50000ï¼‰ï¼ˆapp2ï¼Œ10000ï¼‰ä¿å­˜åˆ°çŠ¶æ€åç«¯chk-100ä¸­ã€‚OKï¼Œflinkå¤§æ¦‚å°±æ˜¯é€šè¿‡è¿™ä¸ªåŸç†æ¥ä¿å­˜å¿«ç…§çš„;

ç»Ÿè®¡pvçš„taskæ¥æ”¶åˆ°barrierï¼Œå°±æ„å‘³ç€barrierä¹‹å‰çš„æ•°æ®éƒ½å¤„ç†äº†ï¼Œæ‰€ä»¥è¯´ï¼Œä¸ä¼šå‡ºç°ä¸¢æ•°æ®çš„æƒ…å†µã€‚

> 37ã€ä»€ä¹ˆæ˜¯Barrierå¯¹é½ï¼Ÿ



![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9e2e780e-1257-11ec-948d-00163e068ecd.png)



![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9e4c8aba-1257-11ec-948d-00163e068ecd.png)

â€‹           

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9e76ec24-1257-11ec-948d-00163e068ecd.png)



ä¸€æ—¦Operatorä»è¾“å…¥æµæ¥æ”¶åˆ°CheckPoint barrier nï¼Œå®ƒå°±ä¸èƒ½å¤„ç†æ¥è‡ªè¯¥æµçš„ä»»ä½•æ•°æ®è®°å½•ï¼Œç›´åˆ°å®ƒä»å…¶ä»–æ‰€æœ‰è¾“å…¥æ¥æ”¶åˆ°barrier nä¸ºæ­¢ã€‚å¦åˆ™ï¼Œå®ƒä¼šæ··åˆå±äºå¿«ç…§nçš„è®°å½•å’Œå±äºå¿«ç…§n + 1çš„è®°å½•ï¼›

**å¦‚ä¸Šå›¾æ‰€ç¤ºï¼š**

å›¾1ï¼Œç®—å­æ”¶åˆ°æ•°å­—æµçš„Barrier,å­—æ¯æµå¯¹åº”çš„barrierå°šæœªåˆ°è¾¾

å›¾2ï¼Œç®—å­æ”¶åˆ°æ•°å­—æµçš„Barrier,ä¼šç»§ç»­ä»æ•°å­—æµä¸­æ¥æ”¶æ•°æ®ï¼Œä½†è¿™äº›æµåªèƒ½è¢«æç½®ï¼Œè®°å½•ä¸èƒ½è¢«å¤„ç†ï¼Œè€Œæ˜¯æ”¾å…¥ç¼“å­˜ä¸­ï¼Œç­‰å¾…å­—æ¯æµ Barrieråˆ°è¾¾ã€‚åœ¨å­—æ¯æµåˆ°è¾¾å‰ï¼Œ 1ï¼Œ2ï¼Œ3æ•°æ®å·²ç»è¢«ç¼“å­˜ã€‚

å›¾3ï¼Œå­—æ¯æµåˆ°è¾¾ï¼Œç®—å­å¼€å§‹å¯¹é½Stateè¿›è¡Œå¼‚æ­¥å¿«ç…§ï¼Œå¹¶å°†Barrierå‘ä¸‹æ¸¸å¹¿æ’­ï¼Œå¹¶ä¸ç­‰å¾…å¿«ç…§æ‰§è¡Œå®Œæ¯•ã€‚

å›¾4ï¼Œç®—å­åšå¼‚æ­¥å¿«ç…§ï¼Œé¦–å…ˆå¤„ç†ç¼“å­˜ä¸­ç§¯å‹æ•°æ®ï¼Œç„¶åå†ä»è¾“å…¥é€šé“ä¸­è·å–æ•°æ®ã€‚



> 38ã€ä»€ä¹ˆæ˜¯Barrierä¸å¯¹é½ï¼Ÿ

checkpoint æ˜¯è¦ç­‰åˆ°æ‰€æœ‰çš„barrierå…¨éƒ¨éƒ½åˆ°æ‰ç®—å®Œæˆ

ä¸Šè¿°å›¾2ä¸­ï¼Œå½“è¿˜æœ‰å…¶ä»–è¾“å…¥æµçš„barrierè¿˜æ²¡æœ‰åˆ°è¾¾æ—¶ï¼Œä¼šæŠŠå·²åˆ°è¾¾çš„barrierä¹‹åçš„æ•°æ®1ã€2ã€3æç½®åœ¨ç¼“å†²åŒºï¼Œç­‰å¾…å…¶ä»–æµçš„barrieråˆ°è¾¾åæ‰èƒ½å¤„ç†ã€‚



**barrierä¸å¯¹é½ï¼š****å°±æ˜¯æŒ‡å½“è¿˜æœ‰å…¶ä»–æµçš„barrierè¿˜æ²¡åˆ°è¾¾æ—¶ï¼Œä¸ºäº†ä¸å½±å“æ€§èƒ½ï¼Œä¹Ÿä¸ç”¨ç†ä¼šï¼Œç›´æ¥å¤„ç†barrierä¹‹åçš„æ•°æ®ã€‚ç­‰åˆ°æ‰€æœ‰æµçš„barrierçš„éƒ½åˆ°è¾¾åï¼Œå°±å¯ä»¥å¯¹è¯¥OperatoråšCheckPointäº†ï¼›**

> 39ã€ä¸ºä»€ä¹ˆè¦è¿›è¡Œbarrierå¯¹é½ï¼Ÿä¸å¯¹é½åˆ°åº•è¡Œä¸è¡Œï¼Ÿ

ç­”ï¼šExactly Onceæ—¶å¿…é¡»barrierå¯¹é½ï¼Œå¦‚æœbarrierä¸å¯¹é½å°±å˜æˆäº†At Least Onceï¼›



**CheckPointçš„ç›®çš„å°±æ˜¯ä¸ºäº†ä¿å­˜å¿«ç…§**ï¼Œå¦‚æœä¸å¯¹é½ï¼Œé‚£ä¹ˆåœ¨chk-100å¿«ç…§ä¹‹å‰ï¼Œå·²ç»å¤„ç†äº†ä¸€äº›chk-100 å¯¹åº”çš„offsetä¹‹åçš„æ•°æ®ï¼Œå½“ç¨‹åºä»chk-100æ¢å¤ä»»åŠ¡æ—¶ï¼Œchk-100å¯¹åº”çš„offsetä¹‹åçš„æ•°æ®è¿˜ä¼šè¢«å¤„ç†ä¸€æ¬¡ï¼Œæ‰€ä»¥å°±å‡ºç°äº†é‡å¤æ¶ˆè´¹ã€‚

> 40ã€Flinkæ”¯æŒExactly-Onceè¯­ä¹‰ï¼Œé‚£ä»€ä¹ˆæ˜¯Exactly-Onceï¼Ÿ

Exactly-Onceè¯­ä¹‰ : æŒ‡**ç«¯åˆ°ç«¯**çš„ä¸€è‡´æ€§ï¼Œä»**æ•°æ®è¯»å–**ã€**å¼•æ“è®¡ç®—**ã€**å†™å…¥å¤–éƒ¨å­˜å‚¨çš„**æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œ**å³ä½¿æœºå™¨æˆ–è½¯ä»¶å‡ºç°æ•…éšœï¼Œ**éƒ½ç¡®ä¿æ•°æ®ä»…å¤„ç†ä¸€æ¬¡ï¼Œä¸ä¼šé‡å¤ã€ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚



> 41ã€è¦å®ç°Exactly-Once,éœ€å…·å¤‡ä»€ä¹ˆæ¡ä»¶ï¼Ÿ

æµç³»ç»Ÿè¦å®ç°Exactly-Onceï¼Œéœ€è¦ä¿è¯ä¸Šæ¸¸ Source å±‚ã€ä¸­é—´è®¡ç®—å±‚å’Œä¸‹æ¸¸ Sink å±‚ä¸‰éƒ¨åˆ†åŒæ—¶æ»¡è¶³**ç«¯åˆ°ç«¯ä¸¥æ ¼ä¸€æ¬¡å¤„ç†ï¼Œå¦‚ä¸‹å›¾ï¼š**



![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9e98676e-1257-11ec-948d-00163e068ecd.png)

Flinkç«¯åˆ°ç«¯ä¸¥æ ¼ä¸€æ¬¡å¤„ç†



**Sourceç«¯ï¼š**æ•°æ®ä»ä¸Šæ¸¸è¿›å…¥Flinkï¼Œå¿…é¡»ä¿è¯æ¶ˆæ¯ä¸¥æ ¼ä¸€æ¬¡æ¶ˆè´¹ã€‚åŒæ—¶Source ç«¯å¿…é¡»æ»¡è¶³å¯é‡æ”¾ï¼ˆreplayï¼‰ã€‚å¦åˆ™ Flink è®¡ç®—å±‚æ”¶åˆ°æ¶ˆæ¯åæœªè®¡ç®—ï¼Œå´å‘ç”Ÿ failure è€Œé‡å¯ï¼Œæ¶ˆæ¯å°±ä¼šä¸¢å¤±ã€‚



**Flinkè®¡ç®—å±‚ï¼š**åˆ©ç”¨ Checkpoint æœºåˆ¶ï¼ŒæŠŠçŠ¶æ€æ•°æ®å®šæœŸæŒä¹…åŒ–å­˜å‚¨ä¸‹æ¥ï¼ŒFlinkç¨‹åºä¸€æ—¦å‘ç”Ÿæ•…éšœçš„æ—¶å€™ï¼Œå¯ä»¥é€‰æ‹©çŠ¶æ€ç‚¹æ¢å¤ï¼Œé¿å…æ•°æ®çš„ä¸¢å¤±ã€é‡å¤ã€‚



**Sinkç«¯ï¼š**Flinkå°†å¤„ç†å®Œçš„æ•°æ®å‘é€åˆ°Sinkç«¯æ—¶ï¼Œé€šè¿‡ **ä¸¤é˜¶æ®µæäº¤åè®® ï¼Œ**å³ TwoPhaseCommitSinkFunction å‡½æ•°ã€‚è¯¥ SinkFunction æå–å¹¶å°è£…äº†ä¸¤é˜¶æ®µæäº¤åè®®ä¸­çš„å…¬å…±é€»è¾‘ï¼Œä¿è¯Flink å‘é€Sinkç«¯æ—¶å®ç°ä¸¥æ ¼ä¸€æ¬¡å¤„ç†è¯­ä¹‰ã€‚  **åŒæ—¶ï¼š**Sinkç«¯å¿…é¡»æ”¯æŒ**äº‹åŠ¡æœºåˆ¶**ï¼Œèƒ½å¤Ÿè¿›è¡Œæ•°æ®**å›æ»š**æˆ–è€…æ»¡è¶³**å¹‚ç­‰æ€§ã€‚**



**å›æ»šæœºåˆ¶ï¼š**å³å½“ä½œä¸šå¤±è´¥åï¼Œèƒ½å¤Ÿå°†éƒ¨åˆ†å†™å…¥çš„ç»“æœå›æ»šåˆ°ä¹‹å‰å†™å…¥çš„çŠ¶æ€ã€‚



**å¹‚ç­‰æ€§ï¼š**å°±æ˜¯ä¸€ä¸ªç›¸åŒçš„æ“ä½œï¼Œæ— è®ºé‡å¤å¤šå°‘æ¬¡ï¼Œé€ æˆçš„ç»“æœå’Œåªæ“ä½œä¸€æ¬¡ç›¸ç­‰ã€‚å³å½“ä½œä¸šå¤±è´¥åï¼Œå†™å…¥éƒ¨åˆ†ç»“æœï¼Œä½†æ˜¯å½“é‡æ–°å†™å…¥å…¨éƒ¨ç»“æœæ—¶ï¼Œä¸ä¼šå¸¦æ¥è´Ÿé¢ç»“æœï¼Œé‡å¤å†™å…¥ä¸ä¼šå¸¦æ¥é”™è¯¯ç»“æœã€‚



> 42ã€ä»€ä¹ˆæ˜¯ä¸¤é˜¶æ®µæäº¤åè®®ï¼Ÿ

**ä¸¤é˜¶æ®µæäº¤åè®®ï¼ˆTwo -Phase Commitï¼Œ2PCï¼‰æ˜¯è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜æœ€å¸¸ç”¨çš„æ–¹æ³•ï¼Œå®ƒå¯ä»¥ä¿è¯åœ¨åˆ†å¸ƒå¼äº‹åŠ¡ä¸­ï¼Œ****è¦ä¹ˆæ‰€æœ‰å‚ä¸è¿›ç¨‹éƒ½æäº¤äº‹åŠ¡ï¼Œè¦ä¹ˆéƒ½å–æ¶ˆ****ï¼Œå³å®ç°ACIDä¸­çš„ Aï¼ˆåŸå­æ€§ï¼‰ã€‚**



ä¸¤é˜¶æ®µæäº¤åè®®ä¸­ æœ‰ä¸¤ä¸ªé‡è¦è§’è‰²**ï¼Œåè°ƒè€…ï¼ˆCoordinatorï¼‰**å’Œ **å‚ä¸è€…ï¼ˆParticipantï¼‰**,å…¶ä¸­åè°ƒè€…åªæœ‰ä¸€ä¸ªï¼Œèµ·åˆ°åˆ†å¸ƒå¼äº‹åŠ¡çš„åè°ƒç®¡ç†ä½œç”¨ï¼Œå‚ä¸è€…æœ‰å¤šä¸ªã€‚


ä¸¤é˜¶æ®µæäº¤é˜¶æ®µåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š**æŠ•ç¥¨é˜¶æ®µï¼ˆVotingï¼‰**å’Œ **æäº¤é˜¶æ®µï¼ˆCommitï¼‰ã€‚**



**æŠ•ç¥¨é˜¶æ®µï¼š
**



ï¼ˆ1ï¼‰åè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…**å‘é€ prepare è¯·æ±‚**å’Œäº‹åŠ¡å†…å®¹ï¼Œè¯¢é—®æ˜¯å¦å¯ä»¥å‡†å¤‡äº‹åŠ¡æäº¤ï¼Œç­‰å¾…å‚ä¸è€…çš„ç›¸åº”ã€‚

ï¼ˆ2ï¼‰å‚ä¸è€…æ‰§è¡Œäº‹åŠ¡ä¸­åŒ…å«çš„æ“ä½œï¼Œå¹¶è®°å½• undo æ—¥å¿—ï¼ˆç”¨äºå›æ»šï¼‰å’Œ redo æ—¥å¿—ï¼ˆç”¨äºé‡æ”¾ï¼‰ï¼Œä½†ä¸çœŸæ­£æäº¤ã€‚

ï¼ˆ3ï¼‰å‚ä¸è€…å‘åè°ƒè€…è¿”å›äº‹åŠ¡æ“ä½œçš„æ‰§è¡Œç»“æœï¼Œæ‰§è¡ŒæˆåŠŸè¿”å›yesï¼Œå¤±è´¥è¿”å›noã€‚



**æäº¤é˜¶æ®µï¼š**



åˆ†ä¸ºæˆåŠŸä¸å¤±è´¥ä¸¤ç§æƒ…å†µã€‚

è‹¥æ‰€æœ‰å‚ä¸è€…éƒ½è¿”å› yesï¼Œè¯´æ˜äº‹åŠ¡å¯ä»¥æäº¤ï¼š

- åè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€ commit è¯·æ±‚ã€‚
- å‚ä¸è€…æ”¶åˆ° commit è¯·æ±‚åï¼Œå°†äº‹åŠ¡çœŸæ­£åœ°æäº¤ä¸Šå»ï¼Œå¹¶é‡Šæ”¾å ç”¨çš„äº‹åŠ¡èµ„æºï¼Œå¹¶å‘åè°ƒè€…è¿”å› ack ã€‚
- åè°ƒè€…æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…çš„ ack æ¶ˆæ¯ï¼Œäº‹åŠ¡æˆåŠŸå®Œæˆï¼Œå¦‚ä¸‹å›¾ï¼š

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9ebc0b60-1257-11ec-948d-00163e068ecd.png)

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9edb9674-1257-11ec-948d-00163e068ecd.png)

è‹¥æœ‰å‚ä¸è€…è¿”å› no æˆ–è€…è¶…æ—¶æœªè¿”å›ï¼Œè¯´æ˜äº‹åŠ¡ä¸­æ–­ï¼Œéœ€è¦å›æ»šï¼š

- åè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€rollbackè¯·æ±‚ã€‚
- å‚ä¸è€…æ”¶åˆ°rollbackè¯·æ±‚åï¼Œæ ¹æ®undoæ—¥å¿—å›æ»šåˆ°äº‹åŠ¡æ‰§è¡Œå‰çš„çŠ¶æ€ï¼Œé‡Šæ”¾å ç”¨çš„äº‹åŠ¡èµ„æºï¼Œå¹¶å‘åè°ƒè€…è¿”å›ackã€‚
- åè°ƒè€…æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…çš„ackæ¶ˆæ¯ï¼Œäº‹åŠ¡å›æ»šå®Œæˆã€‚

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9f026c5e-1257-11ec-948d-00163e068ecd.png)

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9f2221ac-1257-11ec-948d-00163e068ecd.png)



> 43ã€Flink å¦‚ä½•ä¿è¯ Exactly-Once è¯­ä¹‰ï¼Ÿ

Flinké€šè¿‡ä¸¤é˜¶æ®µæäº¤åè®®æ¥ä¿è¯Exactly-Onceè¯­ä¹‰ã€‚



**å¯¹äºSourceç«¯ï¼š**Sourceç«¯ä¸¥æ ¼ä¸€æ¬¡å¤„ç†æ¯”è¾ƒç®€å•ï¼Œå› ä¸ºæ•°æ®è¦è¿›å…¥Flink ä¸­ï¼Œæ‰€ä»¥Flink åªéœ€è¦ä¿å­˜æ¶ˆè´¹æ•°æ®çš„åç§»é‡ ï¼ˆoffsetï¼‰å³å¯ã€‚å¦‚æœSourceç«¯ä¸º kafkaï¼ŒFlink å°† Kafka Consumer ä½œä¸º Sourceï¼Œå¯ä»¥å°†åç§»é‡ä¿å­˜ä¸‹æ¥ï¼Œå¦‚æœåç»­ä»»åŠ¡å‡ºç°äº†æ•…éšœï¼Œæ¢å¤çš„æ—¶å€™å¯ä»¥ç”±è¿æ¥å™¨é‡ç½®åç§»é‡ï¼Œé‡æ–°æ¶ˆè´¹æ•°æ®ï¼Œä¿è¯ä¸€è‡´æ€§ã€‚



**å¯¹äº Sink ç«¯ï¼š**Sink ç«¯æ˜¯æœ€å¤æ‚çš„ï¼Œå› ä¸ºæ•°æ®æ˜¯è½åœ°åˆ°å…¶ä»–ç³»ç»Ÿä¸Šçš„ï¼Œæ•°æ®ä¸€æ—¦ç¦»å¼€ Flink ä¹‹åï¼ŒFlink å°±ç›‘æ§ä¸åˆ°è¿™äº›æ•°æ®äº†ï¼Œæ‰€ä»¥ä¸¥æ ¼ä¸€æ¬¡å¤„ç†è¯­ä¹‰å¿…é¡»ä¹Ÿè¦åº”ç”¨äº Flink å†™å…¥æ•°æ®çš„å¤–éƒ¨ç³»ç»Ÿï¼Œ**æ•…è¿™äº›å¤–éƒ¨ç³»ç»Ÿå¿…é¡»æä¾›ä¸€ç§æ‰‹æ®µå…è®¸æäº¤æˆ–å›æ»šè¿™äº›å†™å…¥æ“ä½œ**ï¼ŒåŒæ—¶è¿˜è¦ä¿è¯ä¸ Flink Checkpoint èƒ½å¤Ÿåè°ƒä½¿ç”¨ï¼ˆ**Kafka 0.11 ç‰ˆæœ¬å·²ç»å®ç°ç²¾ç¡®ä¸€æ¬¡å¤„ç†è¯­ä¹‰**ï¼‰ã€‚


æˆ‘ä»¬ä»¥ **Kafka - Flink -Kafka** ä¸ºä¾‹ è¯´æ˜å¦‚ä½•ä¿è¯Exactly-Onceè¯­ä¹‰ã€‚



![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9f4213e0-1257-11ec-948d-00163e068ecd.png)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼šFlinkä½œä¸šåŒ…å«ä»¥ä¸‹ç®—å­ã€‚

ï¼ˆ1ï¼‰ä¸€ä¸ªSourceç®—å­ï¼Œä»Kafkaä¸­è¯»å–æ•°æ®ï¼ˆå³KafkaConsumerï¼‰

ï¼ˆ2ï¼‰ä¸€ä¸ªçª—å£ç®—å­ï¼ŒåŸºäºæ—¶é—´çª—å£åŒ–çš„èšåˆè¿ç®—ï¼ˆå³window+windowå‡½æ•°ï¼‰

ï¼ˆ3ï¼‰ä¸€ä¸ªSinkç®—å­ï¼Œå°†ç»“æœå†™ä¼šåˆ°Kafkaï¼ˆå³kafkaProducerï¼‰



Flinkä½¿ç”¨ä¸¤é˜¶æ®µæäº¤åè®® **é¢„æäº¤ï¼ˆPre-commitï¼‰**é˜¶æ®µå’Œ **æäº¤ï¼ˆCommitï¼‰é˜¶æ®µä¿è¯ç«¯åˆ°ç«¯ä¸¥æ ¼ä¸€æ¬¡ã€‚**

**ï¼ˆ1ï¼‰é¢„æäº¤é˜¶æ®µ**

**1ã€å½“Checkpoint å¯åŠ¨æ—¶ï¼Œè¿›å…¥é¢„æäº¤é˜¶æ®µ**ï¼ŒJobManager å‘Source Task æ³¨å…¥æ£€æŸ¥ç‚¹åˆ†ç•Œçº¿ï¼ˆCheckpointBarrierï¼‰,Source Task å°† CheckpointBarrier æ’å…¥æ•°æ®æµï¼Œå‘ä¸‹æ¸¸å¹¿æ’­å¼€å¯æœ¬æ¬¡å¿«ç…§ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š



![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9f6f1b6a-1257-11ec-948d-00163e068ecd.png)

é¢„å¤„ç†é˜¶æ®µï¼š Checkpoint å¯åŠ¨

**2ã€Source ç«¯ï¼š****Flink Data Source è´Ÿè´£ä¿å­˜ KafkaTopic çš„ offsetåç§»é‡**ï¼Œå½“ Checkpoint æˆåŠŸæ—¶ Flink è´Ÿè´£æäº¤è¿™äº›å†™å…¥ï¼Œå¦åˆ™å°±ç»ˆæ­¢å–æ¶ˆæ‰å®ƒä»¬ï¼Œå½“ Checkpoint å®Œæˆä½ç§»ä¿å­˜ï¼Œå®ƒä¼šå°† checkpoint barrierï¼ˆæ£€æŸ¥ç‚¹åˆ†ç•Œçº¿ï¼‰ ä¼ ç»™ä¸‹ä¸€ä¸ª Operatorï¼Œç„¶åæ¯ä¸ªç®—å­ä¼šå¯¹å½“å‰çš„çŠ¶æ€åšä¸ªå¿«ç…§ï¼Œä¿å­˜åˆ°**çŠ¶æ€åç«¯ï¼ˆState Backendï¼‰**ã€‚

**å¯¹äº Source ä»»åŠ¡è€Œè¨€ï¼Œå°±ä¼šæŠŠå½“å‰çš„ offset ä½œä¸ºçŠ¶æ€ä¿å­˜èµ·æ¥ã€‚ä¸‹æ¬¡ä» Checkpoint æ¢å¤æ—¶ï¼ŒSource ä»»åŠ¡å¯ä»¥é‡æ–°æäº¤åç§»é‡ï¼Œä»ä¸Šæ¬¡ä¿å­˜çš„ä½ç½®å¼€å§‹é‡æ–°æ¶ˆè´¹æ•°æ®ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š**

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9f99f1d2-1257-11ec-948d-00163e068ecd.png)

é¢„å¤„ç†é˜¶æ®µï¼šcheckpoint barrierä¼ é€’ åŠ offset ä¿å­˜

**3ã€Slink ç«¯ï¼š**ä» Source ç«¯å¼€å§‹ï¼Œæ¯ä¸ªå†…éƒ¨çš„ transformation ä»»åŠ¡é‡åˆ° checkpoint barrierï¼ˆæ£€æŸ¥ç‚¹åˆ†ç•Œçº¿ï¼‰æ—¶ï¼Œéƒ½ä¼šæŠŠçŠ¶æ€å­˜åˆ° Checkpoint é‡Œã€‚æ•°æ®å¤„ç†å®Œæ¯•åˆ° Sink ç«¯æ—¶ï¼ŒSink ä»»åŠ¡é¦–å…ˆæŠŠæ•°æ®å†™å…¥å¤–éƒ¨ Kafkaï¼Œ**è¿™äº›æ•°æ®éƒ½å±äºé¢„æäº¤çš„äº‹åŠ¡ï¼ˆè¿˜ä¸èƒ½è¢«æ¶ˆè´¹ï¼‰**ï¼Œ**æ­¤æ—¶çš„ Pre-commit é¢„æäº¤é˜¶æ®µä¸‹Data Sink åœ¨ä¿å­˜çŠ¶æ€åˆ°çŠ¶æ€åç«¯çš„åŒæ—¶è¿˜å¿…é¡»é¢„æäº¤å®ƒçš„å¤–éƒ¨äº‹åŠ¡ï¼Œ**å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9fbb3fea-1257-11ec-948d-00163e068ecd.png)

é¢„å¤„ç†é˜¶æ®µï¼šé¢„æäº¤åˆ°å¤–éƒ¨ç³»ç»Ÿ

**ï¼ˆ2ï¼‰æäº¤é˜¶æ®µ**

**4ã€å½“æ‰€æœ‰ç®—å­ä»»åŠ¡çš„å¿«ç…§å®Œæˆ**ï¼ˆæ‰€æœ‰åˆ›å»ºçš„å¿«ç…§éƒ½è¢«è§†ä¸ºæ˜¯ Checkpoint çš„ä¸€éƒ¨åˆ†ï¼‰ï¼Œ**ä¹Ÿå°±æ˜¯è¿™æ¬¡çš„ Checkpoint å®Œæˆæ—¶**ï¼Œ**JobManager ä¼šå‘æ‰€æœ‰ä»»åŠ¡å‘é€šçŸ¥ï¼Œç¡®è®¤è¿™æ¬¡ Checkpoint å®Œæˆï¼Œæ­¤æ—¶ Pre-commit é¢„æäº¤é˜¶æ®µæ‰ç®—å®Œæˆ**ã€‚æ‰æ­£å¼åˆ°ä¸¤é˜¶æ®µæäº¤åè®®çš„**ç¬¬äºŒä¸ªé˜¶æ®µï¼š****commit é˜¶æ®µ**ã€‚è¯¥é˜¶æ®µä¸­ JobManager ä¼šä¸ºåº”ç”¨ä¸­æ¯ä¸ª Operator å‘èµ· Checkpoint å·²å®Œæˆçš„å›è°ƒé€»è¾‘ã€‚



æœ¬ä¾‹ä¸­çš„ Data Source å’Œçª—å£æ“ä½œæ— å¤–éƒ¨çŠ¶æ€ï¼Œå› æ­¤åœ¨è¯¥é˜¶æ®µï¼Œè¿™ä¸¤ä¸ª Opeartor æ— éœ€æ‰§è¡Œä»»ä½•é€»è¾‘ï¼Œ**ä½†æ˜¯ Data Sink æ˜¯æœ‰å¤–éƒ¨çŠ¶æ€çš„ï¼Œæ­¤æ—¶æˆ‘ä»¬å¿…é¡»æäº¤å¤–éƒ¨äº‹åŠ¡**ï¼Œå½“ Sink ä»»åŠ¡æ”¶åˆ°ç¡®è®¤é€šçŸ¥ï¼Œå°±ä¼šæ­£å¼æäº¤ä¹‹å‰çš„äº‹åŠ¡ï¼ŒKafka ä¸­æœªç¡®è®¤çš„æ•°æ®å°±æ”¹ä¸ºâ€œå·²ç¡®è®¤â€ï¼Œæ•°æ®å°±çœŸæ­£å¯ä»¥è¢«æ¶ˆè´¹äº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9fe5ea56-1257-11ec-948d-00163e068ecd.png)

æäº¤é˜¶æ®µï¼šæ•°æ®ç²¾å‡†è¢«æ¶ˆè´¹

æ³¨ï¼šFlink ç”± JobManager åè°ƒå„ä¸ª TaskManager è¿›è¡Œ Checkpoint å­˜å‚¨ï¼ŒCheckpoint ä¿å­˜åœ¨ StateBackendï¼ˆçŠ¶æ€åç«¯ï¼‰ ä¸­ï¼Œé»˜è®¤ StateBackend æ˜¯å†…å­˜çº§çš„ï¼Œä¹Ÿå¯ä»¥æ”¹ä¸ºæ–‡ä»¶çº§çš„è¿›è¡ŒæŒä¹…åŒ–ä¿å­˜ã€‚

> 44ã€æ•°çš„å¾ˆå¥½ï¼Œå¾ˆæ¸…æ¥šï¼Œé‚£ä½ å¯¹Flink ç«¯åˆ°ç«¯ ä¸¥æ ¼ä¸€æ¬¡Exactly-Once è¯­ä¹‰åšä¸ªæ€»ç»“

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a005d438-1257-11ec-948d-00163e068ecd.png)

å¦‚æœè§‰å¾—é˜¿å‘¨è®²è§£çš„çŸ¥è¯†ç‚¹è¿˜æ»¡æ„çš„è¯ï¼Œè¯·å…³æ³¨å…¬ä¼—å·ï¼š**3åˆ†é’Ÿç§’æ‡‚å¤§æ•°æ®**ï¼Œè·å–æ›´å¤šï¼Œæ›´å…¨é¢çš„æŠ€æœ¯åšæ–‡ã€‚å¹¶åŠ åšä¸»å¾®ä¿¡ï¼š**threeknowbigdataï¼Œ**æ‹‰ä½ è¿›å¤§æ•°æ®äº¤æµç¾¤ã€‚

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_9c1a3238-1257-11ec-948d-00163e068ecd.png)

> 45ã€Flinkå¹¿æ’­æœºåˆ¶äº†è§£å—ï¼Ÿ

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a05deab0-1257-11ec-948d-00163e068ecd.png)



ï¼ˆ1ï¼‰ä»å›¾ä¸­å¯ä»¥ç†è§£ **å¹¿æ’­** å°±æ˜¯ä¸€ä¸ª**å…¬å…±çš„å…±äº«å˜é‡ï¼Œ**å¹¿æ’­å˜é‡æ˜¯å‘ç»™**TaskManagerçš„å†…å­˜ä¸­ï¼Œ**æ‰€ä»¥å¹¿æ’­å˜é‡ä¸åº”è¯¥å¤ªå¤§ï¼Œå°†ä¸€ä¸ªæ•°æ®é›†å¹¿æ’­åï¼Œä¸åŒçš„**Task**éƒ½å¯ä»¥åœ¨èŠ‚ç‚¹ä¸Šè·å–åˆ°ï¼Œæ¯ä¸ªèŠ‚ç‚¹åªå­˜ä¸€ä»½ã€‚ å¦‚æœä¸ä½¿ç”¨å¹¿æ’­ï¼Œæ¯ä¸€ä¸ªTaskéƒ½ä¼šæ‹·è´ä¸€ä»½æ•°æ®é›†ï¼Œé€ æˆå†…å­˜èµ„æºæµªè´¹ ã€‚



> 46ã€Flinkåå‹äº†è§£å—ï¼Ÿ

åå‹ï¼ˆbackpressureï¼‰æ˜¯å®æ—¶è®¡ç®—åº”ç”¨å¼€å‘ä¸­ï¼Œç‰¹åˆ«æ˜¯æµå¼è®¡ç®—ä¸­ï¼Œååˆ†å¸¸è§çš„é—®é¢˜ã€‚**åå‹**æ„å‘³ç€æ•°æ®ç®¡é“ä¸­æŸä¸ªèŠ‚ç‚¹æˆä¸ºç“¶é¢ˆï¼Œ**ä¸‹æ¸¸å¤„ç†é€Ÿç‡** **è·Ÿä¸ä¸Š** **ä¸Šæ¸¸å‘é€æ•°æ®çš„é€Ÿç‡**ï¼Œè€Œéœ€è¦å¯¹ä¸Šæ¸¸è¿›è¡Œé™é€Ÿã€‚ç”±äºå®æ—¶è®¡ç®—åº”ç”¨é€šå¸¸ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—æ¥è¿›è¡Œç”Ÿäº§ç«¯å’Œæ¶ˆè´¹ç«¯çš„è§£è€¦ï¼Œæ¶ˆè´¹ç«¯æ•°æ®æºæ˜¯ pull-based çš„ï¼Œæ‰€ä»¥åå‹é€šå¸¸æ˜¯ä»æŸä¸ªèŠ‚ç‚¹ä¼ å¯¼è‡³æ•°æ®æºå¹¶é™ä½æ•°æ®æºï¼ˆæ¯”å¦‚ Kafka consumerï¼‰çš„æ‘„å…¥é€Ÿç‡ã€‚

ç®€å•æ¥è¯´å°±æ˜¯**ä¸‹æ¸¸å¤„ç†é€Ÿç‡** **è·Ÿä¸ä¸Š** **ä¸Šæ¸¸å‘é€æ•°æ®çš„é€Ÿç‡**ï¼Œä¸‹æ¸¸æ¥ä¸åŠæ¶ˆè´¹ï¼Œå¯¼è‡´é˜Ÿåˆ—è¢«å æ»¡åï¼Œä¸Šæ¸¸çš„ç”Ÿäº§ä¼šè¢«é˜»å¡ï¼Œæœ€ç»ˆå¯¼è‡´æ•°æ®æºçš„æ‘„å…¥è¢«é˜»å¡ã€‚

> 47ã€Flinkåå‹çš„å½±å“æœ‰å“ªäº›ï¼Ÿ

åå‹ä¼šå½±å“åˆ°ä¸¤é¡¹æŒ‡æ ‡: **checkpoint æ—¶é•¿**å’Œ **state å¤§å°**

ï¼ˆ1ï¼‰å‰è€…æ˜¯å› ä¸º checkpoint barrier æ˜¯ä¸ä¼šè¶Šè¿‡æ™®é€šæ•°æ®çš„ï¼Œ**æ•°æ®å¤„ç†è¢«é˜»å¡**ä¹Ÿä¼š**å¯¼è‡´** checkpoint barrier æµç»**æ•´ä¸ªæ•°æ®ç®¡é“çš„æ—¶é•¿å˜é•¿**ï¼Œå› è€Œ checkpoint æ€»ä½“æ—¶é—´ï¼ˆEnd to End Durationï¼‰å˜é•¿ã€‚

ï¼ˆ2ï¼‰åè€…æ˜¯å› ä¸ºä¸ºä¿è¯ EOSï¼ˆExactly-Once-Semanticsï¼Œå‡†ç¡®ä¸€æ¬¡ï¼‰ï¼Œå¯¹äºæœ‰ä¸¤ä¸ªä»¥ä¸Šè¾“å…¥ç®¡é“çš„ Operatorï¼Œcheckpoint barrier éœ€è¦å¯¹é½ï¼ˆAlignmentï¼‰ï¼Œæ¥å—åˆ°è¾ƒå¿«çš„è¾“å…¥ç®¡é“çš„ barrier åï¼Œå®ƒåé¢æ•°æ®ä¼šè¢«ç¼“å­˜èµ·æ¥ä½†ä¸å¤„ç†ï¼Œç›´åˆ°è¾ƒæ…¢çš„è¾“å…¥ç®¡é“çš„ barrier ä¹Ÿåˆ°è¾¾ï¼Œè¿™äº›è¢«ç¼“å­˜çš„æ•°æ®ä¼šè¢«æ”¾åˆ°state é‡Œé¢ï¼Œå¯¼è‡´ checkpoint å˜å¤§ã€‚



**è¿™ä¸¤ä¸ªå½±å“å¯¹äºç”Ÿäº§ç¯å¢ƒçš„ä½œä¸šæ¥è¯´æ˜¯ååˆ†å±é™©çš„**ï¼Œå› ä¸º checkpoint æ˜¯ä¿è¯æ•°æ®ä¸€è‡´æ€§çš„å…³é”®ï¼Œcheckpoint æ—¶é—´å˜é•¿æœ‰å¯èƒ½å¯¼è‡´ checkpoint è¶…æ—¶å¤±è´¥ï¼Œè€Œ state å¤§å°åŒæ ·å¯èƒ½æ‹–æ…¢ checkpoint ç”šè‡³å¯¼è‡´ OOM ï¼ˆä½¿ç”¨ Heap-based StateBackendï¼‰æˆ–è€…ç‰©ç†å†…å­˜ä½¿ç”¨è¶…å‡ºå®¹å™¨èµ„æºï¼ˆä½¿ç”¨ RocksDBStateBackendï¼‰çš„ç¨³å®šæ€§é—®é¢˜ã€‚

> 48ã€Flinkåå‹å¦‚ä½•è§£å†³ï¼Ÿ

Flinkç¤¾åŒºæå‡ºäº† FLIP-76: Unaligned Checkpoints[4] æ¥è§£è€¦åå‹å’Œ checkpointã€‚

ï¼ˆ1ï¼‰å®šä½åå‹èŠ‚ç‚¹

è¦è§£å†³åå‹é¦–å…ˆè¦åšçš„æ˜¯å®šä½åˆ°é€ æˆåå‹çš„èŠ‚ç‚¹ï¼Œè¿™ä¸»è¦æœ‰ä¸¤ç§åŠæ³•:

1. é€šè¿‡ Flink Web UI è‡ªå¸¦çš„åå‹ç›‘æ§é¢æ¿ï¼›
2. é€šè¿‡ Flink Task Metricsã€‚

**ï¼ˆ1ï¼‰åå‹ç›‘æ§é¢æ¿**

Flink Web UI çš„åå‹ç›‘æ§æä¾›äº† SubTask çº§åˆ«çš„åå‹ç›‘æ§ï¼ŒåŸç†æ˜¯é€šè¿‡å‘¨æœŸæ€§å¯¹ Task çº¿ç¨‹çš„æ ˆä¿¡æ¯é‡‡æ ·ï¼Œå¾—åˆ°çº¿ç¨‹è¢«é˜»å¡åœ¨è¯·æ±‚ Bufferï¼ˆæ„å‘³ç€è¢«ä¸‹æ¸¸é˜Ÿåˆ—é˜»å¡ï¼‰çš„é¢‘ç‡æ¥åˆ¤æ–­è¯¥èŠ‚ç‚¹æ˜¯å¦å¤„äºåå‹çŠ¶æ€ã€‚é»˜è®¤é…ç½®ä¸‹ï¼Œè¿™ä¸ªé¢‘ç‡åœ¨ 0.1 ä»¥ä¸‹åˆ™ä¸º OKï¼Œ0.1 è‡³ 0.5 ä¸º LOWï¼Œè€Œè¶…è¿‡ 0.5 åˆ™ä¸º HIGHã€‚

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a0864f78-1257-11ec-948d-00163e068ecd.png)



**ï¼ˆ2ï¼‰Task Metrics**

Flink æä¾›çš„ Task Metrics æ˜¯æ›´å¥½çš„åå‹ç›‘æ§æ‰‹æ®µ

å¦‚æœä¸€ä¸ª Subtask çš„å‘é€ç«¯ Buffer å ç”¨ç‡å¾ˆé«˜ï¼Œåˆ™è¡¨æ˜å®ƒè¢«ä¸‹æ¸¸åå‹é™é€Ÿäº†ï¼›

å¦‚æœä¸€ä¸ª Subtask çš„æ¥å—ç«¯ Buffer å ç”¨å¾ˆé«˜ï¼Œåˆ™è¡¨æ˜å®ƒå°†åå‹ä¼ å¯¼è‡³ä¸Šæ¸¸ã€‚

> 49ã€Flinkæ”¯æŒçš„æ•°æ®ç±»å‹æœ‰å“ªäº›ï¼Ÿ

Flinkæ”¯æŒçš„æ•°æ®ç±»å‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a0b3636e-1257-11ec-948d-00163e068ecd.png)

ä»å›¾ä¸­å¯ä»¥çœ‹åˆ° Flink ç±»å‹å¯ä»¥åˆ†ä¸ºåŸºç¡€ç±»å‹ï¼ˆBasicï¼‰ã€æ•°ç»„ï¼ˆArraysï¼‰ã€å¤åˆç±»å‹ï¼ˆCompositeï¼‰ã€è¾…åŠ©ç±»å‹ï¼ˆAuxiliaryï¼‰ã€æ³›å‹å’Œå…¶å®ƒç±»å‹ï¼ˆGenericï¼‰ã€‚Flink æ”¯æŒä»»æ„çš„ Java æˆ–æ˜¯ Scala ç±»å‹ã€‚ 

> 50ã€Flinkå¦‚ä½•è¿›è¡Œåºåˆ—å’Œååºåˆ—åŒ–çš„ï¼Ÿ

æ‰€è°“åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„å«ä¹‰ï¼š

**åºåˆ—åŒ–ï¼š**å°±æ˜¯å°†ä¸€ä¸ªå†…å­˜å¯¹è±¡è½¬æ¢æˆäºŒè¿›åˆ¶ä¸²ï¼Œå½¢æˆç½‘ç»œä¼ è¾“æˆ–è€…æŒä¹…åŒ–çš„æ•°æ®æµã€‚

**ååºåˆ—åŒ–ï¼š**å°†äºŒè¿›åˆ¶ä¸²è½¬æ¢ä¸ºå†…å­˜å¯¹ã€‚

**TypeInformation æ˜¯ Flink ç±»å‹ç³»ç»Ÿçš„æ ¸å¿ƒç±»** 

**åœ¨Flinkä¸­ï¼Œå½“æ•°æ®éœ€è¦è¿›è¡Œåºåˆ—åŒ–æ—¶ï¼Œä¼šä½¿ç”¨TypeInformationçš„****ç”Ÿæˆåºåˆ—åŒ–å™¨****æ¥å£è°ƒç”¨ä¸€ä¸ª createSerialize() æ–¹æ³•ï¼Œ****åˆ›å»ºå‡ºTypeSerializerï¼Œ****TypeSerializer****æä¾›äº†åºåˆ—åŒ–å’Œååºåˆ—åŒ–èƒ½åŠ›ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼šFlink çš„åºåˆ—åŒ–è¿‡ç¨‹**



**![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a0dd929c-1257-11ec-948d-00163e068ecd.png)**

**å¯¹äºå¤§å¤šæ•°æ•°æ®ç±»å‹** **Flink å¯ä»¥è‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„åºåˆ—åŒ–å™¨****ï¼Œèƒ½éå¸¸é«˜æ•ˆåœ°å¯¹æ•°æ®é›†è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ– ï¼Œ****å¦‚ä¸‹å›¾ï¼š**

**![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a0fc17bc-1257-11ec-948d-00163e068ecd.png)**

**æ¯”å¦‚ï¼ŒBasicTypeInfoã€WritableTypeIno ï¼Œä½†é’ˆå¯¹ GenericTypeInfo ç±»å‹ï¼ŒFlink ä¼šä½¿ç”¨ Kyro è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚å…¶ä¸­ï¼ŒTupleã€Pojo å’Œ CaseClass ç±»å‹æ˜¯å¤åˆç±»å‹ï¼Œå®ƒä»¬å¯èƒ½åµŒå¥—ä¸€ä¸ªæˆ–è€…å¤šä¸ªæ•°æ®ç±»å‹ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒä»¬çš„åºåˆ—åŒ–å™¨åŒæ ·æ˜¯å¤åˆçš„ã€‚å®ƒä»¬ä¼šå°†å†…åµŒç±»å‹çš„åºåˆ—åŒ–å§”æ‰˜ç»™å¯¹åº”ç±»å‹çš„åºåˆ—åŒ–å™¨ã€‚**

**é€šè¿‡ä¸€ä¸ªæ¡ˆä¾‹ä»‹ç»Flinkåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼š
**

**![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a122c326-1257-11ec-948d-00163e068ecd.png)**

**å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå½“åˆ›å»ºä¸€ä¸ªTuple 3 å¯¹è±¡æ—¶ï¼ŒåŒ…å«ä¸‰ä¸ªå±‚é¢ï¼Œä¸€æ˜¯ int ç±»å‹ï¼Œä¸€æ˜¯ double ç±»å‹ï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯ Personã€‚Personå¯¹è±¡åŒ…å«ä¸¤ä¸ªå­—æ®µï¼Œä¸€æ˜¯ int å‹çš„ IDï¼Œå¦ä¸€ä¸ªæ˜¯ String ç±»å‹çš„ nameï¼Œ**

**ï¼ˆ1ï¼‰åœ¨åºåˆ—åŒ–æ“ä½œæ—¶ï¼Œä¼šå§”æ‰˜ç›¸åº”å…·ä½“åºåˆ—åŒ–çš„åºåˆ—åŒ–å™¨è¿›è¡Œç›¸åº”çš„åºåˆ—åŒ–æ“ä½œã€‚ä»å›¾ä¸­å¯ä»¥çœ‹åˆ° Tuple 3 ä¼šæŠŠ int ç±»å‹é€šè¿‡ IntSerializer è¿›è¡Œåºåˆ—åŒ–æ“ä½œï¼Œæ­¤æ—¶ int åªéœ€è¦å ç”¨å››ä¸ªå­—èŠ‚ã€‚**

**ï¼ˆ2ï¼‰Person ç±»ä¼šè¢«å½“æˆä¸€ä¸ª Pojo å¯¹è±¡æ¥è¿›è¡Œå¤„ç†ï¼ŒPojoSerializer åºåˆ—åŒ–å™¨ä¼šæŠŠä¸€äº›å±æ€§ä¿¡æ¯ä½¿ç”¨ä¸€ä¸ªå­—èŠ‚å­˜å‚¨èµ·æ¥ã€‚åŒæ ·ï¼Œå…¶å­—æ®µåˆ™é‡‡å–ç›¸å¯¹åº”çš„åºåˆ—åŒ–å™¨è¿›è¡Œç›¸åº”åºåˆ—åŒ–ï¼Œåœ¨åºåˆ—åŒ–å®Œçš„ç»“æœä¸­ï¼Œå¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„æ•°æ®éƒ½æ˜¯ç”± MemorySegment å»æ”¯æŒã€‚** 



**MemorySegment å…·æœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿ**



**MemorySegment åœ¨ Flink ä¸­ä¼šå°†å¯¹è±¡åºåˆ—åŒ–åˆ°é¢„åˆ†é…çš„å†…å­˜å—ä¸Šï¼Œå®ƒä»£è¡¨ 1 ä¸ªå›ºå®šé•¿åº¦çš„å†…å­˜ï¼Œé»˜è®¤å¤§å°ä¸º 32 kbã€‚MemorySegment ä»£è¡¨ Flink ä¸­çš„ä¸€ä¸ªæœ€å°çš„å†…å­˜åˆ†é…å•å…ƒï¼Œç›¸å½“äºæ˜¯ Java çš„ä¸€ä¸ª byte æ•°ç»„ã€‚æ¯æ¡è®°å½•éƒ½ä¼šä»¥åºåˆ—åŒ–çš„å½¢å¼å­˜å‚¨åœ¨ä¸€ä¸ªæˆ–å¤šä¸ª MemorySegment ä¸­ã€‚**

> 51ã€ä¸ºä»€ä¹ˆFlinkä½¿ç”¨è‡ªä¸»å†…å­˜è€Œä¸ç”¨JVMå†…å­˜ç®¡ç†ï¼Ÿ

å› ä¸ºåœ¨å†…å­˜ä¸­å­˜å‚¨å¤§é‡çš„æ•°æ® ï¼ˆåŒ…æ‹¬ç¼“å­˜å’Œé«˜æ•ˆå¤„ç†ï¼‰æ—¶ï¼ŒJVMä¼šé¢ä¸´å¾ˆå¤šé—®é¢˜ï¼ŒåŒ…æ‹¬å¦‚ä¸‹ï¼š

JVM å†…å­˜ç®¡ç†çš„ä¸è¶³ï¼š 

**1ï¼‰Java å¯¹è±¡å­˜å‚¨å¯†åº¦ä½ã€‚**Java çš„å¯¹è±¡åœ¨å†…å­˜ä¸­å­˜å‚¨åŒ…å« 3 ä¸ªä¸»è¦éƒ¨åˆ†ï¼šå¯¹è±¡å¤´ã€å®ä¾‹ æ•°æ®ã€å¯¹é½å¡«å……éƒ¨åˆ†ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªåªåŒ…å« boolean å±æ€§çš„å¯¹è±¡å  16byteï¼šå¯¹è±¡å¤´å  8byteï¼Œ boolean å±æ€§å  1byteï¼Œä¸ºäº†å¯¹é½è¾¾åˆ° 8 çš„å€æ•°é¢å¤–å  7byteã€‚è€Œå®é™…ä¸Šåªéœ€è¦ä¸€ä¸ª bitï¼ˆ1/8 å­—èŠ‚ï¼‰å°±å¤Ÿäº†ã€‚

**2ï¼‰Full GC ä¼šæå¤§åœ°å½±å“æ€§èƒ½ã€‚**å°¤å…¶æ˜¯ä¸ºäº†å¤„ç†æ›´å¤§æ•°æ®è€Œå¼€äº†å¾ˆå¤§å†…å­˜ç©ºé—´çš„ JVM æ¥è¯´ï¼ŒGC ä¼šè¾¾åˆ°ç§’çº§ç”šè‡³åˆ†é’Ÿçº§ã€‚

**3ï¼‰OOM é—®é¢˜å½±å“ç¨³å®šæ€§ã€‚**OutOfMemoryError æ˜¯åˆ†å¸ƒå¼è®¡ç®—æ¡†æ¶ç»å¸¸ä¼šé‡åˆ°çš„é—®é¢˜ï¼Œ å½“JVMä¸­æ‰€æœ‰å¯¹è±¡å¤§å°è¶…è¿‡åˆ†é…ç»™JVMçš„å†…å­˜å¤§å°æ—¶ï¼Œå°±ä¼šå‘ç”ŸOutOfMemoryErroré”™è¯¯ï¼Œ å¯¼è‡´ JVM å´©æºƒï¼Œåˆ†å¸ƒå¼æ¡†æ¶çš„å¥å£®æ€§å’Œæ€§èƒ½éƒ½ä¼šå—åˆ°å½±å“ã€‚

**4ï¼‰ç¼“å­˜æœªå‘½ä¸­é—®é¢˜ã€‚**CPU è¿›è¡Œè®¡ç®—çš„æ—¶å€™ï¼Œæ˜¯ä» CPU ç¼“å­˜ä¸­è·å–æ•°æ®ã€‚ç°ä»£ä½“ç³»çš„ CPU ä¼šæœ‰å¤šçº§ç¼“å­˜ï¼Œè€ŒåŠ è½½çš„æ—¶å€™æ˜¯ä»¥ Cache Line ä¸ºå•ä½åŠ è½½ã€‚å¦‚æœèƒ½å¤Ÿå°†å¯¹è±¡è¿ç»­å­˜å‚¨ï¼Œ è¿™æ ·å°±ä¼šå¤§å¤§é™ä½ Cache Missã€‚ä½¿å¾— CPU é›†ä¸­å¤„ç†ä¸šåŠ¡ï¼Œè€Œä¸æ˜¯ç©ºè½¬ã€‚

> 52ã€é‚£Flinkè‡ªä¸»å†…å­˜æ˜¯å¦‚ä½•ç®¡ç†å¯¹è±¡çš„ï¼Ÿ

Flink å¹¶ä¸æ˜¯å°†å¤§é‡å¯¹è±¡å­˜åœ¨å †å†…å­˜ä¸Šï¼Œè€Œæ˜¯å°†å¯¹è±¡éƒ½åºåˆ—åŒ–åˆ°ä¸€ä¸ªé¢„åˆ†é…çš„å†…å­˜å—ä¸Šï¼Œ è¿™ä¸ªå†…å­˜å—å«åš **MemorySegment**ï¼Œå®ƒä»£è¡¨äº†ä¸€æ®µå›ºå®šé•¿åº¦çš„å†…å­˜ï¼ˆé»˜è®¤å¤§å°ä¸º 32KBï¼‰ï¼Œä¹Ÿ æ˜¯ **Flink ä¸­æœ€å°çš„å†…å­˜åˆ†é…å•å…ƒ**ï¼Œå¹¶ä¸”æä¾›äº†éå¸¸é«˜æ•ˆçš„è¯»å†™æ–¹æ³•ï¼Œå¾ˆå¤šè¿ç®—å¯ä»¥ç›´æ¥æ“ä½œ äºŒè¿›åˆ¶æ•°æ®ï¼Œä¸éœ€è¦ååºåˆ—åŒ–å³å¯æ‰§è¡Œã€‚æ¯æ¡è®°å½•éƒ½ä¼šä»¥åºåˆ—åŒ–çš„å½¢å¼å­˜å‚¨åœ¨ä¸€ä¸ªæˆ–å¤šä¸ª MemorySegment ä¸­ã€‚å¦‚æœéœ€è¦å¤„ç†çš„æ•°æ®å¤šäºå¯ä»¥ä¿å­˜åœ¨å†…å­˜ä¸­çš„æ•°æ®ï¼ŒFlink çš„è¿ç®—ç¬¦ä¼š å°†éƒ¨åˆ†æ•°æ®æº¢å‡ºåˆ°ç£ç›˜

> 53ã€Flinkå†…å­˜æ¨¡å‹ä»‹ç»ä¸€ä¸‹ï¼Ÿ

Flinkæ€»ä½“å†…å­˜ç±»å›¾å¦‚ä¸‹ï¼š

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a146062e-1257-11ec-948d-00163e068ecd.png)

ä¸»è¦åŒ…å«**JobManagerå†…å­˜æ¨¡å‹**å’Œ **TaskManagerå†…å­˜æ¨¡å‹**

**JobManagerå†…å­˜æ¨¡å‹**

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a1661d74-1257-11ec-948d-00163e068ecd.png)

åœ¨ 1.10 ä¸­ï¼ŒFlink ç»Ÿä¸€äº† TM ç«¯çš„å†…å­˜ç®¡ç†å’Œé…ç½®ï¼Œç›¸åº”çš„åœ¨ 1.11 ä¸­ï¼ŒFlink è¿›ä¸€æ­¥ å¯¹ JM ç«¯çš„å†…å­˜é…ç½®è¿›è¡Œäº†ä¿®æ”¹ï¼Œä½¿å®ƒçš„é€‰é¡¹å’Œé…ç½®æ–¹å¼ä¸ TM ç«¯çš„é…ç½®æ–¹å¼ä¿æŒä¸€è‡´ã€‚

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a18752c8-1257-11ec-948d-00163e068ecd.png)



**TaskManagerå†…å­˜æ¨¡å‹**

**Flink 1.10** å¯¹ TaskManager çš„å†…å­˜æ¨¡å‹å’Œ Flink åº”ç”¨ç¨‹åºçš„é…ç½®é€‰é¡¹è¿›è¡Œäº†**é‡å¤§æ›´æ”¹**ï¼Œ è®©ç”¨æˆ·èƒ½å¤Ÿæ›´åŠ ä¸¥æ ¼åœ°æ§åˆ¶å…¶å†…å­˜å¼€é”€ã€‚

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a1aaa98a-1257-11ec-948d-00163e068ecd.png)



![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a1d70cb4-1257-11ec-948d-00163e068ecd.png)

**JVM Heapï¼šJVM å †ä¸Šå†…å­˜** 

**1ã€Framework Heap Memoryï¼š**Flink æ¡†æ¶æœ¬èº«ä½¿ç”¨çš„å†…å­˜ï¼Œå³ TaskManager æœ¬èº«æ‰€ å ç”¨çš„å †ä¸Šå†…å­˜ï¼Œä¸è®¡å…¥ Slot çš„èµ„æºä¸­ã€‚ 

é…ç½®å‚æ•°ï¼štaskmanager.memory.framework.heap.size=128MB,é»˜è®¤ 128MB

**2ã€Task Heap Memoryï¼š**Task æ‰§è¡Œç”¨æˆ·ä»£ç æ—¶æ‰€ä½¿ç”¨çš„å †ä¸Šå†…å­˜ã€‚

é…ç½®å‚æ•°ï¼štaskmanager.memory.task.heap.size

**Off-Heap Mempryï¼šJVM å †å¤–å†…å­˜** 

**1ã€DirectMemoryï¼šJVM ç›´æ¥å†…å­˜** 

1ï¼‰Framework Off-Heap Memoryï¼šFlinkæ¡†æ¶æœ¬èº«æ‰€ä½¿ç”¨çš„å†…å­˜ï¼Œå³TaskManager æœ¬èº«æ‰€å ç”¨çš„å¯¹å¤–å†…å­˜ï¼Œä¸è®¡å…¥ Slot èµ„æºã€‚

é…ç½®å‚æ•°ï¼štaskmanager.memory.framework.off-heap.size=128MBï¼Œé»˜è®¤ 128MB 

2ï¼‰Task Off-Heap Memoryï¼šTask æ‰§è¡Œç”¨æˆ·ä»£ç æ‰€ä½¿ç”¨çš„å¯¹å¤–å†…å­˜ã€‚

 é…ç½®å‚æ•°ï¼štaskmanager.memory.task.off-heap.size=0,é»˜è®¤ 0 

3ï¼‰Network Memoryï¼šç½‘ç»œæ•°æ®äº¤æ¢æ‰€ä½¿ç”¨çš„å †å¤–å†…å­˜å¤§å°ï¼Œå¦‚ç½‘ç»œæ•°æ®äº¤æ¢ ç¼“å†²åŒº 



**2ã€Managed Memoryï¼šFlink ç®¡ç†çš„å †å¤–å†…å­˜**ï¼Œ

ç”¨äºæ’åºã€å“ˆå¸Œè¡¨ã€ç¼“å­˜ä¸­é—´ç»“æœåŠ RocksDB State Backend çš„æœ¬åœ°å†…å­˜ã€‚



**JVM specific memoryï¼šJVM æœ¬èº«ä½¿ç”¨çš„å†…å­˜** 

**1ã€JVM metaspaceï¼šJVM å…ƒç©ºé—´** 

**2ã€JVM over-head æ‰§è¡Œå¼€é”€ï¼š**JVM æ‰§è¡Œæ—¶è‡ªèº«æ‰€éœ€è¦çš„å†…å®¹ï¼ŒåŒ…æ‹¬çº¿ç¨‹å †æ ˆã€IOã€ ç¼–è¯‘ç¼“å­˜ç­‰æ‰€ä½¿ç”¨çš„å†…å­˜ã€‚

é…ç½®å‚æ•°ï¼štaskmanager.memory.jvm-overhead.min=192mb

taskmanager.memory.jvm-overhead.max=1gb 

taskmanager.memory.jvm-overhead.fraction=0.1 

**æ€»ä½“å†…å­˜** 

**1ã€æ€»è¿›ç¨‹å†…å­˜ï¼š**Flink Java åº”ç”¨ç¨‹åºï¼ˆåŒ…æ‹¬ç”¨æˆ·ä»£ç ï¼‰å’Œ JVM è¿è¡Œæ•´ä¸ªè¿›ç¨‹æ‰€æ¶ˆ è€—çš„æ€»å†…å­˜ã€‚

æ€»è¿›ç¨‹å†…å­˜ = Flink ä½¿ç”¨å†…å­˜ + JVM å…ƒç©ºé—´ + JVM æ‰§è¡Œå¼€é”€ 

é…ç½®é¡¹ï¼štaskmanager.memory.process.size: 1728m

**2ã€Flink æ€»å†…å­˜ï¼š**ä»… Flink Java åº”ç”¨ç¨‹åºæ¶ˆè€—çš„å†…å­˜ï¼ŒåŒ…æ‹¬ç”¨æˆ·ä»£ç ï¼Œä½†ä¸åŒ…æ‹¬ JVM ä¸ºå…¶è¿è¡Œè€Œåˆ†é…çš„å†…å­˜ã€‚

Flink ä½¿ç”¨å†…å­˜ï¼šæ¡†æ¶å †å†…å¤– + task å †å†…å¤– + network + manage

> 54ã€Flinkå¦‚ä½•è¿›è¡Œèµ„æºç®¡ç†çš„ï¼Ÿ

Flinkåœ¨èµ„æºç®¡ç†ä¸Šå¯ä»¥åˆ†ä¸ºä¸¤å±‚ï¼š**é›†ç¾¤èµ„æº**å’Œ**è‡ªèº«èµ„æº**ã€‚é›†ç¾¤èµ„æºæ”¯æŒä¸»æµçš„èµ„æºç®¡ç†ç³»ç»Ÿï¼Œå¦‚yarnã€mesosã€k8sç­‰ï¼Œä¹Ÿæ”¯æŒç‹¬ç«‹å¯åŠ¨çš„standaloneé›†ç¾¤ã€‚è‡ªèº«èµ„æºæ¶‰åŠåˆ°æ¯ä¸ªå­taskçš„èµ„æºä½¿ç”¨ï¼Œç”±Flinkè‡ªèº«ç»´æŠ¤ã€‚

## **1 é›†ç¾¤æ¶æ„å‰–æ**

 

Flinkçš„è¿è¡Œä¸»è¦ç”± å®¢æˆ·ç«¯ã€ä¸€ä¸ªJobManagerï¼ˆåæ–‡ç®€ç§°JMï¼‰å’Œ ä¸€ä¸ªä»¥ä¸Šçš„TaskManagerï¼ˆç®€ç§°TMæˆ–Workerï¼‰ç»„æˆã€‚

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a1fc8dfe-1257-11ec-948d-00163e068ecd.png)

**å®¢æˆ·ç«¯**

å®¢æˆ·ç«¯ä¸»è¦ç”¨äºæäº¤ä»»åŠ¡åˆ°é›†ç¾¤ï¼Œåœ¨Sessionæˆ–Per Jobæ¨¡å¼ä¸­ï¼Œå®¢æˆ·ç«¯ç¨‹åºè¿˜è¦è´Ÿè´£è§£æç”¨æˆ·ä»£ç ï¼Œç”ŸæˆJobGraphï¼›åœ¨Applicationæ¨¡å¼ä¸­ï¼Œç›´æ¥æäº¤ç”¨æˆ·jarå’Œæ‰§è¡Œå‚æ•°å³å¯ã€‚å®¢æˆ·ç«¯ä¸€èˆ¬æ”¯æŒä¸¤ç§æ¨¡å¼ï¼šdetachedæ¨¡å¼ï¼Œå®¢æˆ·ç«¯æäº¤åè‡ªåŠ¨é€€å‡ºã€‚attachedæ¨¡å¼ï¼Œå®¢æˆ·ç«¯æäº¤åé˜»å¡ç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæ¯•å†é€€å‡ºã€‚ 

 

**JobManager**

 

JMè´Ÿè´£å†³å®šåº”ç”¨ä½•æ—¶è°ƒåº¦taskï¼Œåœ¨taskæ‰§è¡Œç»“æŸæˆ–å¤±è´¥æ—¶å¦‚ä½•å¤„ç†ï¼Œåè°ƒæ£€æŸ¥ç‚¹ã€æ•…éšœæ¢å¤ã€‚è¯¥è¿›ç¨‹ä¸»è¦ç”±ä¸‹é¢å‡ ä¸ªéƒ¨åˆ†ç»„æˆï¼š

**1 ResourceManager**ï¼Œè´Ÿè´£èµ„æºçš„ç”³è¯·å’Œé‡Šæ”¾ã€ç®¡ç†slotï¼ˆFlinké›†ç¾¤ä¸­æœ€ç»†ç²’åº¦çš„èµ„æºç®¡ç†å•å…ƒï¼‰ã€‚Flinkå®ç°äº†å¤šç§RMçš„å®ç°æ–¹æ¡ˆä»¥é€‚é…å¤šç§èµ„æºç®¡ç†æ¡†æ¶ï¼Œå¦‚yarnã€mesosã€k8sæˆ–standaloneã€‚åœ¨standaloneæ¨¡å¼ä¸‹ï¼ŒRMåªèƒ½åˆ†é…slotï¼Œè€Œä¸èƒ½å¯åŠ¨æ–°çš„TMã€‚æ³¨æ„ï¼šè¿™é‡Œæ‰€è¯´çš„RMè·ŸYarnçš„RMä¸æ˜¯ä¸€ä¸ªä¸œè¥¿ï¼Œè¿™é‡Œçš„RMæ˜¯JMä¸­çš„ä¸€ä¸ªç‹¬ç«‹çš„æœåŠ¡ã€‚

**2 Dispatcher**ï¼Œæä¾›Flinkæäº¤ä»»åŠ¡çš„restæ¥å£ï¼Œä¸ºæ¯ä¸ªæäº¤çš„ä»»åŠ¡å¯åŠ¨æ–°çš„JobMasterï¼Œä¸ºæ‰€æœ‰çš„ä»»åŠ¡æä¾›web uiï¼ŒæŸ¥è¯¢ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€ã€‚

**3 JobMaster**ï¼Œè´Ÿè´£ç®¡ç†æ‰§è¡Œå•ä¸ªJobGraphï¼Œå¤šä¸ªä»»åŠ¡å¯ä»¥åŒæ—¶åœ¨ä¸€ä¸ªé›†ç¾¤ä¸­å¯åŠ¨ï¼Œæ¯ä¸ªéƒ½æœ‰è‡ªå·±çš„JobMasterã€‚æ³¨æ„è¿™é‡Œçš„JobMasterå’ŒJobManagerçš„åŒºåˆ«ã€‚

 

**TaskManager**

 

TMä¹Ÿå«åšworkerï¼Œç”¨äºæ‰§è¡Œæ•°æ®æµå›¾ä¸­çš„ä»»åŠ¡ï¼Œç¼“å­˜å¹¶äº¤æ¢æ•°æ®ã€‚é›†ç¾¤è‡³å°‘æœ‰ä¸€ä¸ªTMï¼ŒTMä¸­æœ€å°çš„èµ„æºç®¡ç†å•å…ƒæ˜¯Slotï¼Œæ¯ä¸ªSlotå¯ä»¥æ‰§è¡Œä¸€ä¸ªTaskï¼Œå› æ­¤TMä¸­slotçš„æ•°é‡å°±ä»£è¡¨åŒæ—¶å¯ä»¥æ‰§è¡Œä»»åŠ¡çš„æ•°é‡ã€‚

##  

## 2 Slotä¸èµ„æºç®¡ç†

 

æ¯ä¸ªTMæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„JVMè¿›ç¨‹ï¼Œå†…éƒ¨åŸºäºç‹¬ç«‹çš„çº¿ç¨‹æ‰§è¡Œä¸€ä¸ªæˆ–å¤šä¸ªä»»åŠ¡ã€‚TMä¸ºäº†æ§åˆ¶æ¯ä¸ªä»»åŠ¡çš„æ‰§è¡Œèµ„æºï¼Œä½¿ç”¨task slotæ¥è¿›è¡Œç®¡ç†ã€‚æ¯ä¸ªtask slotä»£è¡¨TMä¸­çš„ä¸€éƒ¨åˆ†å›ºå®šçš„èµ„æºï¼Œæ¯”å¦‚ä¸€ä¸ªTMæœ‰3ä¸ªslotï¼Œæ¯ä¸ªslotå°†ä¼šå¾—åˆ°TMçš„1/3å†…å­˜èµ„æºã€‚ä¸åŒä»»åŠ¡ä¹‹é—´ä¸ä¼šè¿›è¡Œèµ„æºçš„æŠ¢å ï¼Œæ³¨æ„GPUç›®å‰æ²¡æœ‰è¿›è¡Œéš”ç¦»ï¼Œç›®å‰slotåªèƒ½åˆ’åˆ†å†…å­˜èµ„æºã€‚

 

æ¯”å¦‚ä¸‹é¢çš„æ•°æ®æµå›¾ï¼Œåœ¨æ‰©å±•æˆå¹¶è¡Œæµå›¾åï¼ŒåŒä¸€çš„taskå¯èƒ½åˆ†æ‹†æˆå¤šä¸ªä»»åŠ¡å¹¶è¡Œåœ¨é›†ç¾¤ä¸­æ‰§è¡Œã€‚æ“ä½œé“¾å¯ä»¥æŠŠå¤šä¸ªä¸åŒçš„ä»»åŠ¡è¿›è¡Œåˆå¹¶ï¼Œä»è€Œæ”¯æŒåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å…ˆåæ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼Œæ— éœ€é¢‘ç¹é‡Šæ”¾ç”³è¯·çº¿ç¨‹ã€‚åŒæ—¶æ“ä½œé“¾è¿˜å¯ä»¥ç»Ÿä¸€ç¼“å­˜æ•°æ®ï¼Œå¢åŠ æ•°æ®å¤„ç†ååé‡ï¼Œé™ä½å¤„ç†å»¶è¿Ÿã€‚

 

åœ¨Flinkä¸­ï¼Œæƒ³è¦ä¸åŒå­ä»»åŠ¡åˆå¹¶éœ€è¦æ»¡è¶³å‡ ä¸ªæ¡ä»¶ï¼šä¸‹æ¸¸èŠ‚ç‚¹çš„å…¥è¾¹æ˜¯1ï¼ˆä¿è¯ä¸å­˜åœ¨æ•°æ®çš„shuffleï¼‰ï¼›å­ä»»åŠ¡çš„ä¸Šä¸‹æ¸¸ä¸ä¸ºç©ºï¼›è¿æ¥ç­–ç•¥æ€»æ˜¯ALWAYSï¼›åˆ†åŒºç±»å‹ä¸ºForwardPartitionerï¼›å¹¶è¡Œåº¦ä¸€è‡´ï¼›å½“å‰Flinkå¼€å¯Chainç‰¹æ€§ã€‚

 

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a2258d1c-1257-11ec-948d-00163e068ecd.png)

åœ¨é›†ç¾¤ä¸­çš„æ‰§è¡Œå›¾å¯èƒ½å¦‚ä¸‹ï¼š

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a2527cb4-1257-11ec-948d-00163e068ecd.png)

Flinkä¹Ÿæ”¯æŒslotçš„å…±äº«ï¼Œå³æŠŠä¸åŒä»»åŠ¡æ ¹æ®ä»»åŠ¡çš„ä¾èµ–å…³ç³»åˆ†é…åˆ°åŒä¸€ä¸ªSlotä¸­ã€‚è¿™æ ·å¸¦æ¥å‡ ä¸ªå¥½å¤„ï¼šæ–¹ä¾¿ç»Ÿè®¡å½“å‰ä»»åŠ¡æ‰€éœ€çš„æœ€å¤§èµ„æºé…ç½®ï¼ˆæŸä¸ªå­ä»»åŠ¡çš„æœ€å¤§å¹¶è¡Œåº¦ï¼‰ï¼›é¿å…Slotçš„è¿‡å¤šç”³è¯·ä¸é‡Šæ”¾ï¼Œæå‡Slotçš„ä½¿ç”¨æ•ˆç‡ã€‚

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a275764c-1257-11ec-948d-00163e068ecd.png)

é€šè¿‡Slotå…±äº«ï¼Œå°±æœ‰å¯èƒ½æŸä¸ªSlotä¸­åŒ…å«å®Œæ•´çš„ä»»åŠ¡æ‰§è¡Œé“¾è·¯ã€‚

 

## **3 åº”ç”¨æ‰§è¡Œ**

 

ä¸€ä¸ªFlinkåº”ç”¨å°±æ˜¯ç”¨æˆ·ç¼–å†™çš„mainå‡½æ•°ï¼Œå…¶ä¸­å¯èƒ½åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªFlinkçš„ä»»åŠ¡ã€‚è¿™äº›ä»»åŠ¡å¯ä»¥åœ¨æœ¬åœ°æ‰§è¡Œï¼Œä¹Ÿå¯ä»¥åœ¨è¿œç¨‹é›†ç¾¤å¯åŠ¨ï¼Œé›†ç¾¤æ—¢å¯ä»¥é•¿æœŸè¿è¡Œï¼Œä¹Ÿæ”¯æŒç‹¬ç«‹å¯åŠ¨ã€‚ä¸‹é¢æ˜¯ç›®å‰æ”¯æŒçš„ä»»åŠ¡æäº¤æ–¹æ¡ˆï¼š

 

**Sessioné›†ç¾¤**

 

**ç”Ÿå‘½å‘¨æœŸ**ï¼šé›†ç¾¤äº‹å…ˆåˆ›å»ºå¹¶é•¿æœŸè¿è¡Œï¼Œå®¢æˆ·ç«¯æäº¤ä»»åŠ¡æ—¶ä¸è¯¥é›†ç¾¤è¿æ¥ã€‚å³ä½¿æ‰€æœ‰ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæ¯•ï¼Œé›†ç¾¤ä»ä¼šä¿æŒè¿è¡Œï¼Œé™¤éæ‰‹åŠ¨åœæ­¢ã€‚å› æ­¤é›†ç¾¤çš„ç”Ÿå‘½å‘¨æœŸä¸ä»»åŠ¡æ— å…³ã€‚

**èµ„æºéš”ç¦»**ï¼šTMçš„slotç”±RMç”³è¯·ï¼Œå½“ä¸Šé¢çš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ä¼šè‡ªåŠ¨è¿›è¡Œé‡Šæ”¾ã€‚ç”±äºå¤šä¸ªä»»åŠ¡ä¼šå…±äº«ç›¸åŒçš„é›†ç¾¤ï¼Œå› æ­¤ä»»åŠ¡é—´ä¼šå­˜åœ¨ç«äº‰ï¼Œæ¯”å¦‚ç½‘ç»œå¸¦å®½ç­‰ã€‚å¦‚æœæŸä¸ªTMæŒ‚æ‰ï¼Œä¸Šé¢çš„æ‰€æœ‰ä»»åŠ¡éƒ½ä¼šå¤±è´¥ã€‚

**å…¶ä»–æ–¹é¢**ï¼šæ‹¥æœ‰æå‰åˆ›å»ºçš„é›†ç¾¤ï¼Œå¯ä»¥é¿å…æ¯æ¬¡ä½¿ç”¨çš„æ—¶å€™è¿‡å¤šè€ƒè™‘é›†ç¾¤é—®é¢˜ã€‚æ¯”è¾ƒé€‚åˆé‚£äº›æ‰§è¡Œæ—¶é—´å¾ˆçŸ­ï¼Œå¯¹å¯åŠ¨æ—¶é—´æœ‰æ¯”è¾ƒé«˜çš„è¦æ±‚çš„åœºæ™¯ï¼Œæ¯”å¦‚äº¤äº’å¼æŸ¥è¯¢åˆ†æã€‚

 

**Per Jobé›†ç¾¤**

 

**ç”Ÿå‘½å‘¨æœŸ**ï¼šä¸ºæ¯ä¸ªæäº¤çš„ä»»åŠ¡å•ç‹¬åˆ›å»ºä¸€ä¸ªé›†ç¾¤ï¼Œå®¢æˆ·ç«¯åœ¨æäº¤ä»»åŠ¡æ—¶ï¼Œç›´æ¥ä¸ClusterManageræ²Ÿé€šç”³è¯·åˆ›å»ºJMå¹¶åœ¨å†…éƒ¨è¿è¡Œæäº¤çš„ä»»åŠ¡ã€‚TMåˆ™æ ¹æ®ä»»åŠ¡è¿è¡Œéœ€è¦çš„èµ„æºå»¶è¿Ÿç”³è¯·ã€‚ä¸€æ—¦ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œé›†ç¾¤å°†ä¼šè¢«å›æ”¶ã€‚

**èµ„æºéš”ç¦»**ï¼šä»»åŠ¡å¦‚æœå‡ºç°è‡´å‘½é—®é¢˜ï¼Œä»…ä¼šå½±å“è‡ªå·±çš„ä»»åŠ¡ã€‚

**å…¶ä»–æ–¹é¢**ï¼šç”±äºRMéœ€è¦ç”³è¯·å’Œç­‰å¾…èµ„æºï¼Œå› æ­¤å¯åŠ¨æ—¶é—´ä¼šç¨é•¿ï¼Œé€‚åˆå•ä¸ªæ¯”è¾ƒå¤§ã€é•¿æ—¶é—´è¿è¡Œã€éœ€è¦ä¿è¯é•¿æœŸçš„ç¨³å®šæ€§ã€ä¸åœ¨ä¹å¯åŠ¨æ—¶é—´çš„ä»»åŠ¡ã€‚

 

**Applicationé›†ç¾¤**

 

**ç”Ÿå‘½å‘¨æœŸ**ï¼šä¸Per Jobç±»ä¼¼ï¼Œåªæ˜¯main()æ–¹æ³•è¿è¡Œåœ¨é›†ç¾¤ä¸­ã€‚ä»»åŠ¡çš„æäº¤ç¨‹åºå¾ˆç®€å•ï¼Œä¸éœ€è¦å¯åŠ¨æˆ–è¿æ¥é›†ç¾¤ï¼Œè€Œæ˜¯ç›´æ¥æŠŠåº”ç”¨ç¨‹åºæ‰“åŒ…åˆ°èµ„æºç®¡ç†ç³»ç»Ÿä¸­å¹¶å¯åŠ¨å¯¹åº”çš„EntryPointï¼Œåœ¨EntryPointä¸­è°ƒç”¨ç”¨æˆ·ç¨‹åºçš„main()æ–¹æ³•ï¼Œè§£æç”ŸæˆJobGraphï¼Œç„¶åå¯åŠ¨è¿è¡Œã€‚é›†ç¾¤çš„ç”Ÿå‘½å‘¨æœŸä¸åº”ç”¨ç›¸åŒã€‚

**èµ„æºéš”ç¦»**ï¼šRMå’ŒDispatcheræ˜¯åº”ç”¨çº§åˆ«ã€‚ 



![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_97b24136-1257-11ec-948d-00163e068ecd.png)

03ã€Flink æºç ç¯‡







![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a2b5376e-1257-11ec-948d-00163e068ecd.png)



> 55ã€FLinkä½œä¸šæäº¤æµç¨‹åº”è¯¥äº†è§£å§ï¼Ÿ

**Flinkçš„æäº¤æµç¨‹ï¼š**



1.åœ¨Flink Clientä¸­ï¼Œé€šè¿‡åå°„å¯åŠ¨jarä¸­çš„mainå‡½æ•°ï¼Œç”ŸæˆFlink StreamGraphå’ŒJobGraphï¼Œå°†JobGraphæäº¤ç»™Flinké›†ç¾¤

2.Flinké›†ç¾¤æ”¶åˆ°JobGraphï¼ˆJobManageræ”¶åˆ°ï¼‰åï¼Œå°†JobGraphç¿»è¯‘æˆExecutionGraph,ç„¶åå¼€å§‹è°ƒåº¦ï¼Œå¯åŠ¨æˆåŠŸä¹‹åå¼€å§‹æ¶ˆè´¹æ•°æ®ã€‚



æ€»ç»“æ¥è¯´ï¼šFlinkæ ¸å¿ƒæ‰§è¡Œæµç¨‹ï¼Œå¯¹ç”¨æˆ·APIçš„è°ƒç”¨å¯ä»¥è½¬ä¸º StreamGraph -->JobGraph -- > ExecutionGraphã€‚



> 56ã€FLinkä½œä¸šæäº¤åˆ†ä¸ºå‡ ç§æ–¹å¼ï¼Ÿ

**Flinkçš„ä½œä¸šæäº¤åˆ†ä¸ºä¸¤ç§æ–¹å¼**



**1.Local æ–¹å¼ï¼š**å³æœ¬åœ°æäº¤æ¨¡å¼ï¼Œç›´æ¥åœ¨IDEAè¿è¡Œä»£ç ã€‚



**2.è¿œç¨‹æäº¤æ–¹å¼ï¼š**åˆ†ä¸ºStandaloneæ–¹å¼ã€yarnæ–¹å¼ã€K8sæ–¹å¼



**Yarn æ–¹å¼åˆ†ä¸ºä¸‰ç§æäº¤æ¨¡å¼ï¼š**Yarn-perJobæ¨¡å¼ã€Yarn-Sessionmoæ¨¡å¼ã€Yarn-Applicationæ¨¡å¼

> 57ã€FLink JobGraphæ˜¯åœ¨ä»€ä¹ˆæ—¶å€™ç”Ÿæˆçš„ï¼Ÿ

StreamGraphã€JobGraphå…¨éƒ¨æ˜¯åœ¨Flink Client å®¢æˆ·ç«¯ç”Ÿæˆçš„ï¼Œå³æäº¤é›†ç¾¤ä¹‹å‰ç”Ÿæˆï¼ŒåŸç†å›¾å¦‚ä¸‹ï¼š

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a2d8fbae-1257-11ec-948d-00163e068ecd.png)



> 58ã€é‚£åœ¨jobGraphæäº¤é›†ç¾¤ä¹‹å‰éƒ½ç»å†å“ªäº›è¿‡ç¨‹ï¼Ÿ

ï¼ˆ1ï¼‰ç”¨æˆ·é€šè¿‡å¯åŠ¨Flinké›†ç¾¤ï¼Œä½¿ç”¨å‘½ä»¤è¡Œæäº¤ä½œä¸šï¼Œè¿è¡Œ flink run -c WordCount xxx.jar

ï¼ˆ2ï¼‰è¿è¡Œå‘½ä»¤è¡Œåï¼Œä¼šé€šè¿‡runè„šæœ¬è°ƒç”¨CliFrontendå…¥å£ï¼ŒCliFrontendä¼šè§¦å‘ç”¨æˆ·æäº¤çš„jaræ–‡ä»¶ä¸­çš„mainæ–¹æ³•ï¼Œç„¶åäº¤ç»™PipelineExecuteor # executeæ–¹æ³•ï¼Œæœ€ç»ˆæ ¹æ®æäº¤çš„æ¨¡å¼é€‰æ‹©è§¦å‘ä¸€ä¸ªå…·ä½“çš„PipelineExecutoræ‰§è¡Œã€‚

ï¼ˆ3ï¼‰æ ¹æ®å…·ä½“çš„PipelineExecutoræ‰§è¡Œï¼Œå°†å¯¹ç”¨æˆ·çš„ä»£ç è¿›è¡Œç¼–è¯‘ç”ŸæˆstreamGraphï¼Œç»è¿‡ä¼˜åŒ–åç”Ÿæˆjobgraphã€‚

**å…·ä½“æµç¨‹å›¾å¦‚ä¸‹ï¼š**

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a2fa7d9c-1257-11ec-948d-00163e068ecd.png)

> 59ã€çœ‹ä½ æåˆ°PipeExecutorï¼Œå®ƒæœ‰å“ªäº›å®ç°ç±»ï¼Ÿ

ï¼ˆ1ï¼‰PipeExecutor åœ¨Flinkä¸­è¢«å«åš æµæ°´çº¿æ‰§è¡Œå™¨ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ¥å£ï¼Œæ˜¯Flink Clientç”ŸæˆJobGraph ä¹‹åï¼Œå°†ä½œä¸šæäº¤ç»™é›†ç¾¤çš„é‡è¦ç¯èŠ‚ï¼Œå‰é¢è¯´è¿‡ï¼Œä½œä¸šæäº¤åˆ°é›†ç¾¤æœ‰å¥½å‡ ç§æ–¹å¼ï¼Œæœ€å¸¸ç”¨çš„æ˜¯yarnæ–¹å¼ï¼Œyarnæ–¹å¼åŒ…å«3ç§æäº¤æ¨¡å¼ï¼Œä¸»è¦ä½¿ç”¨ sessionæ¨¡å¼ï¼Œperjobæ¨¡å¼ã€‚Applicationæ¨¡å¼ jaobGraphæ˜¯åœ¨é›†ç¾¤ä¸­ç”Ÿæˆã€‚

æ‰€ä»¥PipeExecutor çš„å®ç°ç±»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼šï¼ˆåœ¨ä»£ç ä¸­æŒ‰CTRL+Hå°±ä¼šå‡ºæ¥ï¼‰

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a316d4ec-1257-11ec-948d-00163e068ecd.png)

é™¤äº†ä¸Šè¿°æ¡†çš„ä¸¤ç§æ¨¡å¼å¤–ï¼Œåœ¨IDEAç¯å¢ƒä¸­è¿è¡ŒFlink MiniCluster è¿›è¡Œè°ƒè¯•æ—¶ï¼Œä½¿ç”¨LocalExecutorã€‚

> 60ã€Localæäº¤æ¨¡å¼æœ‰å•¥ç‰¹ç‚¹ï¼Œæ€ä¹ˆå®ç°çš„ï¼Ÿ

ï¼ˆ1ï¼‰Localæ˜¯åœ¨æœ¬åœ°IDEAç¯å¢ƒä¸­è¿è¡Œçš„æäº¤æ–¹å¼ã€‚ä¸ä¸Šé›†ç¾¤ã€‚ä¸»è¦ç”¨äºè°ƒè¯•ï¼ŒåŸç†å›¾å¦‚ä¸‹ï¼š

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a332a352-1257-11ec-948d-00163e068ecd.png)

\1. Flinkç¨‹åºç”±JobClientè¿›è¡Œæäº¤ 

\2. JobClientå°†ä½œä¸šæäº¤ç»™JobManager 

\3. JobManagerè´Ÿè´£åè°ƒèµ„æºåˆ†é…å’Œä½œä¸šæ‰§è¡Œã€‚èµ„æºåˆ†é…å®Œæˆåï¼Œä»»åŠ¡å°†æäº¤ç»™ç›¸åº”çš„TaskManager

\4. TaskManagerå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å¼€å§‹æ‰§è¡Œï¼ŒTaskManagerä¼šå‘JobManageræŠ¥å‘ŠçŠ¶æ€æ›´æ”¹ï¼Œå¦‚å¼€å§‹æ‰§ è¡Œï¼Œæ­£åœ¨è¿›è¡Œæˆ–è€…å·²å®Œæˆã€‚ 

\5. ä½œä¸šæ‰§è¡Œå®Œæˆåï¼Œç»“æœå°†å‘é€å›å®¢æˆ·ç«¯ã€‚

**æºç åˆ†æï¼š****é€šè¿‡Flink1.12.2æºç è¿›è¡Œåˆ†æçš„**

**ï¼ˆ1ï¼‰åˆ›å»ºè·å–å¯¹åº”çš„StreamExecutionEnvironmentå¯¹è±¡**ï¼šLocalStreamEnvironment

è°ƒç”¨StreamExecutionEnvironmentå¯¹è±¡çš„executeæ–¹æ³•

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a354b5a0-1257-11ec-948d-00163e068ecd.png)

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a3782e54-1257-11ec-948d-00163e068ecd.png)

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a398c178-1257-11ec-948d-00163e068ecd.png)

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a3782e54-1257-11ec-948d-00163e068ecd.png)

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a3d4e9aa-1257-11ec-948d-00163e068ecd.png)

**ï¼ˆ2ï¼‰è·å–streamGraph**

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a3f4e494-1257-11ec-948d-00163e068ecd.png)

**ï¼ˆ3ï¼‰æ‰§è¡Œå…·ä½“çš„PipeLineExecutor - >å¾—åˆ°localExecutorFactory**

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a42058fe-1257-11ec-948d-00163e068ecd.png)

**(4) è·å–JobGraph
**

æ ¹æ®localExecutorFactoryçš„å®ç°ç±»LocalExecutorç”ŸæˆJobGraph

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a44d3cb6-1257-11ec-948d-00163e068ecd.png)

ä¸Šé¢è¿™éƒ¨åˆ†å…¨éƒ¨æ˜¯åœ¨Flink Clientç”Ÿæˆçš„ï¼Œç”±äºæ˜¯ä½¿ç”¨Localæ¨¡å¼æäº¤ã€‚æ‰€æœ‰æ¥ä¸‹æ¥å°†åˆ›å»ºMiniClusteré›†ç¾¤ï¼Œç”±miniCluster.submitJobæŒ‡å®šè¦æäº¤çš„jobGraph

**ï¼ˆ5ï¼‰å®ä¾‹åŒ–MiniClusteré›†ç¾¤**

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a46d51cc-1257-11ec-948d-00163e068ecd.png)

**ï¼ˆ6ï¼‰è¿”å›JobClient å®¢æˆ·ç«¯**

åœ¨ä¸Šé¢æ‰§è¡ŒminiCluster.submitJob å°†JobGraphæäº¤åˆ°æœ¬åœ°é›†ç¾¤åï¼Œä¼šè¿”å›ä¸€ä¸ªJobClientå®¢æˆ·ç«¯ï¼Œè¯¥JobClientåŒ…å«äº†åº”ç”¨çš„ä¸€äº›è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬JobID,åº”ç”¨çš„çŠ¶æ€ç­‰ç­‰ã€‚æœ€åè¿”å›åˆ°ä»£ç æ‰§è¡Œçš„ä¸Šä¸€å±‚ï¼Œå¯¹åº”ç±»ä¸ºStreamExecutionEnvironmentã€‚

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a497eef0-1257-11ec-948d-00163e068ecd.png)

**ä»¥ä¸Šå°±æ˜¯Localæ¨¡å¼çš„æºç æ‰§è¡Œè¿‡ç¨‹ã€‚**

> 61ã€è¿œç¨‹æäº¤æ¨¡å¼éƒ½æœ‰å“ªäº›ï¼Ÿ

**è¿œç¨‹æäº¤æ–¹å¼ï¼š**åˆ†ä¸ºStandaloneæ–¹å¼ã€yarnæ–¹å¼ã€K8sæ–¹å¼



**Standaloneï¼š**åŒ…å«sessionæ¨¡å¼



**Yarn æ–¹å¼åˆ†ä¸ºä¸‰ç§æäº¤æ¨¡å¼ï¼š**Yarn-perJobæ¨¡å¼ã€Yarn-Sessionmoæ¨¡å¼ã€Yarn-Applicationæ¨¡å¼ã€‚

**K8sæ–¹å¼ï¼š**åŒ…å« sessionæ¨¡å¼

> 62ã€Standaloneæ¨¡å¼ç®€å•ä»‹ç»ä¸€ä¸‹ï¼Ÿ

Standalone æ¨¡å¼ä¸ºFlinké›†ç¾¤çš„å•æœºç‰ˆæäº¤æ–¹å¼ï¼Œåªä½¿ç”¨ä¸€ä¸ªèŠ‚ç‚¹è¿›è¡Œæäº¤ï¼Œå¸¸ç”¨Sessionæ¨¡å¼ã€‚

ä½œä¸šæäº¤åŸç†å›¾å¦‚ä¸‹ï¼š

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a4baf774-1257-11ec-948d-00163e068ecd.png)

æäº¤å‘½ä»¤å¦‚ä¸‹ï¼š

```
bin/flink run org.apache.flink.WordCount xxx.jar
```

1. clientå®¢æˆ·ç«¯æäº¤ä»»åŠ¡ç»™JobManager
2. JobManagerè´Ÿè´£ç”³è¯·ä»»åŠ¡è¿è¡Œæ‰€éœ€è¦çš„èµ„æºå¹¶ç®¡ç†ä»»åŠ¡å’Œèµ„æºï¼Œ
3. JobManageråˆ†å‘ä»»åŠ¡ç»™TaskManageræ‰§è¡Œ
4. TaskManagerå®šæœŸå‘JobManageræ±‡æŠ¥çŠ¶æ€

> 63ã€yarné›†ç¾¤æäº¤æ–¹å¼ä»‹ç»ä¸€ä¸‹ï¼Ÿ

é€šè¿‡yarné›†ç¾¤æäº¤åˆ†ä¸º3ç§æäº¤æ–¹å¼ï¼šåˆ†åˆ«ä¸ºsessionæ¨¡å¼ã€perjobæ¨¡å¼ã€applicationæ¨¡å¼



> 64ã€yarn - sessionæ¨¡å¼ç‰¹ç‚¹ï¼Ÿ

æäº¤å‘½ä»¤å¦‚ä¸‹ï¼š



```
./bin/flink run -t yarn-session \
-Dyarn.application.id=application_XXXX_YY  xxx.jar
```

**Yarn-Sessionæ¨¡å¼ï¼š**æ‰€æœ‰**ä½œä¸šå…±äº«é›†ç¾¤èµ„æº**ï¼Œéš”ç¦»æ€§å·®ï¼ŒJMè´Ÿè½½ç“¶é¢ˆï¼Œmainæ–¹æ³•åœ¨å®¢æˆ·ç«¯æ‰§è¡Œã€‚é€‚åˆæ‰§è¡Œæ—¶é—´çŸ­ï¼Œé¢‘ç¹æ‰§è¡Œçš„çŸ­ä»»åŠ¡ï¼Œé›†ç¾¤ä¸­çš„æ‰€æœ‰ä½œä¸š **åªæœ‰ä¸€ä¸ªJobManager**ï¼Œå¦å¤–ï¼Œ**Jobè¢«éšæœºåˆ†é…ç»™TaskManager**

**ç‰¹ç‚¹ï¼š**

**Session-Clusteræ¨¡å¼éœ€è¦å…ˆå¯åŠ¨é›†ç¾¤**ï¼Œ**ç„¶åå†æäº¤ä½œä¸š**ï¼Œæ¥ç€ä¼šå‘yarnç”³è¯·ä¸€å—ç©ºé—´åï¼Œèµ„æºæ°¸è¿œä¿æŒä¸å˜ã€‚å¦‚æœèµ„æºæ»¡äº†ï¼Œä¸‹ä¸€ä¸ªä½œä¸šå°±æ— æ³•æäº¤ï¼Œåªèƒ½ç­‰åˆ° yarnä¸­çš„å…¶ä¸­ä¸€ä¸ªä½œä¸šæ‰§è¡Œå®Œæˆåï¼Œé‡Šæ”¾äº†èµ„æºï¼Œä¸‹ä¸ªä½œä¸šæ‰ä¼šæ­£å¸¸æäº¤ã€‚æ‰€æœ‰ä½œä¸šå…±äº«Dispatcherå’ŒResourceManagerï¼›å…±äº«èµ„æºï¼›é€‚åˆè§„æ¨¡å°æ‰§è¡Œæ—¶é—´çŸ­çš„ ä½œä¸šã€‚

**åŸç†å›¾å¦‚ä¸‹ï¼š**

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a4de3950-1257-11ec-948d-00163e068ecd.png)

> 65ã€yarn - perJobæ¨¡å¼ç‰¹ç‚¹ï¼Ÿ

æäº¤å‘½ä»¤ï¼š



```
./bin/flink run -t yarn-per-job --detached  xxx.jar
```

**Yarn-Per-Jobæ¨¡å¼ï¼š****æ¯ä¸ªä½œä¸šå•ç‹¬å¯åŠ¨é›†ç¾¤**ï¼Œéš”ç¦»æ€§å¥½ï¼ŒJMè´Ÿè½½å‡è¡¡ï¼Œmainæ–¹æ³•åœ¨å®¢æˆ·ç«¯æ‰§è¡Œã€‚åœ¨per-jobæ¨¡å¼ä¸‹ï¼Œæ¯ä¸ªJobéƒ½æœ‰ä¸€ä¸ªJobManagerï¼Œæ¯ä¸ªTaskManageråªæœ‰å•ä¸ªJobã€‚



**ç‰¹ç‚¹ï¼š**

**ä¸€ä¸ªä»»åŠ¡ä¼šå¯¹åº”ä¸€ä¸ªJob**ï¼Œ**æ¯æäº¤ä¸€ä¸ªä½œä¸š**ä¼šæ ¹æ®è‡ªèº«çš„æƒ…å†µï¼Œ**éƒ½ä¼šå•ç‹¬å‘yarnç”³è¯·èµ„æº**ï¼Œç›´åˆ°ä½œä¸šæ‰§è¡Œå®Œæˆï¼Œä¸€ä¸ªä½œä¸šçš„å¤±è´¥ä¸å¦å¹¶ä¸ä¼šå½±å“ä¸‹ä¸€ä¸ªä½œä¸šçš„æ­£å¸¸æäº¤å’Œè¿è¡Œã€‚ç‹¬äº«Dispatcher å’Œ ResourceManagerï¼ŒæŒ‰éœ€æ¥å—èµ„æºç”³è¯·ï¼›**é€‚åˆè§„æ¨¡å¤§é•¿æ—¶é—´è¿è¡Œçš„ä½œä¸šã€‚**



**åŸç†å›¾å¦‚ä¸‹ï¼š**

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a50b2d2a-1257-11ec-948d-00163e068ecd.png)



> 66ã€yarn - applicationæ¨¡å¼ç‰¹ç‚¹ï¼Ÿ

**æäº¤å‘½ä»¤å¦‚ä¸‹ï¼š**



```
./bin/flink run-application -t yarn-application xxx.jar
```

**Yarn-Applicationæ¨¡å¼ï¼š**æ¯ä¸ªä½œä¸šå•ç‹¬å¯åŠ¨é›†ç¾¤ï¼Œéš”ç¦»æ€§å¥½ï¼ŒJMè´Ÿè½½å‡è¡¡ï¼Œ**mainæ–¹æ³•åœ¨JobManagerä¸Šæ‰§è¡Œ**ã€‚



**ç‰¹ç‚¹ï¼š**

åœ¨yarn-per-job å’Œ yarn-sessionæ¨¡å¼ä¸‹ï¼Œå®¢æˆ·ç«¯éƒ½éœ€è¦æ‰§è¡Œä»¥ä¸‹ä¸‰æ­¥ï¼Œå³ï¼š 

1ã€è·å–ä½œä¸šæ‰€éœ€çš„ä¾èµ–é¡¹ï¼› 

2ã€é€šè¿‡æ‰§è¡Œç¯å¢ƒåˆ†æå¹¶å–å¾—é€»è¾‘è®¡åˆ’ï¼Œå³StreamGraphâ†’JobGraphï¼›

3ã€å°†ä¾èµ–é¡¹å’ŒJobGraphä¸Šä¼ åˆ°é›†ç¾¤ä¸­ã€‚ 

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a52d8dde-1257-11ec-948d-00163e068ecd.png)



åªæœ‰åœ¨è¿™äº›éƒ½å®Œæˆä¹‹åï¼Œæ‰ä¼šé€šè¿‡env.execute()æ–¹æ³• è§¦å‘ Flinkè¿è¡Œæ—¶çœŸæ­£åœ°å¼€å§‹æ‰§è¡Œä½œä¸šã€‚**å¦‚æœæ‰€æœ‰ç”¨æˆ·éƒ½åœ¨åŒä¸€ä¸ªå®¢æˆ·ç«¯ä¸Šæäº¤ä½œä¸š**ï¼Œ**è¾ƒå¤§çš„ä¾èµ–ä¼šæ¶ˆè€—æ›´å¤šçš„å¸¦å®½**ï¼Œè€Œè¾ƒå¤æ‚çš„ä½œä¸šé€»è¾‘ç¿»è¯‘æˆJobGraphä¹Ÿéœ€è¦åƒæ‰æ›´å¤šçš„CPUå’Œå†…å­˜ï¼Œ**å®¢æˆ·ç«¯çš„èµ„æºåè€Œä¼šæˆä¸ºç“¶é¢ˆ**ã€‚



ä¸ºäº†è§£å†³å®ƒï¼Œç¤¾åŒºåœ¨ä¼ ç»Ÿéƒ¨ç½²æ¨¡å¼çš„åŸºç¡€ä¸Šå®ç°äº† Applicationæ¨¡å¼ã€‚åŸæœ¬éœ€è¦å®¢æˆ·ç«¯åšçš„ä¸‰ä»¶äº‹è¢«è½¬ç§»åˆ°äº†JobManageré‡Œï¼Œä¹Ÿå°±æ˜¯è¯´main()æ–¹æ³•åœ¨é›†ç¾¤ä¸­æ‰§è¡Œ(å…¥å£ç‚¹ä½äº ApplicationClusterEntryPoint )ï¼Œå®¢ æˆ·ç«¯åªéœ€è¦è´Ÿè´£å‘èµ·éƒ¨ç½²è¯·æ±‚äº†

**åŸç†å›¾å¦‚ä¸‹ï¼š**

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a54a45fa-1257-11ec-948d-00163e068ecd.png)



**ç»¼ä¸Šæ‰€è¿°ï¼ŒFlinkç¤¾åŒºæ¯”è¾ƒæ¨èä½¿ç”¨ yarn-perjob  æˆ–è€… yarn-applicationæ¨¡å¼è¿›è¡Œæäº¤åº”ç”¨ã€‚**



> 67ã€yarn - session æäº¤æµç¨‹è¯¦ç»†ä»‹ç»ä¸€ä¸‹ï¼Ÿ

**æäº¤æµç¨‹å›¾å¦‚ä¸‹ï¼š**

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a56832c2-1257-11ec-948d-00163e068ecd.png)

**1ã€å¯åŠ¨é›†ç¾¤**

**ï¼ˆ1ï¼‰Flink Clientå‘Yarn ResourceManageræäº¤ä»»åŠ¡ä¿¡æ¯ã€‚**

â€‹    1ï¼‰Flink Clientå°†åº”ç”¨é…ç½®ï¼ˆFlink-conf.yamlã€logback.xmlã€log4j.propertiesï¼‰å’Œç›¸å…³æ–‡ä»¶ï¼ˆFlink Jarã€é…ç½®ç±»æ–‡ä»¶ã€ç”¨æˆ·Jaræ–‡ä»¶ã€JobGraphå¯¹è±¡ç­‰ï¼‰ä¸Šä¼ è‡³åˆ†å¸ƒå¼å­˜å‚¨HDFSä¸­ã€‚

â€‹    2ï¼‰Flink Clientå‘Yarn ResourceManageræäº¤ä»»åŠ¡ä¿¡æ¯

**ï¼ˆ2ï¼‰Yarn å¯åŠ¨ Flinké›†ç¾¤ï¼Œåš2æ­¥æ“ä½œï¼š**

â€‹    \1) **é€šè¿‡Yarn Client å‘Yarn  ResourceManageræäº¤Flinkåˆ›å»ºé›†ç¾¤çš„ç”³è¯·**ï¼ŒYarn ResourceManager åˆ†é…Container èµ„æºï¼Œå¹¶é€šçŸ¥å¯¹åº”çš„NodeManagerä¸Šå¯åŠ¨ä¸€ä¸ªApplicationMaster(æ¯æäº¤ä¸€ä¸ªflink job å°±ä¼šå¯åŠ¨ä¸€ä¸ªapplicationMaster)ï¼ŒApplicationMasterä¼šåŒ…å«å½“å‰è¦å¯åŠ¨çš„ JobManagerå’Œ Flinkè‡ªå·±å†…éƒ¨è¦ä½¿ç”¨çš„ResourceManagerã€‚

â€‹    2ï¼‰åœ¨JobManager è¿›ç¨‹ä¸­è¿è¡Œ**YarnSessionClusterEntryPoint** ä½œä¸ºé›†ç¾¤å¯åŠ¨çš„å…¥å£ã€‚åˆå§‹åŒ–Dispatcherï¼ŒFlinkè‡ªå·±å†…éƒ¨è¦ä½¿ç”¨çš„ResourceManagerï¼Œå¯åŠ¨ç›¸å…³RPCæœåŠ¡ï¼Œç­‰å¾…Flink Client é€šè¿‡Restæ¥å£æäº¤JobGraphã€‚



**2ã€ä½œä¸šæäº¤**



**ï¼ˆ3ï¼‰Flink Client é€šè¿‡Rest å‘Dispatcher æäº¤ç¼–è¯‘å¥½çš„JobGraphã€‚**Dispatcher æ˜¯ Rest æ¥å£ï¼Œä¸è´Ÿè´£å®é™…çš„è°ƒåº¦ã€æŒ‡å®šå·¥ä½œã€‚

**ï¼ˆ4ï¼‰\**Dispatcher æ”¶åˆ° \*\*JobGraph\*\* åï¼Œä¸ºä½œä¸šåˆ›å»ºä¸€ä¸ªJobMasterï¼Œå°†å·¥ä½œäº¤ç»™JobMasterï¼Œ\****JobMasterè´Ÿè´£ä½œä¸šè°ƒåº¦ï¼Œç®¡ç†ä½œä¸šå’ŒTaskçš„ç”Ÿå‘½å‘¨æœŸ**ï¼Œæ„å»ºExecutionGraphï¼ˆ**JobGraphçš„å¹¶è¡ŒåŒ–ç‰ˆæœ¬ï¼Œè°ƒåº¦å±‚æœ€æ ¸å¿ƒçš„æ•°æ®ç»“æ„***\*ï¼‰\****

**ä»¥ä¸Šä¸¤æ­¥æ‰§è¡Œå®Œåï¼Œä½œä¸šè¿›å…¥è°ƒåº¦æ‰§è¡Œé˜¶æ®µã€‚**



**3ã€ä½œä¸šè°ƒåº¦æ‰§è¡Œ**

**ï¼ˆ5ï¼‰JobMasterå‘ResourceManagerç”³è¯·èµ„æºï¼Œå¼€å§‹è°ƒåº¦ExecutionGraphã€‚**

ï¼ˆ6ï¼‰ResourceManagerå°†èµ„æºè¯·æ±‚åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œé€šè¿‡å¿ƒè·³å‘YarnResourceManagerç”³è¯·æ–°çš„Containeræ¥å¯åŠ¨TaskManagerè¿›ç¨‹ã€‚

ï¼ˆ7ï¼‰YarnResourceManagerå¯åŠ¨ï¼Œç„¶åä»HDFSåŠ è½½Jaræ–‡ä»¶ç­‰æ‰€éœ€ç›¸å…³èµ„æºï¼Œåœ¨å®¹å™¨ä¸­å¯åŠ¨TaskManagerï¼ŒTaskManagerå¯åŠ¨TaskExecutor

ï¼ˆ8ï¼‰TaskManagerå¯åŠ¨å,å‘ResourceManager æ³¨å†Œï¼Œå¹¶æŠŠè‡ªå·±çš„Slotèµ„æºæƒ…å†µæ±‡æŠ¥ç»™ResourceManagerã€‚

ï¼ˆ9ï¼‰ResourceManagerä»ç­‰å¾…é˜Ÿåˆ—å–å‡ºSlotè¯·æ±‚ï¼Œå‘TaskManagerç¡®è®¤èµ„æºå¯ç”¨æƒ…å†µï¼Œå¹¶å‘ŠçŸ¥TaskManagerå°†Slotåˆ†é…ç»™å“ªä¸ªJobMasterã€‚

ï¼ˆ10ï¼‰TaskManagerå‘JobMasterå›å¤è‡ªå·±çš„ä¸€ä¸ªSlotå±äºä½ è¿™ä¸ªä»»åŠ¡ï¼ŒJobMaserä¼šå°†Slotç¼“å­˜åˆ°SlotPoolã€‚

ï¼ˆ11ï¼‰JobMasterè°ƒåº¦Taskåˆ°TaskMnagerçš„Slotä¸Šæ‰§è¡Œã€‚

> 68ã€yarn - perjob æäº¤æµç¨‹è¯¦ç»†ä»‹ç»ä¸€ä¸‹ï¼Ÿ

**æäº¤å‘½ä»¤å¦‚ä¸‹ï¼š**



```
./bin/flink run -t yarn-per-job --detached  xxx.jar
```

**æäº¤æµç¨‹å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š**



![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a59030ce-1257-11ec-948d-00163e068ecd.png)



**1ã€å¯åŠ¨é›†ç¾¤**

**ï¼ˆ1ï¼‰Flink Clientå‘Yarn ResourceManageræäº¤ä»»åŠ¡ä¿¡æ¯ã€‚**

â€‹    1ï¼‰Flink Clientå°†åº”ç”¨é…ç½®ï¼ˆFlink-conf.yamlã€logback.xmlã€log4j.propertiesï¼‰å’Œç›¸å…³æ–‡ä»¶ï¼ˆFlink Jarã€é…ç½®ç±»æ–‡ä»¶ã€ç”¨æˆ·Jaræ–‡ä»¶ã€JobGraphå¯¹è±¡ç­‰ï¼‰ä¸Šä¼ è‡³åˆ†å¸ƒå¼å­˜å‚¨HDFSä¸­ã€‚

â€‹    2ï¼‰Flink Clientå‘Yarn ResourceManageræäº¤ä»»åŠ¡ä¿¡æ¯

**ï¼ˆ2ï¼‰Yarn å¯åŠ¨ Flinké›†ç¾¤ï¼Œåš2æ­¥æ“ä½œï¼š**

â€‹    \1) **é€šè¿‡Yarn Client å‘Yarn  ResourceManageræäº¤Flinkåˆ›å»ºé›†ç¾¤çš„ç”³è¯·**ï¼ŒYarn ResourceManager åˆ†é…Container èµ„æºï¼Œå¹¶é€šçŸ¥å¯¹åº”çš„NodeManagerä¸Šå¯åŠ¨ä¸€ä¸ªApplicationMaster(æ¯æäº¤ä¸€ä¸ªFlink job å°±ä¼šå¯åŠ¨ä¸€ä¸ªApplicationMaster)ï¼ŒApplicationMasterä¼šåŒ…å«å½“å‰è¦å¯åŠ¨çš„ JobManagerå’Œ Flinkè‡ªå·±å†…éƒ¨è¦ä½¿ç”¨çš„ResourceManagerã€‚

â€‹    2ï¼‰åœ¨JobManager è¿›ç¨‹ä¸­è¿è¡Œ**YarnJobClusterEntryPoint** ä½œä¸ºé›†ç¾¤å¯åŠ¨çš„å…¥å£ã€‚åˆå§‹åŒ–Dispatcherï¼ŒFlinkè‡ªå·±å†…éƒ¨è¦ä½¿ç”¨çš„ResourceManagerï¼Œå¯åŠ¨ç›¸å…³RPCæœåŠ¡ï¼Œç­‰å¾…Flink Client é€šè¿‡Restæ¥å£æäº¤JobGraphã€‚



**2ã€ä½œä¸šæäº¤**



**ï¼ˆ3ï¼‰ApplicationMasterå¯åŠ¨Dispatcherï¼Œ\**Dispatcher\**å¯åŠ¨ResourceManagerå’ŒJobMaster****(è¯¥æ­¥å’ŒSessionä¸åŒï¼ŒJabmasteræ˜¯ç”±Dispatcheræ‹‰èµ·ï¼Œè€Œä¸æ˜¯Clientä¼ è¿‡æ¥çš„)ã€‚**JobMasterè´Ÿè´£ä½œä¸šè°ƒåº¦ï¼Œç®¡ç†ä½œä¸šå’ŒTaskçš„ç”Ÿå‘½å‘¨æœŸ**ï¼Œæ„å»ºExecutionGraphï¼ˆ**JobGraphçš„å¹¶è¡ŒåŒ–ç‰ˆæœ¬ï¼Œè°ƒåº¦å±‚æœ€æ ¸å¿ƒçš„æ•°æ®ç»“æ„***\*ï¼‰\****



**ä»¥ä¸Šä¸¤æ­¥æ‰§è¡Œå®Œåï¼Œä½œä¸šè¿›å…¥è°ƒåº¦æ‰§è¡Œé˜¶æ®µã€‚**



**3ã€ä½œä¸šè°ƒåº¦æ‰§è¡Œ**

**ï¼ˆ4ï¼‰JobMasterå‘ResourceManagerç”³è¯·Slotèµ„æºï¼Œå¼€å§‹è°ƒåº¦ExecutionGraphã€‚**

ï¼ˆ5ï¼‰ResourceManagerå°†èµ„æºè¯·æ±‚åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œé€šè¿‡å¿ƒè·³å‘YarnResourceManagerç”³è¯·æ–°çš„Containeræ¥å¯åŠ¨TaskManagerè¿›ç¨‹ã€‚

ï¼ˆ6ï¼‰YarnResourceManagerå¯åŠ¨ï¼Œç„¶åä»HDFSåŠ è½½Jaræ–‡ä»¶ç­‰æ‰€éœ€ç›¸å…³èµ„æºï¼Œåœ¨å®¹å™¨ä¸­å¯åŠ¨TaskManagerã€‚

ï¼ˆ7ï¼‰TaskManageråœ¨å†…éƒ¨å¯åŠ¨TaskExecutorã€‚

ï¼ˆ8ï¼‰TaskManagerå¯åŠ¨å,å‘ResourceManager æ³¨å†Œï¼Œå¹¶æŠŠè‡ªå·±çš„Slotèµ„æºæƒ…å†µæ±‡æŠ¥ç»™ResourceManagerã€‚

ï¼ˆ9ï¼‰ResourceManagerä»ç­‰å¾…é˜Ÿåˆ—å–å‡ºSlotè¯·æ±‚ï¼Œå‘TaskManagerç¡®è®¤èµ„æºå¯ç”¨æƒ…å†µï¼Œå¹¶å‘ŠçŸ¥TaskManagerå°†Slotåˆ†é…ç»™å“ªä¸ªJobMasterã€‚

ï¼ˆ10ï¼‰TaskManagerå‘JobMasterå›å¤è‡ªå·±çš„ä¸€ä¸ªSlotå±äºä½ è¿™ä¸ªä»»åŠ¡ï¼ŒJobMaserä¼šå°†Slotç¼“å­˜åˆ°SlotPoolã€‚

ï¼ˆ11ï¼‰JobMasterè°ƒåº¦Taskåˆ°TaskMnagerçš„Slotä¸Šæ‰§è¡Œã€‚

> 69ã€æµå›¾ã€ä½œä¸šå›¾ã€æ‰§è¡Œå›¾ä¸‰è€…åŒºåˆ«ï¼Ÿ

**Flinkå†…éƒ¨Graphæ€»è§ˆå›¾ï¼Œç”±äºç°åœ¨Flink å®è¡Œæµæ‰¹ä¸€ä½“ä»£ç ï¼ŒBatch APIåŸºæœ¬åºŸå¼ƒï¼Œå°±ä¸è¿‡å¤šä»‹ç» 
**

**åœ¨Flink DataStramAPI ä¸­ï¼ŒGraphå†…éƒ¨è½¬æ¢å›¾å¦‚ä¸‹ï¼š**

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a5baad90-1257-11ec-948d-00163e068ecd.png)



**ä»¥WordCountä¸ºä¾‹ï¼Œæµå›¾ã€ä½œä¸šå›¾ã€æ‰§è¡Œå›¾ã€ç‰©ç†æ‰§è¡Œå›¾ä¹‹é—´çš„Taskè°ƒåº¦å¦‚ä¸‹ï¼š**



![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a5db066c-1257-11ec-948d-00163e068ecd.png)

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a60754ba-1257-11ec-948d-00163e068ecd.png)

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a62a6036-1257-11ec-948d-00163e068ecd.png)



å¯¹äºFlink æµè®¡ç®—åº”ç”¨ï¼Œè¿è¡Œç”¨æˆ·ä»£ç æ—¶ï¼Œé¦–å…ˆè°ƒç”¨DataStream API ï¼Œå°†ç”¨æˆ·ä»£ç è½¬æ¢ä¸º **Transformation**ï¼Œç„¶åç»è¿‡ï¼š**StreamGraph**->**JobGraph**->**ExecutionGraph** 3å±‚è½¬æ¢ï¼ˆè¿™äº›éƒ½æ˜¯Flinkå†…ç½®çš„æ•°æ®ç»“æ„ï¼‰ï¼Œæœ€åç»è¿‡Flinkè°ƒåº¦æ‰§è¡Œï¼Œåœ¨Flink é›†ç¾¤ä¸­å¯åŠ¨è®¡ç®—ä»»åŠ¡ï¼Œå½¢æˆä¸€ä¸ª**ç‰©ç†æ‰§è¡Œå›¾**ã€‚

> 70ã€æµå›¾ä»‹ç»ä¸€ä¸‹ï¼Ÿ

**ï¼ˆ1ï¼‰æµå›¾ StreamGraph**



![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a6585c8e-1257-11ec-948d-00163e068ecd.png)

æµå›¾StreamGraph æ ¸å¿ƒå¯¹è±¡åŒ…æ‹¬ä¸¤ä¸ªï¼š**StreamNode ç‚¹ å’Œ** **StreamEdge è¾¹**

  **1ï¼‰StreamNode ç‚¹**



**StreamNode ç‚¹** ï¼Œä» Transformationè½¬æ¢è€Œæ¥ï¼Œå¯ä»¥ç®€å•ç†è§£ä¸º **StreamNode** è¡¨ç¤ºä¸€ä¸ªç®—å­ï¼Œå­˜åœ¨å®ä½“å’Œè™šæ‹Ÿï¼Œå¯ä»¥æœ‰å¤šä¸ªè¾“å…¥å’Œè¾“å‡ºï¼Œå®ä½“**StreamNode** æœ€ç»ˆå˜æˆç‰©ç†ç®—å­ï¼Œè™šæ‹Ÿçš„é™„ç€åœ¨**StreamEdge è¾¹** ä¸Šã€‚



  **2ï¼‰****StreamEdge è¾¹**



**StreamEdge æ˜¯ \**StreamGraph çš„è¾¹ï¼Œ\****ç”¨æ¥è¿æ¥ä¸¤ä¸ªStreamNode ç‚¹ï¼Œä¸€ä¸ªStreamEdgeå¯ä»¥æœ‰å¤šä¸ªå‡ºè¾¹ã€å…¥è¾¹ç­‰ä¿¡æ¯ã€‚

> 71ã€ä½œä¸šå›¾ä»‹ç»ä¸€ä¸‹ï¼Ÿ

**ï¼ˆ2ï¼‰ä½œä¸šå›¾ JobGraph**



JobGraphæ˜¯ç”±StreamGraphä¼˜åŒ–è€Œæ¥ï¼Œæ˜¯é€šè¿‡**OperationChain** æœºåˆ¶å°†ç®—å­åˆå¹¶èµ·æ¥ï¼Œåœ¨æ‰§è¡Œæ—¶ï¼Œè°ƒåº¦åœ¨åŒä¸€ä¸ªTaskçº¿ç¨‹ä¸Šï¼Œé¿å…æ•°æ®çš„è·¨çº¿ç¨‹ï¼Œè·¨ç½‘ç»œä¼ é€’ã€‚



![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a6748698-1257-11ec-948d-00163e068ecd.png)

ä½œä¸šå›¾JobGraph æ ¸å¿ƒå¯¹è±¡åŒ…æ‹¬ä¸‰ä¸ªï¼š

**JobVertex ç‚¹** **ã€** **Job****Edge è¾¹****ã€****IntermediateDataSet ä¸­é—´æ•°æ®é›†**



**1ï¼‰JobVertex ç‚¹** 

ç»è¿‡ç®—å­èåˆä¼˜åŒ–åç¬¦åˆæ¡ä»¶çš„å¤šä¸ªStreamNode å¯èƒ½ä¼šèåˆåœ¨ä¸€èµ·ç”Ÿæˆä¸€ä¸ª JobVertexï¼Œå³ä¸€ä¸ªJobVertex åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªç®—å­ï¼Œ **JobVertex çš„è¾“å…¥æ˜¯ JobEdge.** **è¾“å‡ºæ˜¯** ***\*IntermediateDataSet\**** 



**2ï¼‰****Job****Edge è¾¹**



**Job****Edge** è¡¨ç¤º JobGraph ä¸­çš„ä¸€ ä¸ªæ•°æ®æµè½¬é€šé“ï¼Œ å…¶ä¸Šæ¸¸æ•°æ®æºæ˜¯ ***\*IntermediateDataSet\**** ï¼Œä¸‹æ¸¸æ¶ˆè´¹è€…æ˜¯ ***\*JobVertex\**** ã€‚

**Job****Edge** ä¸­çš„æ•°æ®åˆ†å‘æ¨¡å¼ä¼šç›´æ¥å½±å“æ‰§è¡Œæ—¶ Task ä¹‹é—´çš„æ•°æ®è¿æ¥å…³ç³»æ˜¯**ç‚¹å¯¹ç‚¹è¿æ¥**è¿˜æ˜¯**å…¨è¿æ¥**ã€‚



**3ï¼‰****IntermediateDataSet ä¸­é—´æ•°æ®é›†**

ä¸­é—´æ•°æ®é›† **IntermediateDataSet** æ˜¯ä¸€ç§é€»è¾‘ç»“æ„.ç”¨æ¥è¡¨ç¤º ***\*JobVertex\**** çš„è¾“å‡ºï¼Œå³è¯¥ JobVertex ä¸­åŒ…å«çš„ç®—å­ä¼šäº§ç”Ÿçš„æ•°æ®é›†ã€‚ä¸åŒçš„æ‰§è¡Œæ¨¡å¼ä¸‹ï¼Œå…¶å¯¹åº”çš„ç»“æœåˆ†åŒºç±»å‹ä¸åŒï¼Œå†³ å®šäº†åœ¨æ‰§è¡Œæ—¶åˆ»æ•°æ®äº¤æ¢çš„æ¨¡å¼ã€‚

> 72ã€æ‰§è¡Œå›¾ä»‹ç»ä¸€ä¸‹ï¼Ÿ



**ï¼ˆ3ï¼‰æ‰§è¡Œå›¾ ExecutionGraph**



**ExecutionGraph**æ˜¯è°ƒåº¦Flink ä½œä¸šæ‰§è¡Œçš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼ŒåŒ…å«äº†ä½œä¸šä¸­æ‰€æœ‰å¹¶è¡Œæ‰§è¡Œçš„Taskä¿¡æ¯ã€Taskä¹‹é—´çš„å…³è”å…³ç³»ã€æ•°æ®æµè½¬å…³ç³»ã€‚

StreamGraph å’ŒJobGraphéƒ½åœ¨Flink Clientç”Ÿæˆï¼Œç„¶åäº¤ç»™Flinké›†ç¾¤ã€‚JobGraphåˆ°ExecutionGraphåœ¨JobMasterä¸­ å®Œæˆï¼Œè½¬æ¢è¿‡ç¨‹ä¸­é‡è¦å˜åŒ–å¦‚ä¸‹ï¼š

**1ï¼‰åŠ å…¥äº†å¹¶è¡Œåº¦çš„æ¦‚å¿µï¼Œæˆä¸ºçœŸæ­£å¯è°ƒåº¦çš„å›¾ç»“æ„ã€‚**

**2ï¼‰ç”Ÿæˆäº†6ä¸ªæ ¸å¿ƒå¯¹è±¡ã€‚**



![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a69524de-1257-11ec-948d-00163e068ecd.png)



**æ‰§è¡Œå›¾ExecutionGraph æ ¸å¿ƒå¯¹è±¡åŒ…æ‹¬6ä¸ªï¼š**

ExecutionJobVertexã€ExecutionVertexã€IntermediateResultã€IntermediateResultPartitionã€ExecutionEdgeã€Executionã€‚



**1ï¼‰ExecutionJobVertex**

è¯¥å¯¹è±¡å’Œ JobGraph ä¸­çš„ JobVertex ä¸€ ä¸€å¯¹åº”ã€‚è¯¥å¯¹è±¡è¿˜åŒ…å«ä¸€ç»„ ExecutionVertexï¼Œ æ•°é‡ ä¸è¯¥ JobVertex ä¸­æ‰€åŒ…å«çš„StreamNode çš„å¹¶è¡Œåº¦ä¸€è‡´ï¼Œå‡è®¾ StreamNode çš„å¹¶è¡Œåº¦ä¸º5 ï¼Œé‚£ä¹ˆ**ExecutionJobVertex**ä¸­ä¹Ÿä¼šåŒ…å« 5ä¸ª**ExecutionVertex**ã€‚

**ExecutionJobVertex**ç”¨æ¥å°†ä¸€ä¸ªJobVertex å°è£…æˆ ***\*ExecutionJobVertex\****ï¼Œå¹¶ä¾æ¬¡åˆ›å»º ExecutionVertexã€Executionã€IntermediateResult å’Œ IntermediateResultPartitionï¼Œç”¨äºä¸°å¯Œ**ExecutionGraphã€‚**



**2ï¼‰ExecutionVertex**

**ExecutionJobVertex**ä¼šå¯¹ä½œä¸šè¿›è¡Œå¹¶è¡ŒåŒ–å¤„ç†ï¼Œæ„é€ å¯ä»¥å¹¶è¡Œæ‰§è¡Œçš„å®ä¾‹ï¼Œæ¯ä¸€ä¸ªå¹¶è¡Œæ‰§è¡Œçš„å®ä¾‹å°±æ˜¯ **ExecutionVertex**ã€‚



**3ï¼‰IntermediateResult**

**IntermediateResult** åˆå«ä½œä¸­é—´ç»“æœé›†ï¼Œè¯¥å¯¹è±¡æ˜¯ä¸ªé€»è¾‘æ¦‚å¿µ è¡¨ç¤º **ExecutionJobVertex**è¾“å‡ºï¼Œå’Œ JobGrap ä¸­çš„IntermediateDalaSet ä¸€ ä¸€å¯¹åº”ï¼ŒåŒæ · ä¸€ä¸ª**ExecutionJobVertex** å¯ä»¥æœ‰å¤šä¸ªä¸­é—´ç»“æœï¼Œå–å†³äºå½“å‰ JobVertex æœ‰å‡ ä¸ªå‡ºè¾¹(JobEdge)ã€‚



**4ï¼‰IntermediateResultPartition**

**IntermediateResultPartition** åˆå«ä½œä¸­é—´ç»“æœåˆ†åŒºã€‚è¡¨ç¤º1ä¸ª **ExecutionVertex**è¾“å‡ºç»“æœï¼Œä¸ Execution Edge ç›¸å…³è”ã€‚



**5ï¼‰ExecutionEdge**

è¡¨ç¤º**ExecutionVertex** çš„è¾“å…¥ï¼Œè¿æŒ‰åˆ°ä¸Šæ¸¸äº§ç”Ÿçš„**IntermediateResultPartition** ã€‚1ä¸ªExecutionå¯¹åº”å”¯ä¸€çš„1ä¸ª**IntermediateResultPartition** å’Œ1ä¸ª**ExecutionVertex**ã€‚1ä¸ª**ExecutionVertex** å¯ä»¥æœ‰å¤šä¸ª**ExecutionEdgeã€‚**



**6ï¼‰****Execution**

**ExecutionVertex** ç›¸å½“äºæ¯ä¸ª Task çš„æ¨¡æ¿ï¼Œåœ¨çœŸæ­£æ‰§è¡Œçš„æ—¶å€™ï¼Œä¼šå°†**ExecutionVertexä¸­çš„ä¿¡æ¯åŒ…è£…ä¸º1ä¸ª****Executionï¼Œæ‰§è¡Œä¸€ä¸ªExecutionVertexçš„ä¸€æ¬¡å°è¯•ã€‚**



JobManager å’Œ TaskManager ä¹‹é—´å…³äºTask çš„éƒ¨ç½²å’ŒTaskæ‰§è¡ŒçŠ¶æ€çš„æ›´æ–°éƒ½æ˜¯é€šè¿‡ExecutionAttemptIDæ¥è¯†åˆ«æ ‡è¯†çš„ã€‚



**æ¥ä¸‹æ¥é—®é—®ä½œä¸šè°ƒåº¦çš„é—®é¢˜**



> 73ã€Flinkè°ƒåº¦å™¨çš„æ¦‚å¿µä»‹ç»ä¸€ä¸‹ï¼Ÿ

**è°ƒåº¦å™¨**æ˜¯Flinkä½œä¸šæ‰§è¡Œçš„æ ¸å¿ƒç»„ä»¶ï¼Œç®¡ç†ä½œä¸šæ‰§è¡Œçš„æ‰€æœ‰ç›¸å…³è¿‡ç¨‹ï¼ŒåŒ…æ‹¬JobGraphåˆ°ExecutionGraphçš„è½¬æ¢ã€ä½œä¸šç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆä½œä¸šçš„å‘å¸ƒã€å–æ¶ˆã€åœæ­¢ï¼‰ã€ä½œä¸šçš„Taskç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆTaskçš„å‘å¸ƒã€å–æ¶ˆã€åœæ­¢ï¼‰ã€èµ„æºç”³è¯·ä¸é‡Šæ”¾ã€ä½œä¸šå’ŒTaskçš„Failloverç­‰ã€‚

**ï¼ˆ1ï¼‰DefaultScheduler**



Flink ç›®å‰é»˜è®¤çš„è°ƒåº¦å™¨ã€‚æ˜¯Flinkæ–°çš„è°ƒåº¦è®¾è®¡ï¼Œä½¿ç”¨SchedulerStrategyæ¥å®ç°è°ƒåº¦ã€‚



**ï¼ˆ2ï¼‰LegacySchedular**

è¿‡å»çš„è°ƒåº¦å™¨ï¼Œå®ç°äº†åŸæ¥çš„Executionè°ƒåº¦é€»è¾‘ã€‚

> 74ã€Flinkè°ƒåº¦è¡Œä¸ºåŒ…å«å‡ ç§ï¼Ÿ

**è°ƒåº¦è¡Œä¸ºåŒ…å«å››ç§ï¼š**



SchedulerStrategyæ¥å£å®šä¹‰äº†è°ƒåº¦è¡Œä¸ºï¼Œå…¶ä¸­åŒ…å«4ç§è¡Œä¸ºï¼š

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a6e0b93a-1257-11ec-948d-00163e068ecd.png)



ï¼ˆ1ï¼‰startScheduling:è°ƒåº¦å…¥å£ï¼Œè§¦å‘è°ƒåº¦å™¨çš„è°ƒåº¦è¡Œä¸º

ï¼ˆ2ï¼‰restartTasks:é‡å¯æ‰§è¡Œå¤±è´¥çš„Task,ä¸€èˆ¬æ˜¯Taskæ‰§è¡Œå¼‚å¸¸å¯¼è‡´çš„ã€‚

ï¼ˆ3ï¼‰onExecutionStateChangeï¼šå½“ExecutionçŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ã€‚

ï¼ˆ4ï¼‰onPartitionConsumableï¼šå½“IntermediateResultPartitionä¸­çš„æ•°æ®å¯ä»¥æ¶ˆè´¹æ—¶ã€‚



> 75ã€Flinkè°ƒåº¦æ¨¡å¼åŒ…å«å‡ ç§ï¼Ÿ

**è°ƒåº¦æ¨¡å¼åŒ…å«3ç§ï¼š****Eageræ¨¡å¼ã€åˆ†é˜¶æ®µæ¨¡å¼ï¼ˆLazy_From_Sourceï¼‰ã€åˆ†é˜¶æ®µSloté‡ç”¨æ¨¡å¼ï¼ˆLazy_From_Sources_With_Batch_Slot_Requestï¼‰ã€‚**

**1ï¼‰Eager è°ƒåº¦**

ã€€ã€€**é€‚ç”¨äºæµè®¡ç®—**ã€‚ä¸€æ¬¡æ€§ç”³è¯·éœ€è¦çš„æ‰€æœ‰èµ„æºï¼Œå¦‚æœèµ„æºä¸è¶³ï¼Œåˆ™ä½œä¸šå¯åŠ¨å¤±è´¥ã€‚

**2ï¼‰åˆ†é˜¶æ®µè°ƒåº¦**

ã€€ã€€LAZY_FROM_SOURCES **é€‚ç”¨äºæ‰¹å¤„ç†**ã€‚ä» SourceTask å¼€å§‹åˆ†é˜¶æ®µè°ƒåº¦ï¼Œç”³è¯·èµ„æºçš„æ—¶å€™ï¼Œä¸€æ¬¡æ€§ç”³è¯·æœ¬é˜¶æ®µæ‰€éœ€è¦çš„æ‰€æœ‰èµ„æºã€‚ä¸Šæ¸¸ Task æ‰§è¡Œå®Œæ¯•åå¼€å§‹è°ƒåº¦æ‰§è¡Œä¸‹æ¸¸çš„ Taskï¼Œ

è¯»å–ä¸Šæ¸¸çš„æ•°æ®ï¼Œæ‰§è¡Œæœ¬é˜¶æ®µçš„è®¡ç®—ä»»åŠ¡ï¼Œæ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œè°ƒåº¦åä¸€ä¸ªé˜¶æ®µçš„ Taskï¼Œä¾æ¬¡è¿›è¡Œè°ƒåº¦ï¼Œç›´åˆ°ä½œä¸šå®Œæˆã€‚

**3ï¼‰åˆ†é˜¶æ®µ Slot é‡ç”¨è°ƒåº¦**

ã€€ã€€LAZY_FROM_SOURCES_WITH_BATCH_SLOT_REQUEST **é€‚ç”¨äºæ‰¹å¤„ç†**ã€‚ä¸åˆ†é˜¶æ®µè°ƒåº¦åŸºæœ¬ä¸€æ ·ï¼ŒåŒºåˆ«åœ¨äºè¯¥æ¨¡å¼ä¸‹ä½¿ç”¨æ‰¹å¤„ç†èµ„æºç”³è¯·æ¨¡å¼ï¼Œå¯ä»¥åœ¨èµ„æºä¸è¶³çš„æƒ…å†µä¸‹æ‰§è¡Œä½œ

ä¸šï¼Œä½†æ˜¯éœ€è¦ç¡®ä¿åœ¨æœ¬é˜¶æ®µçš„ä½œä¸šæ‰§è¡Œä¸­æ²¡æœ‰ Shuffle è¡Œä¸ºã€‚

ã€€ã€€ç›®å‰è§†çº¿ä¸­çš„ Eager æ¨¡å¼å’Œ LAZY_FROM_SOURCES æ¨¡å¼çš„èµ„æºç”³è¯·é€»è¾‘ä¸€æ ·ï¼ŒLAZY_FROM_SOURCES_WITH_BATCH_SLOT_REQUEST æ˜¯å•ç‹¬çš„èµ„æºç”³è¯·é€»è¾‘ã€‚



> 76ã€Flinkè°ƒåº¦ç­–ç•¥åŒ…å«å‡ ç§ï¼Ÿ

**è°ƒåº¦ç­–ç•¥åŒ…å«3ç§ï¼š**

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a6f8b6a2-1257-11ec-948d-00163e068ecd.png)

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a7137262-1257-11ec-948d-00163e068ecd.png)



è°ƒåº¦ç­–ç•¥å…¨éƒ¨å®ç°äºè°ƒåº¦å™¨SchedulingStrategyï¼Œæœ‰ä¸‰ç§å®ç°ï¼š

**1ï¼‰ EagerSchedulingStrategyï¼š**é€‚ç”¨äºæµè®¡ç®—ï¼ŒåŒæ—¶è°ƒåº¦æ‰€æœ‰çš„ task

**2ï¼‰ LazyFromSourcesSchedulingStrategyï¼š**é€‚ç”¨äºæ‰¹å¤„ç†ï¼Œå½“è¾“å…¥æ•°æ®å‡†å¤‡å¥½æ—¶ï¼ˆä¸Šæ¸¸å¤„ç†å®Œï¼‰è¿›è¡Œ vertices è°ƒåº¦ã€‚

**3ï¼‰ PipelinedRegionSchedulingStrategyï¼š**ä»¥æµæ°´çº¿çš„å±€éƒ¨ä¸ºç²’åº¦è¿›è¡Œè°ƒåº¦

ã€€ã€€PipelinedRegionSchedulingStrategy æ˜¯ 1.11 åŠ å…¥çš„ï¼Œä» 1.12 å¼€å§‹ï¼Œå°†ä»¥ pipelined regionä¸ºå•ä½è¿›è¡Œè°ƒåº¦ã€‚

pipelined region æ˜¯ä¸€ç»„æµæ°´çº¿è¿æ¥çš„ä»»åŠ¡ã€‚è¿™æ„å‘³ç€ï¼Œå¯¹äºåŒ…å«å¤šä¸ª regionçš„æµä½œä¸šï¼Œåœ¨å¼€å§‹éƒ¨ç½²ä»»åŠ¡ä¹‹å‰ï¼Œå®ƒä¸å†ç­‰å¾…æ‰€æœ‰ä»»åŠ¡è·å– slotã€‚å–è€Œä»£ä¹‹çš„æ˜¯ï¼Œä¸€æ—¦ä»»ä½•region è·å¾—äº†è¶³å¤Ÿçš„ä»»åŠ¡ slot å°±å¯ä»¥éƒ¨ç½²å®ƒã€‚å¯¹äºæ‰¹å¤„ç†ä½œä¸šï¼Œå°†ä¸ä¼šä¸ºä»»åŠ¡åˆ†é… slotï¼Œä¹Ÿä¸ä¼šå•ç‹¬éƒ¨ç½²ä»»åŠ¡ã€‚å–è€Œä»£ä¹‹çš„æ˜¯ï¼Œä¸€æ—¦æŸä¸ª region è·å¾—äº†è¶³å¤Ÿçš„ slotï¼Œåˆ™è¯¥ä»»åŠ¡å°†ä¸æ‰€æœ‰å…¶ä»–ä»»åŠ¡ä¸€èµ·éƒ¨ç½²åœ¨åŒä¸€åŒºåŸŸä¸­ã€‚

> 77ã€Flinkä½œä¸šç”Ÿå‘½å‘¨æœŸåŒ…å«å“ªäº›çŠ¶æ€ï¼Ÿ

åœ¨Flinké›†ç¾¤ä¸­ï¼Œ**JobMaster** è´Ÿè´£**ä½œä¸š**çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œå…·ä½“çš„ç®¡ç†è¡Œä¸ºåœ¨è°ƒåº¦å™¨å’ŒExecutionGraphä¸­å®ç°ã€‚

ä½œä¸šçš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸçŠ¶æ€å˜æ¢å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a72fe500-1257-11ec-948d-00163e068ecd.png)

ï¼ˆ1ï¼‰ä½œä¸šé¦–å…ˆå¤„äºåˆ›å»ºçŠ¶æ€ï¼ˆcreatedï¼‰ï¼Œç„¶ååˆ‡æ¢åˆ°è¿è¡ŒçŠ¶æ€ï¼ˆrunningï¼‰ï¼Œå¹¶ä¸”åœ¨å®Œæˆæ‰€æœ‰å·¥ä½œåï¼Œå®ƒå°†åˆ‡æ¢åˆ°å®ŒæˆçŠ¶æ€ï¼ˆfinishedï¼‰ã€‚

ï¼ˆ2ï¼‰åœ¨å¤±è´¥çš„æƒ…å†µä¸‹ï¼Œä½œä¸šé¦–å…ˆåˆ‡æ¢åˆ°å¤±è´¥çŠ¶æ€ï¼ˆfailingï¼‰ï¼Œå–æ¶ˆæ‰€æœ‰æ­£åœ¨è¿è¡Œä»»åŠ¡ã€‚

å¦‚æœæ‰€æœ‰èŠ‚ç‚¹éƒ½å·²è¾¾åˆ°æœ€ç»ˆçŠ¶æ€ï¼Œå¹¶ä¸”ä½œä¸šä¸å¯é‡æ–°å¯åŠ¨ï¼Œåˆ™çŠ¶æ€å°†è½¬æ¢ä¸ºå¤±è´¥ï¼ˆfailedï¼‰ã€‚ï¼ˆ3ï¼‰å¦‚æœä½œä¸šå¯ä»¥é‡æ–°å¯åŠ¨ï¼Œé‚£ä¹ˆå®ƒå°†è¿›å…¥é‡æ–°å¯åŠ¨çŠ¶æ€ï¼ˆrestartingï¼‰ã€‚ä¸€æ—¦å®Œæˆé‡æ–°å¯åŠ¨ï¼Œå®ƒå°†å˜æˆåˆ›å»ºçŠ¶æ€ï¼ˆcreatedï¼‰ã€‚

ï¼ˆ4ï¼‰åœ¨ç”¨æˆ·å–æ¶ˆä½œä¸šçš„æƒ…å†µä¸‹ï¼Œå°†è¿›å…¥å–æ¶ˆçŠ¶æ€ï¼ˆcancellingï¼‰ï¼Œä¼šå–æ¶ˆæ‰€æœ‰å½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ã€‚ä¸€æ—¦æ‰€æœ‰è¿è¡Œçš„ä»»åŠ¡å·²ç»è¾¾åˆ°æœ€ç»ˆçŠ¶æ€ï¼Œè¯¥ä½œä¸šå°†è½¬æ¢åˆ°å·²å–æ¶ˆçŠ¶æ€ï¼ˆcanceledï¼‰ã€‚

**å®ŒæˆçŠ¶æ€ï¼ˆfinishedï¼‰****ï¼Œå–æ¶ˆçŠ¶æ€ï¼ˆcanceledï¼‰**å’Œ**å¤±è´¥çŠ¶æ€ï¼ˆfailedï¼‰**è¡¨ç¤ºä¸€ä¸ªå…¨å±€çš„ç»ˆç»“çŠ¶æ€ï¼Œå¹¶ä¸”è§¦å‘æ¸…ç†å·¥ä½œï¼Œ**è€Œæš‚åœçŠ¶æ€ï¼ˆsuspendedï¼‰ä»…å¤„äºæœ¬åœ°ç»ˆæ­¢çŠ¶æ€**ã€‚æ„å‘³ç€ä½œä¸šçš„æ‰§è¡Œåœ¨ç›¸åº”çš„ JobManager ä¸Šç»ˆæ­¢ï¼Œä½†é›†ç¾¤çš„å¦ä¸€ä¸ª JobManager å¯ä»¥ä»æŒä¹…çš„HAå­˜å‚¨ä¸­æ¢å¤è¿™ä¸ªä½œä¸šå¹¶é‡æ–°å¯åŠ¨ã€‚å› æ­¤ï¼Œå¤„äºæš‚åœçŠ¶æ€çš„ä½œä¸šå°†ä¸ä¼šè¢«å®Œå…¨æ¸…ç†ã€‚



> 78ã€Taskçš„ä½œä¸šç”Ÿå‘½å‘¨æœŸåŒ…å«å“ªäº›çŠ¶æ€ï¼Ÿ

**TaskManager** è´Ÿè´£**Task** çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œå¹¶å°†çŠ¶æ€çš„å˜åŒ–é€šçŸ¥åˆ°JobMaster,åœ¨ExecutionGraphä¸­è·Ÿè¸ªExecutionçš„çŠ¶æ€å˜åŒ–ï¼Œä¸€ä¸ªExecutionå¯¹äºä¸€ä¸ªTaskã€‚

**Taskçš„ç”Ÿå‘½å‘¨æœŸå¦‚ä¸‹ï¼šå…±8ç§çŠ¶æ€ã€‚**

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a7570e32-1257-11ec-948d-00163e068ecd.png)

**åœ¨æ‰§è¡Œ ExecutionGraph æœŸé—´ï¼Œæ¯ä¸ªå¹¶è¡Œä»»åŠ¡ç»è¿‡å¤šä¸ªé˜¶æ®µï¼Œä»åˆ›å»ºï¼ˆcreatedï¼‰åˆ°å®Œæˆï¼ˆfinishedï¼‰æˆ–å¤±è´¥ï¼ˆfailedï¼‰ ï¼Œä¸‹å›¾è¯´æ˜äº†å®ƒä»¬ä¹‹é—´çš„çŠ¶æ€å’Œå¯èƒ½çš„è½¬æ¢ã€‚ä»»åŠ¡å¯ä»¥æ‰§è¡Œå¤šæ¬¡ï¼ˆä¾‹å¦‚æ•…éšœæ¢å¤ï¼‰ã€‚æ¯ä¸ª Execution è·Ÿè¸ªä¸€ä¸ª ExecutionVertex çš„æ‰§è¡Œï¼Œæ¯ä¸ª ExecutionVertex éƒ½æœ‰ä¸€ä¸ªå½“å‰ Executionï¼ˆcurrent executionï¼‰å’Œä¸€ä¸ªå‰é©± Executionï¼ˆprior executionï¼‰ã€‚**



> 79ã€Flinkçš„ä»»åŠ¡è°ƒåº¦æµç¨‹è®²è§£ä¸€ä¸‹ï¼Ÿ

ä»»åŠ¡è°ƒåº¦æµç¨‹å›¾å¦‚ä¸‹ï¼š

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a77b5b98-1257-11ec-948d-00163e068ecd.png)

\1. å½“Flinkæ‰§è¡Œexecutorä¼šè‡ªåŠ¨æ ¹æ®ç¨‹åºä»£ç ç”Ÿæˆ**DAGæ•°æ®æµå›¾** ï¼Œå³ **Jobgraphï¼›**

\2. **ActorSystem**åˆ›å»º**Actor**å°†æ•°æ®æµå›¾å‘é€ç»™JobManagerä¸­çš„Actorï¼›

\3. **JobManager**ä¼šä¸æ–­æ¥æ”¶**TaskManager**çš„å¿ƒè·³æ¶ˆæ¯ï¼Œä»è€Œå¯ä»¥è·å–åˆ°æœ‰æ•ˆçš„TaskManagerï¼›

\4. JobManageré€šè¿‡è°ƒåº¦å™¨åœ¨TaskManagerä¸­è°ƒåº¦æ‰§è¡ŒTaskï¼ˆåœ¨Flinkä¸­ï¼Œæœ€å°çš„è°ƒåº¦å•å…ƒå°±æ˜¯taskï¼Œå¯¹åº”å°±æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼‰ ï¼›

\5. åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œtaskä¸taskä¹‹é—´æ˜¯å¯ä»¥è¿›è¡Œæ•°æ®ä¼ è¾“çš„ ã€‚

**â€¢ Job Client**

â€‹    â€“ ä¸»è¦èŒè´£æ˜¯æäº¤ä»»åŠ¡, æäº¤åå¯ä»¥ç»“æŸè¿›ç¨‹, ä¹Ÿå¯ä»¥ç­‰å¾…ç»“æœè¿”å› ï¼›

â€‹    â€“ Job Client ä¸æ˜¯ Flink ç¨‹åºæ‰§è¡Œçš„å†…éƒ¨éƒ¨åˆ†ï¼Œä½†å®ƒæ˜¯ä»»åŠ¡æ‰§è¡Œçš„èµ·ç‚¹ï¼›

â€‹    â€“ Job Client è´Ÿè´£æ¥å—ç”¨æˆ·çš„ç¨‹åºä»£ç ï¼Œç„¶ååˆ›å»ºæ•°æ®æµï¼Œå°†æ•°æ®æµæäº¤ç»™ JobManager ä»¥ä¾¿è¿›ä¸€æ­¥æ‰§è¡Œã€‚æ‰§è¡Œå®Œæˆåï¼ŒJob Client å°†ç»“æœè¿”å›ç»™ç”¨æˆ·ã€‚

**â€¢ JobManager** 

â€‹    â€“ ä¸»è¦èŒè´£æ˜¯è°ƒåº¦å·¥ä½œå¹¶åè°ƒä»»åŠ¡åšæ£€æŸ¥ç‚¹ï¼›

â€‹    â€“ é›†ç¾¤ä¸­è‡³å°‘è¦æœ‰ä¸€ä¸ª masterï¼Œmaster è´Ÿè´£è°ƒåº¦ taskï¼Œåè°ƒcheckpoints å’Œ å®¹é”™ï¼›

â€‹    â€“ é«˜å¯ç”¨è®¾ç½®çš„è¯å¯ä»¥æœ‰å¤šä¸ª masterï¼Œä½†è¦ä¿è¯ä¸€ä¸ªæ˜¯ leader, å…¶ä»–æ˜¯stand byï¼›

â€‹    â€“ Job Manager åŒ…å« **Actor Systemã€Schedulerã€CheckPoint**ä¸‰ä¸ªé‡è¦çš„ç»„ä»¶ ï¼›

   â€“ JobManagerä»å®¢æˆ·ç«¯æ¥æ”¶åˆ°ä»»åŠ¡ä»¥å, é¦–å…ˆç”Ÿæˆä¼˜åŒ–è¿‡çš„æ‰§è¡Œè®¡åˆ’, å†è°ƒåº¦åˆ°TaskManagerä¸­æ‰§è¡Œã€‚

**â€¢ TaskManager**

â€‹    â€“ ä¸»è¦èŒè´£æ˜¯ä»JobManagerå¤„æ¥æ”¶ä»»åŠ¡, å¹¶éƒ¨ç½²å’Œå¯åŠ¨ä»»åŠ¡, æ¥æ”¶ä¸Šæ¸¸çš„æ•° æ®å¹¶å¤„ç† 

â€‹    â€“ Task Manager æ˜¯åœ¨ JVM ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡çš„å·¥ä½œèŠ‚ç‚¹ã€‚ 

â€‹    â€“ TaskManageråœ¨åˆ›å»ºä¹‹åˆå°±è®¾ç½®å¥½äº†Slot, æ¯ä¸ªSlotå¯ä»¥æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ã€‚

> 80ã€Flinkçš„ä»»åŠ¡æ§½æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a79e8064-1257-11ec-948d-00163e068ecd.png)

æ¯ä¸ªTaskManageræ˜¯ä¸€ä¸ªJVMçš„è¿›ç¨‹, å¯ä»¥åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­æ‰§è¡Œä¸€ä¸ªæˆ–å¤šä¸ªå­ä»»åŠ¡ã€‚ä¸ºäº†æ§åˆ¶ä¸€ä¸ªworkerèƒ½æ¥æ”¶å¤šå°‘ä¸ªtaskã€‚workeré€šè¿‡task slotæ¥è¿›è¡Œæ§åˆ¶ï¼ˆä¸€ä¸ªworker è‡³å°‘æœ‰ä¸€ä¸ªtask slotï¼‰ã€‚

**1ã€ä»»åŠ¡æ§½**

æ¯ä¸ªtask slotè¡¨ç¤ºTaskManageræ‹¥æœ‰èµ„æºçš„ä¸€ä¸ªå›ºå®šå¤§å°çš„å­é›†ã€‚ 

ä¸€èˆ¬æ¥è¯´ï¼šæˆ‘ä»¬åˆ†é…æ§½çš„ä¸ªæ•°éƒ½æ˜¯å’ŒCPUçš„æ ¸æ•°ç›¸ç­‰ï¼Œæ¯”å¦‚8æ ¸ï¼Œé‚£ä¹ˆå°±åˆ†é…8ä¸ªæ§½ã€‚

Flinkå°†è¿›ç¨‹çš„å†…å­˜åˆ’åˆ†åˆ°å¤šä¸ªslotä¸­ã€‚

å›¾ä¸­æœ‰2ä¸ªTaskManagerï¼Œæ¯ä¸ªTaskManageræœ‰3ä¸ªslotï¼Œæ¯ä¸ªslotå æœ‰1/3çš„å†…å­˜ã€‚

å†…å­˜è¢«åˆ’åˆ†åˆ°ä¸åŒçš„slotä¹‹åå¯ä»¥è·å¾—å¦‚ä¸‹å¥½å¤„ï¼š

  â€¢ **TaskManager**æœ€å¤šèƒ½åŒæ—¶å¹¶å‘æ‰§è¡Œçš„ä»»åŠ¡æ˜¯å¯ä»¥æ§åˆ¶çš„ï¼Œé‚£å°±æ˜¯3ä¸ªï¼Œå› ä¸ºä¸èƒ½è¶…è¿‡slotçš„æ•°é‡ã€‚ **ä»»åŠ¡æ§½çš„ä½œç”¨å°±æ˜¯åˆ†ç¦»ä»»åŠ¡çš„æ‰˜ç®¡å†…å­˜ï¼Œä¸ä¼šå‘ç”Ÿcpuéš”ç¦»ã€‚**

   â€¢ slotæœ‰ç‹¬å çš„å†…å­˜ç©ºé—´ï¼Œè¿™æ ·åœ¨ä¸€ä¸ªTaskManagerä¸­å¯ä»¥è¿è¡Œå¤šä¸ªä¸åŒçš„ä½œä¸šï¼Œä½œä¸šä¹‹é—´ä¸å—å½±å“ã€‚

**æ€»ç»“ï¼štask slotçš„ä¸ªæ•°ä»£è¡¨TaskManagerå¯ä»¥å¹¶è¡Œæ‰§è¡Œçš„taskæ•°ã€‚**



> 81ã€Flink æ§½å…±äº«åˆæ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

**2ã€æ§½å…±äº«**

**é»˜è®¤æƒ…å†µä¸‹ï¼ŒFlinkå…è®¸å­ä»»åŠ¡å…±äº«æ’æ§½**ï¼Œå³ä½¿å®ƒä»¬æ˜¯ä¸åŒä»»åŠ¡çš„å­ä»»åŠ¡ï¼Œåªè¦å®ƒä»¬æ¥è‡ªåŒä¸€ä¸ªä½œä¸šã€‚ç»“æœæ˜¯ä¸€ä¸ªæ§½å¯ä»¥ä¿å­˜ä½œä¸šçš„æ•´ä¸ªç®¡é“ã€‚å…è®¸æ’æ§½å…±äº«æœ‰ä¸¤ä¸ªä¸»è¦å¥½å¤„ï¼š

â€‹    â€¢ åªéœ€è®¡ç®—Jobä¸­æœ€é«˜å¹¶è¡Œåº¦ï¼ˆparallelismï¼‰çš„task slotã€‚åªè¦è¿™ä¸ªæ»¡è¶³ï¼Œå…¶ä»–çš„jobä¹Ÿéƒ½èƒ½æ»¡è¶³ã€‚ 

â€‹    â€¢ èµ„æºåˆ†é…æ›´åŠ å…¬å¹³ã€‚å¦‚æœæœ‰æ¯”è¾ƒç©ºé—²çš„slotå¯ä»¥å°†æ›´å¤šçš„ä»»åŠ¡åˆ†é…ç»™å®ƒã€‚å›¾ä¸­è‹¥æ²¡æœ‰ä»»åŠ¡æ§½å…±äº«ï¼Œè´Ÿè½½ä¸é«˜çš„Source/Mapç­‰subtaskå°†ä¼šå æ®è®¸å¤šèµ„æºï¼Œè€Œè´Ÿè½½è¾ƒé«˜çš„çª—å£subtaskåˆ™ä¼šç¼ºä¹èµ„æºã€‚ 

â€‹    â€¢ æœ‰äº†ä»»åŠ¡æ§½å…±äº«ï¼Œå¯ä»¥å°†åŸºæœ¬å¹¶è¡Œåº¦ï¼ˆbase parallelismï¼‰ä»2æå‡åˆ°6ã€‚æé«˜äº†åˆ†æ§½èµ„æºçš„åˆ©ç”¨ç‡ã€‚åŒæ—¶å®ƒè¿˜å¯ä»¥ä¿éšœTaskManagerç»™subtaskçš„åˆ†é…çš„slotæ–¹æ¡ˆæ›´åŠ å…¬å¹³ã€‚

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a7becbf8-1257-11ec-948d-00163e068ecd.png)



![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_97b24136-1257-11ec-948d-00163e068ecd.png)

04ã€Flink SQLç¯‡







Flink SQLä¹Ÿæ˜¯é¢è¯•çš„é‡ç‚¹è€ƒå¯Ÿç‚¹ï¼Œä¸ä»…éœ€è¦ä½ æŒæ¡æ‰å®çš„SQLç¼–ç¨‹ï¼ŒåŒæ—¶è¿˜éœ€è¦ç†è§£SQLæäº¤çš„æ ¸å¿ƒåŸç†ï¼Œä»¥åŠFlink SQLä¸­æ¶‰åŠçš„ä¸€äº›é‡ç‚¹çŸ¥è¯†ï¼Œä¾‹å¦‚CEPã€CDCã€SQL GateWayã€SQL-Hiveç­‰ï¼Œæ€ç»´å¯¼å›¾å¦‚ä¸‹ï¼š

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a7f9ffca-1257-11ec-948d-00163e068ecd.png)

> 82ã€Flink SQLæœ‰æ²¡æœ‰ä½¿ç”¨è¿‡ï¼Ÿ

ç”¨è¿‡ï¼Œåœ¨Flinkä¸­ï¼Œä¸€å…±æœ‰**å››ç§**çº§åˆ«çš„**æŠ½è±¡**ï¼Œè€ŒFlink SQLä½œä¸ºæœ€ä¸Šå±‚ï¼Œæ˜¯Flink APIçš„ä¸€ç­‰å…¬æ°‘

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a8169716-1257-11ec-948d-00163e068ecd.png)

åœ¨æ ‡å‡†SQLä¸­ï¼ŒSQLè¯­å¥åŒ…å«å››ç§ç±»å‹

DML(Data Manipulation Language):æ•°æ®æ“ä½œè¯­è¨€ï¼Œç”¨æ¥å®šä¹‰æ•°æ®åº“è®°å½•ï¼ˆæ•°æ®ï¼‰ã€‚

DCL (Data Control Language):æ•°æ®æ§åˆ¶è¯­è¨€ï¼Œç”¨æ¥å®šä¹‰è®¿é—®æƒé™å’Œå®‰å…¨çº§åˆ«ã€‚

DQL (Data Query Language):æ•°æ®æŸ¥è¯¢è¯­è¨€ï¼Œç”¨æ¥æŸ¥è¯¢è®°å½•ï¼ˆæ•°æ®ï¼‰ã€‚

DDL(Data Definition Language):æ•°æ®å®šä¹‰è¯­è¨€ï¼Œç”¨æ¥å®šä¹‰æ•°æ®åº“å¯¹è±¡ï¼ˆåº“ï¼Œè¡¨ï¼Œåˆ—ç­‰ï¼‰ã€‚


**Flink SQLåŒ…å« DML æ•°æ®æ“ä½œè¯­è¨€ã€ DDL æ•°æ®è¯­è¨€ï¼Œ DQL æ•°æ®æŸ¥è¯¢è¯­è¨€**ï¼Œ**ä¸åŒ…å«DCLè¯­è¨€ã€‚**

> 83ã€Flinkè¢«ç§°ä½œæµæ‰¹ä¸€ä½“ï¼Œé‚£ä»å“ªä¸ªç‰ˆæœ¬å¼€å§‹ï¼ŒçœŸæ­£å®ç°æµæ‰¹ä¸€ä½“çš„ï¼Ÿ

ä»1.9.0ç‰ˆæœ¬å¼€å§‹ï¼Œå¼•å…¥äº†é˜¿é‡Œå·´å·´çš„ Blink ï¼Œå¯¹ FIink TabIe & SQL æ¨¡å—åšäº†é‡å¤§çš„é‡æ„ï¼Œä¿ç•™äº† Flink Planner çš„åŒæ—¶ï¼Œå¼•å…¥äº† Blink PIannerï¼Œæ²¡å¼•å…¥ä»¥å‰ï¼ŒFlink æ²¡è€ƒè™‘æµæ‰¹ä½œä¸šç»Ÿä¸€ï¼Œé’ˆå¯¹æµæ‰¹ä½œä¸šï¼Œåº•å±‚å®ç°ä¸¤å¥—ä»£ç ï¼Œå¼•å…¥åï¼ŒåŸºäºæµæ‰¹ä¸€ä½“ç†å¿µï¼Œé‡æ–°è®¾è®¡ç®—å­ï¼Œä»¥æµä¸ºæ ¸å¿ƒï¼Œæµä½œä¸šå’Œæ‰¹ä½œä¸šæœ€ç»ˆéƒ½ä¼šè¢«è½¬ä¸ºtransformationã€‚

> 84ã€Flink SQL ä½¿ç”¨å“ªç§è§£æå™¨ï¼Ÿ

Flink SQLä½¿ç”¨ Apache Calciteä½œä¸ºè§£æå™¨å’Œä¼˜åŒ–å™¨ã€‚

**Calcite** ä¸€ç§åŠ¨æ€æ•°æ®ç®¡ç†æ¡†æ¶ï¼Œå®ƒå…·å¤‡å¾ˆå¤šå…¸å‹æ•°æ®åº“ç®¡ç†ç³»ç»Ÿçš„åŠŸèƒ½ å¦‚SQL è§£æã€ SQL æ ¡éªŒã€ SQL æŸ¥è¯¢ä¼˜åŒ–ã€ SQL ç”Ÿæˆä»¥åŠæ•°æ®è¿æ¥æŸ¥è¯¢ç­‰ï¼Œä½†æ˜¯åˆçœç•¥äº†ä¸€äº›å…³é”®çš„åŠŸèƒ½ï¼Œå¦‚ Calciteå¹¶**ä¸å­˜å‚¨**ç›¸å…³çš„**å…ƒæ•°æ®**å’Œ**åŸºæœ¬æ•°æ®**ï¼Œä¸å®Œå…¨åŒ…å«ç›¸å…³å¤„ç†æ•°æ®çš„ç®—æ³•ç­‰ã€‚

> 85ã€Calciteä¸»è¦åŠŸèƒ½åŒ…å«å“ªäº›ï¼Ÿ

Calcite ä¸»è¦åŒ…å«ä»¥ä¸‹äº”ä¸ªéƒ¨åˆ†ï¼š

**(1) SQL è§£æ (Parser)**

Calcite SQL è§£ææ˜¯**é€šè¿‡ JavaCC** å®ç°çš„ï¼Œä½¿ç”¨ JavaCC ç¼–å†™ SQL è¯­æ³•æè¿°æ–‡ä»¶ï¼Œå°† SQL è§£ææˆæœªç»æ ¡éªŒçš„ AST è¯­æ³•æ ‘ã€‚ 

**(2) SQL æ ¡éªŒ ï¼ˆValidatoï¼‰**

æ ¡éªŒåˆ†ä¸¤éƒ¨åˆ† 

1ï¼‰æ— çŠ¶æ€çš„æ ¡éªŒ å³éªŒè¯ SQL è¯­å¥æ˜¯å¦ç¬¦åˆè§„èŒƒã€‚

2ï¼‰æœ‰çŠ¶æ€çš„æ ¡éªŒ å³é€šè¿‡ä¸å…ƒæ•°æ®ç»“åˆéªŒè¯ SQL ä¸­çš„ Schemaã€Fieldã€ Function æ˜¯å¦å­˜ åœ¨ï¼Œè¾“å…¥è¾“å‡ºç±»å‹æ˜¯å¦åŒ¹é…ç­‰ã€‚ 

**(3) SQL æŸ¥è¯¢ä¼˜åŒ–** 

å¯¹ä¸Šä¸ªæ­¥éª¤çš„è¾“å‡º( RelNode ï¼Œé€»è¾‘è®¡åˆ’æ ‘)è¿›è¡Œä¼˜åŒ–ï¼Œå¾—åˆ°ä¼˜åŒ–åçš„ç‰©ç†æ‰§è¡Œè®¡åˆ’ ä¼˜åŒ–æœ‰ä¸¤ç§ï¼š**åŸºäºè§„åˆ™çš„ä¼˜åŒ–** å’Œ **åŸºäºä»£ä»·çš„ä¼˜åŒ–**ï¼Œåé¢ä¼šè¯¦ç»†ä»‹ç»ã€‚

**(4) SQL ç”Ÿæˆ** 

å°†ç‰©ç†æ‰§è¡Œè®¡åˆ’ç”Ÿæˆä¸ºåœ¨ç‰¹å®šå¹³å°/å¼•æ“çš„å¯æ‰§è¡Œç¨‹åºï¼Œå¦‚ç”Ÿæˆç¬¦åˆ MySQL æˆ– Oracle ç­‰ä¸åŒå¹³å°è§„åˆ™çš„ SQL æŸ¥è¯¢è¯­å¥ç­‰ã€‚ 

**(5) æ•°æ®è¿æ¥ä¸æ‰§è¡Œ** 

é€šè¿‡å„ä¸ªæ‰§è¡Œå¹³å°æ‰§è¡ŒæŸ¥è¯¢ï¼Œå¾—åˆ°è¾“å‡ºç»“æœã€‚ 

åœ¨Flink æˆ–è€…å…¶ä»–ä½¿ç”¨ Calcite çš„å¤§æ•°æ®å¼•æ“ä¸­ï¼Œä¸€èˆ¬åˆ° SQL æŸ¥è¯¢ä¼˜åŒ–å³ç»“æŸï¼Œç”±å„ä¸ªå¹³å°ç»“åˆ Calcite SQL ä»£ç ç”Ÿæˆ å’Œ å¹³å°å®ç°çš„ä»£ç ç”Ÿæˆï¼Œå°†ä¼˜åŒ–åçš„ç‰©ç†æ‰§è¡Œè®¡åˆ’ç»„åˆæˆå¯æ‰§è¡Œçš„ä»£ç ï¼Œç„¶ååœ¨å†…å­˜ä¸­ç¼–è¯‘æ‰§è¡Œã€‚

> 86ã€Flink SQL å¤„ç†æµç¨‹è¯´ä¸€ä¸‹ï¼Ÿ

ä¸‹é¢ä¸¾ä¸ªä¾‹å­ï¼Œè¯¦ç»†æè¿°ä¸€ä¸‹Flink Sqlçš„å¤„ç†æµç¨‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š



![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a83365d0-1257-11ec-948d-00163e068ecd.png)

æˆ‘ä»¬å†™ä¸€å¼ sourceè¡¨ï¼Œæ¥æºä¸ºkafkaï¼Œå½“æ‰§è¡Œcreate table log_kafkaä¹‹å Flink SQLå°†åšå¦‚ä¸‹æ“ä½œï¼š

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a854066e-1257-11ec-948d-00163e068ecd.png)



ï¼ˆ1ï¼‰é¦–å…ˆï¼ŒFlinkSQL åº•å±‚ä½¿ç”¨çš„æ˜¯ **apache Calcite** å¼•æ“æ¥å¤„ç†SQLè¯­å¥ï¼ŒCalciteä¼šä½¿ç”¨javaCCåšSQLè§£æï¼ŒjavaCCæ ¹æ®Calciteä¸­å®šä¹‰çš„ **Parser.jj** æ–‡ä»¶ï¼Œç”Ÿæˆä¸€ç³»åˆ—çš„javaä»£ç ï¼Œç”Ÿæˆçš„javaä»£ç ä¼š**æŠŠSQLè½¬æ¢æˆASTæŠ½è±¡è¯­æ³•æ ‘ï¼ˆå³SQLNodeç±»å‹ï¼‰**ã€‚

ï¼ˆ2ï¼‰ç”Ÿæˆçš„ SqlNode æŠ½è±¡è¯­æ³•æ ‘ï¼Œä»–æ˜¯ä¸€ä¸ª**æœªç»éªŒè¯çš„æŠ½è±¡è¯­æ³•æ ‘**ï¼Œè¿™æ—¶ï¼ŒSQL Validator ä¼šè·å– Flink Catalogä¸­çš„å…ƒæ•°æ®ä¿¡æ¯æ¥éªŒè¯ sql è¯­æ³•ï¼Œå…ƒæ•°æ®ä¿¡æ¯æ£€æŸ¥åŒ…æ‹¬è¡¨åï¼Œå­—æ®µåï¼Œå‡½æ•°åï¼Œæ•°æ®ç±»å‹ç­‰æ£€æŸ¥ã€‚ç„¶å**ç”Ÿæˆä¸€ä¸ªæ ¡éªŒåçš„SqlNode**ã€‚

ï¼ˆ3ï¼‰åˆ°è¾¾è¿™æ­¥åï¼Œåªæ˜¯å°† SQL è§£æåˆ° java æ•°æ®ç»“æ„çš„å›ºå®šèŠ‚ç‚¹ä¸Šï¼Œå¹¶æ²¡æœ‰ç»™å‡ºç›¸å…³èŠ‚ç‚¹ä¹‹é—´çš„å…³è”å…³ç³»ä»¥åŠæ¯ä¸ªèŠ‚ç‚¹çš„ç±»å‹ä¿¡æ¯ã€‚æ‰€ä»¥ï¼Œè¿˜ **éœ€è¦å°† SqlNode è½¬æ¢ä¸ºé€»è¾‘è®¡åˆ’ï¼Œä¹Ÿå°±æ˜¯LogicalPl**anï¼Œåœ¨è½¬æ¢è¿‡ç¨‹ä¸­ï¼Œä¼šä½¿ç”¨ **SqlToOperationConverter** ç±»ï¼Œæ¥å°†SqlNodeè½¬æ¢ä¸ºOperation,Operationä¼šæ ¹æ®SQLè¯­æ³•æ¥æ‰§è¡Œåˆ›å»ºè¡¨æˆ–è€…åˆ é™¤è¡¨ç­‰æ“ä½œï¼ŒåŒæ—¶**FlinkPlannerImpl.rel()æ–¹æ³•ä¼šå°†SQLNodeè½¬æ¢æˆRelNodeæ ‘ï¼Œå¹¶è¿”å›RelRoot**ã€‚

ï¼ˆ4ï¼‰ç¬¬4æ­¥å°†**æ‰§è¡Œ Optimize æ“ä½œ**ï¼ŒæŒ‰ç…§é¢„å®šä¹‰çš„ä¼˜åŒ–è§„åˆ™ RelOptRule ä¼˜åŒ–é€»è¾‘è®¡åˆ’ã€‚

Calciteä¸­çš„ä¼˜åŒ–å™¨RelOptPlanneræœ‰ä¸¤ç§ï¼Œä¸€æ˜¯**åŸºäºè§„åˆ™ä¼˜åŒ–ï¼ˆRBOï¼‰çš„HepPlanner**ï¼ŒäºŒæ˜¯**åŸºäºä»£ä»·ä¼˜åŒ–ï¼ˆCBOï¼‰çš„VolcanoPlanner**ã€‚ç„¶åå¾—åˆ°ä¼˜åŒ–åçš„RelNode,  å†åŸºäºFlinké‡Œé¢çš„rules**å°†ä¼˜åŒ–åçš„é€»è¾‘è®¡åˆ’è½¬æ¢æˆç‰©ç†è®¡åˆ’**ã€‚

ï¼ˆ5ï¼‰ç¬¬5æ­¥ **æ‰§è¡Œ execute æ“ä½œ**ï¼Œä¼šé€šè¿‡ä»£ç ç”Ÿæˆ transformation,ç„¶åé€’å½’éå†å„èŠ‚ç‚¹ï¼Œå°†DataStreamRelNode è½¬æ¢æˆDataStream, åœ¨è¿™æœŸé—´ï¼Œä¼šä¾æ¬¡é€’å½’è°ƒç”¨DataStreamUnionã€DataStreamCalcã€DataStreamScanç±»ä¸­é‡å†™çš„ translateToPlanæ–¹æ³•ã€‚é€’å½’è°ƒç”¨å„èŠ‚ç‚¹çš„translateToPlanï¼Œå®é™…æ˜¯åˆ©ç”¨CodeGenå…ƒç¼–æˆFlinkçš„å„ç§ç®—å­ï¼Œç›¸å½“äºç›´æ¥åˆ©ç”¨Flinkçš„DataSetæˆ–è€…DataStreamå¼€å‘ç¨‹åºã€‚

ï¼ˆ6ï¼‰æœ€åè¿›ä¸€æ­¥**ç¼–è¯‘**æˆå¯æ‰§è¡Œçš„ JobGraph æäº¤è¿è¡Œã€‚

> 87ã€Flink SQLåŒ…å«å“ªäº›ä¼˜åŒ–è§„åˆ™ï¼Ÿ

å¦‚ä¸‹å›¾ä¸ºæ‰§è¡Œæµç¨‹å›¾

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a87c66fe-1257-11ec-948d-00163e068ecd.png)

**æ€»ç»“å°±æ˜¯ï¼š**

å…ˆè§£æï¼Œç„¶åéªŒè¯ï¼Œå°†SqlNodeè½¬åŒ–ä¸ºOperationæ¥åˆ›å»ºè¡¨ï¼Œç„¶åè°ƒç”¨relæ–¹æ³•å°†sqlNodeå˜æˆ é€»è¾‘è®¡åˆ’ ï¼ˆRelNodeTreeï¼‰ç´§æ¥ç€å¯¹é€»è¾‘è®¡åˆ’è¿›è¡Œä¼˜åŒ–ï¼›



ä¼˜åŒ–ä¹‹å‰ ä¼šæ ¹æ®Calciteä¸­çš„ä¼˜åŒ–å™¨ä¸­çš„åŸºäºè§„åˆ™ä¼˜åŒ–çš„HepPlanner**é’ˆå¯¹å››ç§è§„åˆ™è¿›è¡Œé¢„å¤„ç†**ï¼Œå¤„ç†å®Œä¹‹åå¾—åˆ°Logic RelNodeï¼Œç´§æ¥ç€**ä½¿ç”¨ä»£ä»·ä¼˜åŒ–çš„VolcanoPlannerä½¿ç”¨** Logical_Opt_Rulesï¼ˆé€»è¾‘è®¡åˆ’ä¼˜åŒ–ï¼‰æ‰¾åˆ°æœ€ä¼˜çš„æ‰§è¡ŒPlanner,å¹¶è½¬æ¢ä¸ºFlinkLogical RelNodeã€‚



æœ€åè¿ç”¨ FlinkåŒ…å«çš„ä¼˜åŒ–è§„åˆ™ï¼Œå¦‚DataStream_Opt_Rulesï¼šæµå¼è®¡ç®—ä¼˜åŒ–ï¼ŒDataStream_Deco_Rulesï¼šè£…é¥°æµå¼è®¡ç®—ä¼˜åŒ–  å°†ä¼˜åŒ–åçš„é€»è¾‘è®¡åˆ’è½¬æ¢ä¸ºç‰©ç†è®¡åˆ’ã€‚



**ä¼˜åŒ–è§„åˆ™åŒ…å«å¦‚ä¸‹ï¼š**



Table_subquery_rules å­æŸ¥è¯¢ä¼˜åŒ–

Expand_plan_rulesï¼šæ‰©å±•è®¡åˆ’ä¼˜åŒ–

Post_expand_clean_up_rulesï¼šæ‰©å±•è®¡åˆ’ä¼˜åŒ–

Datastream_norm_rulesï¼šæ­£å¸¸åŒ–æµå¤„ç†            

Logical_Opt_Rulesï¼šé€»è¾‘è®¡åˆ’ä¼˜åŒ–     

DataStream_Opt_Rulesï¼šæµå¼è®¡ç®—ä¼˜åŒ–     

DataStream_Deco_Rulesï¼šè£…é¥°æµå¼è®¡ç®—ä¼˜åŒ–

> 88ã€Flink SQLä¸­æ¶‰åŠåˆ°å“ªäº›operationï¼Ÿ

**å…ˆä»‹ç»ä¸€ä¸‹ä»€ä¹ˆæ˜¯Operation**

åœ¨Flink SQLä¸­å—ï¼Œæ¶‰åŠçš„DDLï¼ŒDMLï¼ŒDQLæ“ä½œéƒ½æ˜¯Operationï¼Œåœ¨ Flinkå†…éƒ¨è¡¨ç¤ºï¼ŒOperationå¯ä»¥å’ŒSqlNodeå¯¹åº”èµ·æ¥ã€‚

**Operationæ‰§è¡Œåœ¨ä¼˜åŒ–å‰**ï¼Œæ‰§è¡Œçš„å‡½æ•°ä¸ºexecuteQperation,å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¸ºæ‰§è¡Œçš„æ‰€æœ‰Operationã€‚

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a89e0b2e-1257-11ec-948d-00163e068ecd.png)

> 89ã€Flink Hiveæœ‰æ²¡æœ‰ä½¿ç”¨è¿‡ï¼Ÿ

Flinkç¤¾åŒºåœ¨Flink1.11ç‰ˆæœ¬è¿›è¡Œäº†é‡å¤§æ”¹å˜ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a8be056e-1257-11ec-948d-00163e068ecd.png)

> 90ã€Flinkä¸Hiveé›†æˆæ—¶éƒ½åšäº†å“ªäº›æ“ä½œï¼Ÿ

å¦‚ä¸‹æ‰€ç¤ºä¸ºFlinkä¸HIveè¿›è¡Œè¿æ¥æ—¶çš„æ‰§è¡Œå›¾ï¼š

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a8dd02de-1257-11ec-948d-00163e068ecd.png)



ï¼ˆ1ï¼‰Flink1.1æ–°å¼•å…¥äº†Hiveæ–¹è¨€ï¼Œæ‰€ä»¥åœ¨Flink SQLä¸­å¯ä»¥ç¼–å†™HIveè¯­æ³•ï¼Œå³Hive Dialectã€‚

ï¼ˆ2ï¼‰ç¼–å†™HIve SQLåï¼ŒFlinkSQL Planner ä¼šå°†SQLè¿›è¡Œè§£æï¼ŒéªŒè¯ï¼Œè½¬æ¢æˆé€»è¾‘è®¡åˆ’ï¼Œç‰©ç†è®¡åˆ’ï¼Œæœ€ç»ˆå˜æˆJobgraphã€‚

ï¼ˆ3ï¼‰**HiveCatalogä½œä¸ºFlinkå’ŒHiveçš„è¡¨å…ƒç´ æŒä¹…åŒ–ä»‹è´¨ï¼Œä¼šå°†ä¸åŒä¼šè¯çš„Flinkå…ƒæ•°æ®å­˜å‚¨åˆ°Hive Metastoreä¸­**ã€‚ç”¨æˆ·åˆ©ç”¨HiveCatalogå¯ä»¥å°†hiveè¡¨æˆ–è€… Kafkaè¡¨å­˜å‚¨åˆ°Hive Metastoreä¸­ã€‚

BlinkPlanner æ˜¯åœ¨Flink1.9ç‰ˆæœ¬æ–°å¼•å…¥çš„æœºåˆ¶ï¼ŒBlink çš„æŸ¥è¯¢å¤„ç†å™¨åˆ™å®ç°æµæ‰¹ä½œä¸šæ¥å£çš„ç»Ÿä¸€ï¼Œ**åº•å±‚çš„ API éƒ½æ˜¯Transformation**ã€‚çœŸæ­£å®ç° æµ &æ‰¹ çš„ç»Ÿä¸€å¤„ç†ï¼Œæ›¿ä»£åŸFlinkPlannerå°†æµ&æ‰¹åŒºåˆ†å¤„ç†çš„æ–¹å¼ã€‚åœ¨1.11ç‰ˆæœ¬å å·²ç»é»˜è®¤ä¸ºBlink Plannerã€‚

> 91ã€HiveCatalogç±»åŒ…å«å“ªäº›æ–¹æ³•ï¼Ÿ

é‡ç‚¹æ–¹æ³•å¦‚ä¸‹ï¼š

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a900e438-1257-11ec-948d-00163e068ecd.png)



HiveCatalogä¸»è¦æ˜¯**æŒä¹…åŒ–å…ƒæ•°æ®**ï¼Œæ‰€ä»¥ ä¸€èˆ¬çš„åˆ›å»ºç±»å‹éƒ½åŒ…å«ï¼Œå¦‚ database,Table,Viewï¼ŒFunction,Partition,è¿˜æœ‰is_Genericå­—æ®µåˆ¤æ–­ç­‰ã€‚

> 92ã€Flink SQL1.11æ–°å¢äº†å®æ—¶æ•°ä»“åŠŸèƒ½ï¼Œä»‹ç»ä¸€ä¸‹ï¼Ÿ

Flink1.11 ç‰ˆæœ¬æ–°å¢çš„ä¸€å¤§åŠŸèƒ½æ˜¯å®æ—¶æ•°ä»“ï¼Œå¯ä»¥å®æ—¶çš„å°†kafkaä¸­çš„æ•°æ®æ’å…¥Hiveä¸­ï¼Œä¼ ç»Ÿçš„å®æ—¶æ•°ä»“åŸºäº Kafka+ Flinkstreamingï¼Œå®šä¹‰å…¨æµç¨‹çš„æµè®¡ç®—ä½œä¸šï¼Œæœ‰ç€ç§’çº§ç”šè‡³æ¯«ç§’çš„å®æ—¶æ€§ï¼Œ**ä½†å®æ—¶æ•°ä»“çš„ä¸€ä¸ªé—®é¢˜æ˜¯å†å²æ•°æ®åªæœ‰ 3-15å¤©ï¼Œæ— æ³•åœ¨å…¶ä¸Šåš Ad-hocçš„æŸ¥è¯¢ã€‚**

é’ˆå¯¹è¿™ä¸ªç‰¹ç‚¹ï¼ŒFlink1.11 ç‰ˆæœ¬å°† **FlieSystemStreaming Sink** é‡æ–°ä¿®æ”¹ï¼Œå¢åŠ äº†**åˆ†åŒºæäº¤**å’Œ**æ»šåŠ¨ç­–ç•¥æœºåˆ¶**ï¼Œè®©HiveStreaming  sink é‡æ–°ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿæµæ¥æ”¶å™¨ã€‚

Flink 1.11 çš„ Table/SQL API ä¸­ï¼Œ**FileSystemConnector æ˜¯é å¢å¼ºç‰ˆ StreamingFileSinkç»„ä»¶å®ç°**ï¼Œåœ¨æºç ä¸­åä¸º StreamingFileWriterã€‚***** **åªæœ‰åœ¨Checkpoint æˆåŠŸæ—¶ï¼ŒStreamingFileSinkå†™å…¥çš„æ–‡ä»¶æ‰ä¼šç”± PendingçŠ¶æ€å˜æˆ FinishedçŠ¶æ€ï¼Œä»è€Œèƒ½å¤Ÿå®‰å…¨åœ°è¢«ä¸‹æ¸¸è¯»å–ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬ä¸€å®šè¦æ‰“å¼€ Checkpointingï¼Œå¹¶è®¾å®šåˆç†çš„é—´éš”ã€‚**

> 93ã€Flink -Hiveå®æ—¶å†™æ•°æ®ä»‹ç»ä¸‹ï¼Ÿ

**StreamingWrite**ï¼Œä»kafka ä¸­å®æ—¶æ‹¿åˆ°æ•°æ®ï¼Œä½¿ç”¨åˆ†åŒºæäº¤å°†æ•°æ®ä»Kafkaå†™å…¥Hiveè¡¨ä¸­ï¼Œå¹¶è¿è¡Œæ‰¹å¤„ç†æŸ¥è¯¢ä»¥è¯»å–è¯¥æ•°æ®ã€‚



Flink -SQL å†™æ³•

**Sourceæº**

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a9249482-1257-11ec-948d-00163e068ecd.png)



***\**\*Sinkç›®çš„åœ°\*\**\***

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a9443224-1257-11ec-948d-00163e068ecd.png)

**Insert æ’å…¥
**

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a9668edc-1257-11ec-948d-00163e068ecd.png)



Flink-tableå†™æ³•ï¼š

**Sourceæº**

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a97c816a-1257-11ec-948d-00163e068ecd.png)



**Sinkç›®çš„åœ°**

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a99d8d06-1257-11ec-948d-00163e068ecd.png)

**Insert æ’å…¥**

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a9c8700c-1257-11ec-948d-00163e068ecd.png)

> 94ã€Flink -Hiveå®æ—¶è¯»æ•°æ®ä»‹ç»ä¸‹ï¼Ÿ

**å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š**



![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_a9e1ceb2-1257-11ec-948d-00163e068ecd.png)

Flink æºç ä¸­åœ¨å¯¹Hiveè¿›è¡Œè¯»å–æ“ä½œæ—¶ï¼Œä¼šç»å†ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š

1ã€Flinkéƒ½æ˜¯åŸºäºcalciteå…ˆè§£æsqlï¼Œç¡®å®šè¡¨æ¥æºäºhiveï¼Œå¦‚æœæ˜¯Hiveè¡¨ï¼Œå°†ä¼š**åœ¨HiveCatalogä¸­åˆ›å»ºHiveTableFactory**

2ã€HiveTableFactory ä¼šåŸºäºé…ç½®æ–‡ä»¶**åˆ›å»º HiveTableSource**ï¼Œç„¶åHiveTableSourceåœ¨çœŸæ­£æ‰§è¡Œæ—¶ï¼Œä¼šè°ƒç”¨getDataStreamæ–¹æ³•ï¼Œé€šè¿‡getDataStreamæ–¹æ³•æ¥ç¡®å®šæŸ¥è¯¢åŒ¹é…çš„åˆ†åŒºä¿¡æ¯ï¼Œç„¶ååˆ›å»ºè¡¨å¯¹åº”çš„InputFormatï¼Œç„¶åç¡®å®šå¹¶è¡Œåº¦ï¼Œæ ¹æ®å¹¶è¡Œåº¦ç¡®å®šslot åˆ†å‘HiveMapredSplitReaderä»»åŠ¡ã€‚

3ã€åœ¨TaskManagerç«¯çš„slotä¸­ï¼ŒSplitä¼šç¡®å®šè¯»å–çš„å†…å®¹ï¼ŒåŸºäºHiveä¸­å®šä¹‰çš„åºåˆ—åŒ–å·¥å…·ï¼ŒInputFormatæ‰§è¡Œè¯»å–ååºåˆ—åŒ–ï¼Œå¾—åˆ°valueå€¼ã€‚

4ã€æœ€åå¾ªç¯æ‰§è¡Œreader.next è·å–valueï¼Œå°†å…¶è§£ææˆRowã€‚

> 95ã€Flink -Hiveå®æ—¶å†™æ•°æ®æ—¶ï¼Œå¦‚ä½•ä¿è¯å·²ç»å†™å…¥åˆ†åŒºçš„æ•°æ®ä½•æ—¶æ‰èƒ½å¯¹ä¸‹æ¸¸å¯è§å‘¢ï¼Ÿ

**å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š**

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_aa09c822-1257-11ec-948d-00163e068ecd.png)



é¦–å…ˆå¯ä»¥çœ‹ä¸€ä¸‹ï¼Œåœ¨å®æ—¶çš„å°†æ•°æ®å­˜å‚¨åˆ°Hiveæ•°ä»“ä¸­ï¼ŒFileSystemConnector ä¸ºäº†ä¸ Flink-Hiveé›†æˆçš„å¤§ç¯å¢ƒé€‚é…ï¼Œ**æœ€å¤§çš„æ”¹å˜å°±æ˜¯åˆ†åŒºæäº¤**ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹å·¦ä¸‹å›¾ï¼Œå®˜æ–¹æ–‡æ¡£ç»™å‡ºçš„ï¼Œåˆ†åŒºå¯ä»¥é‡‡å–æ—¥æœŸ+ å°æ—¶çš„ç­–ç•¥ï¼Œæˆ–è€…æ—¶åˆ†ç§’çš„ç­–ç•¥ã€‚

**é‚£å¦‚ä½•ä¿è¯å·²ç»å†™å…¥åˆ†åŒºçš„æ•°æ®ä½•æ—¶æ‰èƒ½å¯¹ä¸‹æ¸¸å¯è§å‘¢ï¼Ÿ** è¿™å°±å’Œ **è§¦å‘æœºåˆ¶** æœ‰å…³ï¼Œ è§¦å‘æœºåˆ¶åŒ…å«process-timeå’Œ partition-timeä»¥åŠæ—¶å»¶ã€‚

**partition-time** æŒ‡çš„æ˜¯æ ¹æ®äº‹ä»¶æ—¶é—´ä¸­æå–çš„åˆ†åŒºè§¦å‘ã€‚å½“'watermark' > 'partition-time' + 'delay' ï¼Œé€‰æ‹©partition-timeçš„æ•°æ®æ‰èƒ½æäº¤æˆåŠŸï¼Œ

**process-time** æŒ‡æ ¹æ®ç³»ç»Ÿå¤„ç†æ—¶é—´è§¦å‘ï¼Œå½“åŠ ä¸Šæ—¶å»¶åï¼Œè¦æƒ³è®©åˆ†åŒºè¿›è¡Œæäº¤ï¼Œå½“'currentprocessing time' > 'partition creation time' + 'delay' é€‰æ‹© process-timeçš„æ•°æ®å¯ä»¥æäº¤æˆåŠŸã€‚

ä½†é€‰æ‹©process-timeè§¦å‘æœºåˆ¶ä¼šæœ‰ç¼ºé™·ï¼Œå°±æ˜¯å½“æ•°æ®è¿Ÿåˆ°æˆ–è€…ç¨‹åºå¤±è´¥é‡å¯æ—¶ï¼Œæ•°æ®ä¸èƒ½æŒ‰ç…§äº‹ä»¶æ—¶é—´è¢«å½’å…¥æ­£ç¡®åˆ†åŒºã€‚æ‰€ä»¥ ä¸€èˆ¬ä¼šé€‰æ‹© partition-timeã€‚

> 96ã€æºç ä¸­åˆ†åŒºæäº¤çš„PartitionCommitTriggerä»‹ç»ä¸€ä¸‹ï¼Ÿ

**åœ¨æºç ä¸­ï¼ŒPartitionCommitTriggerç±»å›¾å¦‚ä¸‹æ‰€ç¤º**

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_aa2c33b2-1257-11ec-948d-00163e068ecd.png)

è¯¥ç±»ä¸­ç»´æŠ¤äº†ä¸¤å¯¹å¿…è¦çš„ä¿¡æ¯ï¼š

1.pendingPartitions/pendingPartitionsStateï¼šç­‰å¾…æäº¤çš„åˆ†åŒºä»¥åŠå¯¹åº”çš„çŠ¶æ€ï¼›2.watermarks/watermarksStateï¼šwatermarksï¼ˆç”¨ TreeMap å­˜å‚¨ä»¥ä¿è¯æœ‰åºï¼‰ä»¥åŠå¯¹åº”çš„çŠ¶æ€ã€‚

> 97ã€PartitionTimeCommitTigger æ˜¯å¦‚ä½•çŸ¥é“è¯¥æäº¤å“ªäº›åˆ†åŒºçš„å‘¢ï¼Ÿï¼ˆæºç åˆ†æï¼‰

1ã€æ£€æŸ¥checkpoint ID æ˜¯å¦åˆæ³•ï¼›

2ã€å–å‡ºå½“å‰checkpoint ID å¯¹åº”çš„æ°´å°ï¼Œå¹¶è°ƒç”¨ TreeMapçš„headMap() å’Œ clear() æ–¹æ³•åˆ æ‰æ—©äºå½“å‰ checkpoint IDçš„æ°´å°æ•°æ®ï¼ˆæ²¡ç”¨äº†ï¼‰ï¼›

3ã€éå†ç­‰å¾…æäº¤çš„åˆ†åŒºï¼Œè°ƒç”¨ä¹‹å‰å®šä¹‰çš„PartitionTimeExtractorã€‚

ï¼ˆæ¯”å¦‚${year}-${month}-${day} ${hour}:00:00ï¼‰æŠ½å–åˆ†åŒºæ—¶é—´ã€‚

å¦‚æœwatermark>partition-time+delayï¼Œè¯´æ˜å¯ä»¥æäº¤ï¼Œå¹¶è¿”å›å®ƒä»¬

> 98ã€å¦‚ä½•ä¿è¯å·²ç»å†™å…¥åˆ†åŒºçš„æ•°æ®å¯¹ä¸‹æ¸¸å¯è§çš„æ ‡å¿—é—®é¢˜ï¼ˆæºç åˆ†æï¼‰

**åœ¨æºç ä¸­ï¼Œä¸»è¦æ¶‰åŠ****PartitionCommitPolicy****ç±»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š**

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_aa5872b0-1257-11ec-948d-00163e068ecd.png)



![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_aa79e418-1257-11ec-948d-00163e068ecd.png)



> 99ã€Flink SQL CEPæœ‰æ²¡æœ‰æ¥è§¦è¿‡ï¼Ÿ

**CEPçš„æ¦‚å¿µï¼š**

â€‹    Ã˜å¤æ‚äº‹ä»¶å¤„ç†ï¼ˆComplex Event Processingï¼‰ï¼Œç”¨äºè¯†åˆ«è¾“å…¥æµä¸­ç¬¦åˆæŒ‡å®šè§„åˆ™çš„äº‹ä»¶ï¼Œå¹¶æŒ‰ç…§æŒ‡å®šæ–¹å¼è¾“å‡ºã€‚

â€‹    Ã˜èµ·åºŠâ€”>æ´—æ¼±â€”>åƒé¥­â€”>ä¸Šç­ä¸€ç³»åˆ—ä¸²è”èµ·æ¥çš„äº‹ä»¶æµå½¢æˆçš„æ¨¡å¼

â€‹    Ã˜æµè§ˆå•†å“â€”>åŠ å…¥è´­ç‰©è½¦â€”>åˆ›å»ºè®¢å•â€”>æ”¯ä»˜å®Œæˆâ€”>å‘è´§â€”>æ”¶è´§äº‹ä»¶æµå½¢æˆçš„æ¨¡å¼ã€‚

é€šè¿‡æ¦‚å¿µå¯ä»¥äº†è§£ï¼ŒCEPä¸»è¦æ˜¯è¯†åˆ«è¾“å…¥æµä¸­ç”¨æˆ·æŒ‡å®šçš„ä¸€äº›åŸºæœ¬è§„åˆ™çš„äº‹ä»¶ï¼Œç„¶åå°†è¿™äº›äº‹ä»¶å†é€šè¿‡æŒ‡å®šæ–¹å¼è¾“å‡ºã€‚

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š æˆ‘ä»¬æŒ‡å®šâ€œæ–¹å—ã€åœ†â€ä¸ºåŸºæœ¬è§„åˆ™çš„äº‹ä»¶ï¼Œåœ¨è¾“å…¥çš„åŸå§‹æµä¸­ï¼Œå°†è¿™äº›äº‹ä»¶ä½œä¸ºä¸€ä¸ªç»“æœæµè¾“å‡ºæ¥ã€‚

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_aaa2bf50-1257-11ec-948d-00163e068ecd.png)

**CEPçš„ä½¿ç”¨åœºæ™¯ï¼š**

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_aabb9b9c-1257-11ec-948d-00163e068ecd.png)

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_aae08466-1257-11ec-948d-00163e068ecd.png)



åƒç”¨æˆ·å¼‚å¸¸æ£€æµ‹ï¼šæˆ‘ä»¬æŒ‡å®šå¼‚å¸¸æ“ä½œäº‹ä»¶ä¸ºè¦è¾“å‡ºçš„ç»“æœæµï¼›ç­–ç•¥è¥é”€ï¼šæŒ‡å®šç¬¦åˆè¦æ±‚çš„äº‹ä»¶ä¸ºç»“æœæµï¼›è¿ç»´ç›‘æ§ï¼šæŒ‡å®šä¸€å®šèŒƒå›´çš„æŒ‡æ ‡ä¸ºç»“æœæµï¼›é“¶è¡Œå¡ç›—åˆ·ï¼šæŒ‡å®šåŒä¸€æ—¶åˆ»åœ¨ä¸¤ä¸ªåœ°æ–¹è¢«åˆ·ä¸¤æ¬¡ä¸ºå¼‚å¸¸ç»“æœæµã€‚

**Flink CEP SQL è¯­æ³• æ˜¯é€šè¿‡SQLæ–¹å¼è¿›è¡Œå¤æ‚äº‹ä»¶å¤„ç†ï¼Œä½†æ˜¯ä¸** Flink SQLè¯­æ³•ä¹Ÿä¸å¤ªç›¸åŒï¼Œå…¶ä¸­åŒ…å«è®¸å¤šè§„åˆ™ã€‚

> 100ã€Flink SQL CEPäº†è§£çš„å‚æ•°ä»‹ç»ä¸€ä¸‹ï¼Ÿ

**CEPåŒ…å«çš„å‚æ•°å¦‚ä¸‹ï¼š**

**![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_ab085306-1257-11ec-948d-00163e068ecd.png)**

**å‚æ•°ä»‹ç»**

p**è¾“å‡ºæ¨¡å¼ï¼ˆ**æ¯ä¸ªæ‰¾åˆ°çš„åŒ¹é…é¡¹åº”è¯¥è¾“å‡ºå¤šå°‘è¡Œï¼‰

   Ã˜one row per match

â€‹        æ¯æ¬¡æ£€æµ‹åˆ°å®Œæ•´çš„åŒ¹é…åè¿›è¡Œæ±‡æ€»è¾“å‡º

   Ã˜all rows per match (flinkæš‚ä¸æ”¯æŒ)

â€‹        æ£€æµ‹åˆ°å®Œæ•´çš„åŒ¹é…åä¼šæŠŠåŒ¹é…è¿‡ç¨‹ä¸­æ¯æ¡å…·ä½“è®°å½•è¿›è¡Œè¾“å‡º

p**runningVS finalè¯­ä¹‰**

â€‹    Ã˜åœ¨è®¡ç®—ä¸­ä½¿ç”¨é‚£äº›åŒ¹é…çš„äº‹ä»¶

â€‹        runningåŒ¹é…ä¸­å’ŒfinalåŒ¹é…ç»“æŸ

â€‹    Ã˜ defineè¯­å¥ä¸­åªå¯ä»¥ä½¿ç”¨running,measureä¸¤è€…éƒ½å¯ä»¥

â€‹    Ã˜è¾“å‡ºç»“æœåŒºåˆ«

â€‹        å¯¹äºone row per matchï¼Œè¾“å‡ºæ²¡åŒºåˆ«

â€‹        å¯¹äºall rows per match ï¼Œè¾“å‡ºä¸åŒ

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_ab267aac-1257-11ec-948d-00163e068ecd.png)

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_ab42b442-1257-11ec-948d-00163e068ecd.png)![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_ab62a068-1257-11ec-948d-00163e068ecd.png)![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_ab8545fa-1257-11ec-948d-00163e068ecd.png)

**3ã€åŒ¹é…åè·³è½¬æ¨¡å¼ä»‹ç»**

after matchï¼ˆåŒ¹é…åï¼Œä»å“ªé‡Œå¼€å§‹é‡æ–°åŒ¹é…ï¼‰

â€‹    Ã˜ skip to next row

â€‹       ä»åŒ¹é…æˆåŠŸçš„äº‹ä»¶åºåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªäº‹ä»¶çš„ä¸‹ä¸€ä¸ªäº‹ä»¶å¼€å§‹è¿›è¡Œä¸‹ä¸€æ¬¡åŒ¹é…

â€‹    Ã˜ skip past last row

â€‹       ä»åŒ¹é…æˆåŠŸçš„äº‹ä»¶åºåˆ—ä¸­çš„æœ€åä¸€ä¸ªäº‹ä»¶çš„ä¸‹ä¸€ä¸ªäº‹ä»¶å¼€å§‹è¿›è¡Œä¸‹ä¸€æ¬¡åŒ¹é…

â€‹    Ã˜ skip to first pattern Item 

â€‹       ä»åŒ¹é…æˆåŠŸçš„äº‹ä»¶åºåˆ—ä¸­ç¬¬ä¸€ä¸ªå¯¹åº”äºpatternItemçš„äº‹ä»¶å¼€å§‹è¿›è¡Œä¸‹ä¸€æ¬¡åŒ¹é…   

â€‹    Ã˜skip to last pattern Item

â€‹       ä»åŒ¹é…æˆåŠŸçš„äº‹ä»¶åºåˆ—ä¸­æœ€åä¸€ä¸ªå¯¹åº”äºpatternItemçš„äº‹ä»¶å¼€å§‹è¿›è¡Œä¸‹ä¸€æ¬¡åŒ¹é…

æ³¨æ„ï¼š

â€‹    åœ¨ä½¿ç”¨skip to first/last patternItemå®¹æ˜“å‡ºç°å¾ªç¯åŒ¹é…é—®é¢˜ï¼Œéœ€è¦æ…é‡

é’ˆå¯¹ä¸Šé¢çš„åŒ¹é…åè·³è½¬æ¨¡å¼åˆ†åˆ«ä»‹ç»:

**ï¼ˆ1ï¼‰after match  skip past last row å¦‚ä¸‹å›¾**

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_ab9ea20c-1257-11ec-948d-00163e068ecd.png)

**ï¼ˆ2ï¼‰after match  skip to next row \**å¦‚ä¸‹å›¾\****

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_abc2427a-1257-11ec-948d-00163e068ecd.png)

**ï¼ˆ3ï¼‰after match  skip to last patternItem \**å¦‚ä¸‹å›¾\****

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_abe61574-1257-11ec-948d-00163e068ecd.png)

**ï¼ˆ4ï¼‰after match  skip to first patternItem \**å¦‚ä¸‹å›¾\****

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_ac0c4aaa-1257-11ec-948d-00163e068ecd.png)

> 101ã€ç¼–å†™ä¸€ä¸ªCEP SQLæ¡ˆä¾‹ï¼Œå¦‚é“¶è¡Œå¡ç›—åˆ·

é€šè¿‡Flink CEP SQL å†™çš„å…³äºé‡‘èåœºæ™¯ é“¶è¡Œå¡ç›—åˆ·æ¡ˆä¾‹ã€‚

æ¡ˆä¾‹ä»‹ç»ï¼šåœ¨é‡‘èåœºæ™¯ä¸­ï¼Œæœ‰æ—¶ä¼šå‡ºç°é“¶è¡Œå¡ç›—åˆ·ç°è±¡ï¼ŒçŠ¯ç½ªåˆ†å­åˆ©ç”¨äº’è”ç½‘ç­‰æŠ€æœ¯ï¼Œåœ¨é—´éš”10åˆ†é’Ÿæˆ–è€…æ›´çŸ­æ—¶é—´å†…ï¼Œä½¿ä¸€å¼ é“¶è¡Œå¡åœ¨ä¸åŒçš„ä¸¤ä¸ªåœ°æ–¹å‡ºç°å¤šæ¬¡åˆ·å¡è®°å½•ï¼Œè¿™ä»å¸¸è§„æ“ä½œæ¥è¯´ï¼Œåœ¨é—´éš”æ—¶é—´å¾ˆå¤šçš„æƒ…å†µä¸‹ï¼Œç”¨æˆ·æ˜¯æ— æ³•åŒæ—¶åœ¨ä¸¤ä¸ªåŸå¸‚è¿›è¡Œåˆ·å¡äº¤æ˜“çš„ï¼Œæ‰€ä»¥å‡ºç°è¿™ç§é—®é¢˜ï¼Œå°±éœ€è¦åå°åšå‡ºè§¦å‘æŠ¥è­¦æœºåˆ¶ã€‚

è¦æ±‚ï¼šå½“ç›¸åŒçš„cardIdåœ¨ååˆ†é’Ÿå†…ï¼Œä»ä¸¤ä¸ªä¸åŒçš„Locationå‘ç”Ÿåˆ·å¡ç°è±¡ï¼Œè§¦å‘æŠ¥è­¦æœºåˆ¶ï¼Œä»¥ä¾¿æ£€æµ‹ä¿¡ç”¨å¡ç›—åˆ·ç°è±¡ã€‚

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_ac2759d0-1257-11ec-948d-00163e068ecd.png)

ï¼ˆ1ï¼‰ç¼–å†™cep sqlæ—¶ï¼ŒåŒ…å«è®¸å¤šæŠ€å·§ï¼Œé¦–å…ˆæˆ‘ä»¬ç¼–å†™æœ€åŸºç¡€çš„æŸ¥è¯¢è¯­å¥,ä»ä¸€å¼ è¡¨ä¸­æŸ¥è¯¢éœ€è¦çš„å­—æ®µã€‚



```
select starttime,endtime,cardId,event from dataStream
```

ï¼ˆ2ï¼‰match_recognize();

è¯¥å­—æ®µæ˜¯CEP SQL çš„å‰ææ¡ä»¶ï¼Œç”¨äºç”Ÿæˆä¸€ä¸ªè¿½åŠ è¡¨ï¼Œæ‰€æœ‰çš„ CEP SQLéƒ½æ˜¯ä¹¦å†™åœ¨è¿™é‡Œé¢ã€‚

ï¼ˆ3ï¼‰åˆ†åŒºï¼Œæ’åº

ç”±äºæ˜¯å¯¹åŒä¸€IDï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨ partition by,è¿˜è¦æ ¹æ®æ—¶é—´è¿›è¡Œæ’åº order by

ï¼ˆ4ï¼‰ç†è§£CEP SQLæ ¸å¿ƒçš„ç¼–å†™é¡ºåº



å¦‚ä¸Šå›¾æ ‡çš„é¡ºåº

1ã€CEP SQL çš„ç±»ä¸ºPatternï¼Œæ£€æµ‹åœ¨10åˆ†é’Ÿå†…ä¸¤ä¸ªåœ°æ–¹å‡ºç°åˆ·å¡ç°è±¡ï¼Œæ‰€ä»¥å®šä¹‰ä¸¤ä¸ªäº‹ä»¶ï¼š

Pattern (e1 e2+) within interval â€˜10â€™minute

2ã€å®šä¹‰åœ¨Patternä¸­è¦æ±‚çš„åˆ¤æ–­è¯­å¥ï¼Œè§„å®šä½¿ç”¨define

define

â€‹    e1 as a1.action = ''

   e2 as e2.action = '' and e2.location <> e1.location

3ã€æ ¹æ®ä¸Šè¿°çš„è¾“å…¥æ¡ä»¶æ„å»ºè¾“å‡ºæ¡ä»¶ï¼Œè§„å®šä½¿ç”¨ measures

measures

â€‹    e2.action as event

â€‹    e1.timestamp as starttime

â€‹    last(e2.timestamp) as endtime

4ã€è¾“å‡ºæ¡ä»¶åŒ¹é…æˆåŠŸï¼Œè¾“å‡ºä¸€æ¡ï¼Œè§„å®šå†™æ³•(è¿™å—æ ¹æ®ä¸åŒçš„è§„åˆ™å†™ä¸åŒçš„è¯­å¥)

one row per match

5ã€åŒ¹é…åè·³è½¬è·³è½¬åˆ°ä¸‹ä¸€è¡Œï¼ˆæ ¹æ®ä¸åŒè§„åˆ™å†™ä¸åŒè¯­å¥ï¼‰

after match skip to next row

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_ac55a8da-1257-11ec-948d-00163e068ecd.png)

æ ¹æ®æ ¸å¿ƒç¼–å†™é¡ºåºè¿›è¡Œç†è§£ï¼Œç„¶ååœ¨æŒ‰ç…§ä¹¦å†™æ­£ç¡®çš„é¡ºåºè¿›è¡Œç¼–å†™ã€‚

> 102ã€Flink CDCäº†è§£å—ï¼Ÿä»€ä¹ˆæ˜¯ Flink SQL CDC Connectorsï¼Ÿ

**åœ¨ Flink 1.11 å¼•å…¥äº† CDC æœºåˆ¶**ï¼ŒCDC çš„å…¨ç§°æ˜¯ **Change Data Capture**ï¼Œç”¨äºæ•æ‰æ•°æ®åº“è¡¨çš„å¢åˆ æ”¹æŸ¥æ“ä½œï¼Œæ˜¯ç›®å‰éå¸¸æˆç†Ÿçš„åŒæ­¥æ•°æ®åº“å˜æ›´æ–¹æ¡ˆã€‚

Flink CDC Connectors æ˜¯ Apache Flink çš„ä¸€ç»„æºè¿æ¥å™¨ï¼Œæ˜¯å¯ä»¥ä» MySQLã€PostgreSQL æ•°æ®ç›´æ¥è¯»å–å…¨é‡æ•°æ®å’Œå¢é‡æ•°æ®çš„ Source Connectorsï¼Œå¼€æºåœ°å€ï¼šhttps://github.com/ververica/flink-cdc-connectorsã€‚

ç›®å‰(1.13ç‰ˆæœ¬)æ”¯æŒçš„ Connectors å¦‚ä¸‹ï¼š   

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_ac864b70-1257-11ec-948d-00163e068ecd.png)

å¦å¤–**æ”¯æŒè§£æ Kafka ä¸­ debezium-json å’Œ canal-json æ ¼å¼çš„ Change Log**ï¼Œé€šè¿‡Flink è¿›è¡Œè®¡ç®—æˆ–è€…ç›´æ¥å†™å…¥åˆ°å…¶ä»–å¤–éƒ¨æ•°æ®å­˜å‚¨ç³»ç»Ÿ(æ¯”å¦‚ Elasticsearch)ï¼Œæˆ–è€…å°† Changelog Json æ ¼å¼çš„ Flink æ•°æ®å†™å…¥åˆ° Kafka:

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_aca24abe-1257-11ec-948d-00163e068ecd.png)

Flink CDC Connectors å’Œ Flink ä¹‹é—´çš„ç‰ˆæœ¬æ˜ å°„:

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_acb82b90-1257-11ec-948d-00163e068ecd.png)

> 103ã€Flink CDCåŸç†ä»‹ç»ä¸€ä¸‹

åœ¨æœ€æ–°CDC è°ƒç ”æŠ¥å‘Šä¸­ï¼Œ**Debezium** å’Œ **Canal** æ˜¯ç›®å‰æœ€æµè¡Œä½¿ç”¨çš„ CDC å·¥å…·ï¼Œè¿™äº› CDC å·¥å…·çš„æ ¸å¿ƒåŸç†æ˜¯æŠ½å–æ•°æ®åº“æ—¥å¿—è·å–å˜æ›´ã€‚åœ¨ç»è¿‡ä¸€ç³»åˆ—è°ƒç ”åï¼Œç›®å‰Debezium (æ”¯æŒå…¨é‡ã€å¢é‡åŒæ­¥ï¼ŒåŒæ—¶æ”¯æŒ MySQLã€PostgreSQLã€Oracle ç­‰æ•°æ®åº“)ï¼Œä½¿ç”¨è¾ƒä¸ºå¹¿æ³›ã€‚

Flink SQL CDC å†…ç½®äº† **Debezium** å¼•æ“ï¼Œåˆ©ç”¨å…¶æŠ½å–æ—¥å¿—è·å–å˜æ›´çš„èƒ½åŠ›ï¼Œå°† changelog è½¬æ¢ä¸º Flink SQL è®¤è¯†çš„ RowData æ•°æ®ã€‚ï¼ˆä»¥ä¸‹å³ä¾§æ˜¯ Debezium çš„æ•°æ®æ ¼å¼ï¼Œå·¦ä¾§æ˜¯ Flink çš„ **RowData æ•°æ®æ ¼å¼**ï¼‰ã€‚

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_acd8468c-1257-11ec-948d-00163e068ecd.png)

RowData ä»£è¡¨äº†ä¸€è¡Œçš„æ•°æ®ï¼Œåœ¨ RowData ä¸Šé¢ä¼šæœ‰ä¸€ä¸ªå…ƒæ•°æ®çš„ä¿¡æ¯ **RowKind**ï¼ŒRowKind é‡Œé¢åŒ…æ‹¬äº†æ’å…¥(+I)ã€æ›´æ–°å‰(-U)ã€æ›´æ–°å(+U)ã€åˆ é™¤(-D)ï¼Œè¿™æ ·å’Œæ•°æ®åº“é‡Œé¢çš„ binlog æ¦‚å¿µååˆ†ç±»ä¼¼ã€‚é€šè¿‡ Debezium é‡‡é›†çš„æ•°æ®ï¼ŒåŒ…å«äº†æ—§æ•°æ®(before)å’Œæ–°æ•°æ®è¡Œ(after)ä»¥åŠåŸæ•°æ®ä¿¡æ¯(source)ï¼Œop çš„ u è¡¨ç¤ºæ˜¯ update æ›´æ–°æ“ä½œæ ‡è¯†ç¬¦ï¼ˆop å­—æ®µçš„å€¼ cï¼Œuï¼Œdï¼Œr åˆ†åˆ«å¯¹åº” createï¼Œupdateï¼Œdeleteï¼Œreadeï¼‰ï¼Œts_ms è¡¨ç¤ºåŒæ­¥çš„æ—¶é—´æˆ³ã€‚

> 104ã€é€šè¿‡CDCè®¾è®¡ä¸€ç§Flink SQL é‡‡é›†+è®¡ç®—+ä¼ è¾“(ETL)ä¸€ä½“åŒ–çš„å®æ—¶æ•°ä»“

è®¾è®¡å›¾å¦‚ä¸‹ï¼š

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_acfc16e8-1257-11ec-948d-00163e068ecd.png)

**é€šè¿‡ Flink CDC connectors æ›¿æ¢ Debezium+Kafka çš„æ•°æ®é‡‡é›†æ¨¡å—**ï¼Œ**å®ç°** **Flink SQL é‡‡é›†+è®¡ç®—+ä¼ è¾“(ETL)ä¸€ä½“åŒ–**ï¼Œä»¥Mysqlä¸ºSourceæºï¼ŒFlink CDCä¸­é—´ä»¶ä¸ºæ’ä»¶ï¼ŒESæˆ–è€…Kafkaï¼Œæˆ–è€…å…¶ä»–ä¸ºSinkï¼Œè¿™æ ·è®¾è®¡çš„ä¼˜ç‚¹å¦‚ä¸‹ï¼š

- å¼€ç®±å³ç”¨ï¼Œç®€å•æ˜“ä¸Šæ‰‹
- å‡å°‘ç»´æŠ¤çš„ç»„ä»¶ï¼Œç®€åŒ–å®æ—¶é“¾è·¯ï¼Œå‡è½»éƒ¨ç½²æˆæœ¬
- å‡å°ç«¯åˆ°ç«¯å»¶è¿Ÿ
- Flink è‡ªèº«æ”¯æŒ Exactly Once çš„è¯»å–å’Œè®¡ç®—
- æ•°æ®ä¸è½åœ°ï¼Œå‡å°‘å­˜å‚¨æˆæœ¬
- æ”¯æŒå…¨é‡å’Œå¢é‡æµå¼è¯»å–
- binlog é‡‡é›†ä½ç‚¹å¯å›æº¯

> 105ã€Flink SQL CDCå¦‚ä½•å®ç°ä¸€è‡´æ€§ä¿éšœï¼ˆæºç åˆ†æï¼‰

Flink SQL CDC ç”¨äºè·å–æ•°æ®åº“å˜æ›´æ—¥å¿—çš„ Source å‡½æ•°æ˜¯ **DebeziumSourceFunction**ï¼Œä¸”æœ€ç»ˆè¿”å›çš„ç±»å‹æ˜¯ **RowData**ï¼Œè¯¥å‡½æ•°å®ç°äº† CheckpointedFunctionï¼Œå³é€šè¿‡ Checkpoint æœºåˆ¶æ¥ä¿è¯å‘ç”Ÿ failure æ—¶ä¸ä¼šä¸¢æ•°ï¼Œå®ç° exactly once è¯­ä¹‰ï¼Œè¿™éƒ¨åˆ†åœ¨å‡½æ•°çš„æ³¨é‡Šä¸­æœ‰æ˜ç¡®çš„è§£é‡Šã€‚



```
/**
 * The {@link DebeziumSourceFunction} is a streaming data source that pulls captured change data
 * from databases into Flink.
 * é€šè¿‡Checkpointæœºåˆ¶æ¥ä¿è¯å‘ç”Ÿfailureæ—¶ä¸ä¼šä¸¢æ•°ï¼Œå®ç°exactly onceè¯­ä¹‰
 * <p>The source function participates in checkpointing and guarantees that no data is lost
 * during a failure, and that the computation processes elements "exactly once".
 * æ³¨æ„ï¼šè¿™ä¸ªSource Functionä¸èƒ½åŒæ—¶è¿è¡Œå¤šä¸ªå®ä¾‹
 * <p>Note: currently, the source function can't run in multiple parallel instances.
 *
 * <p>Please refer to Debezium's documentation for the available configuration properties:
 * https://debezium.io/documentation/reference/1.2/development/engine.html#engine-properties</p>
 */
@PublicEvolving
public class DebeziumSourceFunction<T> extends RichSourceFunction<T> implements
CheckpointedFunction,
ResultTypeQueryable<T> {}
```

**ä¸ºå®ç° CheckpointedFunctionï¼Œéœ€è¦å®ç°ä»¥ä¸‹ä¸¤ä¸ªæ–¹æ³•ï¼š**



```
public interface CheckpointedFunction {
//åšå¿«ç…§ï¼ŒæŠŠå†…å­˜ä¸­çš„æ•°æ®ä¿å­˜åœ¨checkpointçŠ¶æ€ä¸­
void snapshotState(FunctionSnapshotContext var1) throws Exception;


//ç¨‹åºå¼‚å¸¸æ¢å¤åä»checkpointçŠ¶æ€ä¸­æ¢å¤æ•°æ®
void initializeState(FunctionInitializationContext var1) throws Exception;
}
```

**æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ DebeziumSourceFunction ä¸­éƒ½è®°å½•äº†å“ªäº›çŠ¶æ€ã€‚**



```
/** Accessor for state in the operator state backend. 
    offsetStateä¸­è®°å½•äº†è¯»å–çš„binlogæ–‡ä»¶å’Œä½ç§»ä¿¡æ¯ç­‰ï¼Œå¯¹åº”Debeziumä¸­çš„
*/
private transient ListState<byte[]> offsetState;


/**
 * State to store the history records, i.e. schema changes.
 * historyRecordsStateè®°å½•äº†schemaçš„å˜åŒ–ç­‰ä¿¡æ¯
 * @see FlinkDatabaseHistory
*/
private transient ListState<String> historyRecordsState;
```

æˆ‘ä»¬å‘ç°åœ¨ Flink SQL CDC æ˜¯ä¸€ä¸ªç›¸å¯¹ç®€æ˜“çš„åœºæ™¯ï¼Œæ²¡æœ‰ä¸­é—´ç®—å­ï¼Œæ˜¯é€šè¿‡ Checkpoint æŒä¹…åŒ– binglog æ¶ˆè´¹ä½ç§»å’Œ schema å˜åŒ–ä¿¡æ¯çš„å¿«ç…§ï¼Œæ¥å®ç° Exactly Onceã€‚

> 106ã€Flink SQL GateWayäº†è§£å—ï¼Ÿ

**Flink SQL GateWayçš„æ¦‚å¿µï¼š**

FlinkSql Gatewayæ˜¯Flinké›†ç¾¤çš„â€œä»»åŠ¡ç½‘å…³â€ï¼Œæ”¯æŒä»¥restapi çš„å½¢å¼æäº¤æŸ¥è¯¢ã€æ’å…¥ã€åˆ é™¤ç­‰ä»»åŠ¡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š



![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_ad207182-1257-11ec-948d-00163e068ecd.png)



æ€»ä½“æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_ad3e8514-1257-11ec-948d-00163e068ecd.png)



> 107ã€Flink SQL GateWayåˆ›å»ºä¼šè¯è®²è§£ä¸€ä¸‹ï¼Ÿ

**åˆ›å»ºä¼šè¯æµç¨‹å›¾å¦‚ä¸‹ï¼š
**

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20210911_ad695564-1257-11ec-948d-00163e068ecd.png)



ï¼ˆ1ï¼‰ä¼ å…¥å‚æ•°åŒ…å«nameåç§°ã€planneræ‰§è¡Œå¼•æ“ï¼ˆBlinkæˆ–åŸç”Ÿçš„flinkï¼‰ã€executetypeï¼ˆstreamingæˆ–è€…batchï¼‰ã€propertiesï¼ˆé…ç½®å‚æ•°ï¼Œå¦‚å¹¶å‘åº¦ç­‰ï¼‰ï¼›

ï¼ˆ2ï¼‰åœ¨SessionMnagerä¸­ï¼Œä¼šæ ¹æ®è¿™äº›å‚æ•°åˆ›å»ºå¯¹åº”çš„SessionContextï¼›

 SessionContext sessionContext= new SessionContext(sessionName, sessionId, sessionEnv, defaultContext);

ï¼ˆ3ï¼‰å°†åˆ›å»ºSessionæ”¾å…¥Mapé›†åˆä¸­ï¼Œæœ€åè¿”å›å¯¹åº”çš„SessionIdï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨ã€‚

  sessions.put(sessionId,session); return sessionId;

> 108ã€Flink SQL GateWayå¦‚ä½•å¤„ç†å¹¶å‘è¯·æ±‚ï¼Ÿå¤šä¸ªæäº¤æ€ä¹ˆå¤„ç†ï¼Ÿ 

   sql gatewayå†…éƒ¨ç»´æŠ¤SessionManagerï¼Œé‡Œé¢é€šè¿‡Mapç»´æŠ¤äº†å„ä¸ªSessionï¼Œæ¯ä¸ªSessionçš„ä»»åŠ¡æ‰§è¡Œæ˜¯ç‹¬ç«‹çš„ã€‚åŒä¸€ä¸ªSessioné€šè¿‡ExecuteContextå†…éƒ¨çš„tEnvæŒ‰é¡ºåºæäº¤ã€‚

> 109ã€å¦‚ä½•ç»´æŠ¤å¤šä¸ªSQLä¹‹é—´çš„å…³è”æ€§ï¼Ÿ 

   åœ¨æ¯ä¸ªSessionä¸­å•ç‹¬ç»´æŠ¤äº†tEnvï¼ŒåŒä¸€ä¸ªsessionä¸­çš„æ“ä½œå…¶å®æ˜¯åœ¨ä¸€ä¸ªenvä¸­æ‰§è¡Œçš„ã€‚å› æ­¤åªè¦æ˜¯åŒä¸€ä¸ªsessionä¸­çš„ä»»åŠ¡ï¼Œå†…éƒ¨ä½¿ç”¨çš„tEnvå°±æ˜¯åŒä¸€ä¸ªã€‚è¿™æ ·å°±å¯ä»¥å®ç°åœ¨Asessionä¸­ï¼Œå…ˆåˆ›å»ºä¸€ä¸ªviewï¼Œç„¶åæ‰§è¡Œä¸€ä¸ªselectï¼Œæœ€åæ‰§è¡Œä¸€ä¸ªinsertã€‚

> 110ã€sqlå­—ç¬¦ä¸²å¦‚ä½•æäº¤åˆ°é›†ç¾¤æˆä¸ºä»£ç ï¼Ÿ

â€‹    **Session**ä¸­ç»´æŠ¤äº†tenvï¼Œsqlä¼šé€šè¿‡tenvç¼–è¯‘ç”Ÿæˆ**pipeline**ï¼ˆå³DAGå›¾ï¼‰ï¼Œåœ¨batchæ¨¡å¼ä¸‹æ˜¯Planæ‰§è¡Œè®¡åˆ’ï¼›åœ¨streamæ¨¡å¼ä¸‹æ˜¯**StreamGraph**ã€‚ç„¶åSessionå†…éƒ¨ä¼šåˆ›å»ºä¸€ä¸ªProgramDeployerä»£ç å‘å¸ƒå™¨ï¼Œæ ¹æ®Flinkä¸­é…ç½®çš„targetåˆ›å»ºä¸åŒçš„excutorã€‚æœ€åè°ƒç”¨executor.executeæ–¹æ³•æäº¤Pipelineå’Œconfigæ‰§è¡Œã€‚